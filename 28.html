<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆∞·ªùng ƒëua F1 - Tu·∫ßn 28</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --f1-red: #e10600; --f1-black: #15151e; --f1-silver: #f3f3f3; --success: #2ecc71; --warning: #f1c40f; }
        body { font-family: 'Lexend', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; background: var(--f1-black); color: white; user-select: none; }
        .game-container { max-width: 750px; width: 100%; background: #2b2b3b; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); border-left: 8px solid var(--f1-red); position: relative; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 40px; border-radius: 5px; font-weight: bold; font-size: 1.2rem; z-index: 1000; transition: 0.3s; opacity: 0; pointer-events: none; border: 2px solid white; }
        .toast-show { opacity: 1 !important; top: 50px !important; }
        .screen { background: var(--f1-silver); border-radius: 5px; padding: 20px; margin-bottom: 25px; color: #15151e; border: 3px solid #38383f; min-height: 140px; }
        .screen-header { display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: bold; border-bottom: 2px solid #ccc; padding-bottom: 8px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .q-text { font-size: 1.1rem; font-weight: 600; line-height: 1.5; }
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; font-size: 0.9rem; color: var(--f1-red); }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .opt-btn { background: #38383f; border: none; padding: 15px; border-radius: 4px; font-family: 'Lexend'; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.95rem; color: white; border-bottom: 4px solid #111; }
        .opt-btn:hover { background: var(--f1-red); transform: scale(1.02); }
        .input-area { display: flex; flex-direction: column; gap: 15px; }
        .ans-input { padding: 18px; border-radius: 4px; border: 2px solid var(--f1-red); font-size: 1.2rem; font-family: 'Lexend'; text-align: center; background: #15151e; color: white; }
        .hidden { display: none; }
        .action-btn { background: var(--f1-red); color: white; padding: 15px 30px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1.1rem; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="game-container">
    <div class="status-bar">
        <span id="stage-name">V√íNG 1: KH·ªûI ƒê·ªòNG</span>
        <span id="score-display">ƒêI·ªÇM: 0 / 100</span>
    </div>

    <div class="screen">
        <div class="screen-header">
            <span>F1 RACE - TU·∫¶N 28</span>
            <span id="lives-count">üèéÔ∏è PIT STOP: 3/3</span>
        </div>
        <div id="q-content" class="q-text">ƒêang ki·ªÉm tra ƒë·ªông c∆°...</div>
    </div>

    <div id="play-area"></div>

    <div id="result-screen" class="hidden" style="text-align: center;">
        <h2 id="res-title">üèÅ K·∫æT TH√öC CH·∫∂NG ƒêUA</h2>
        <h1 id="final-score" style="font-size: 4.5rem; color: var(--warning); margin: 15px 0;">0 ƒêI·ªÇM</h1>
        <div id="save-form" class="hidden">
            <input type="text" id="p-name" style="width:85%; padding:15px; margin:10px; border-radius:4px; border:none;" placeholder="T√™n tay ƒëua...">
            <input type="text" id="p-class" style="width:85%; padding:15px; margin:10px; border-radius:4px; border:none;" placeholder="L·ªõp...">
            <button class="action-btn" style="width:90%;" onclick="saveData()">GHI DANH B·∫¢NG V√ÄNG</button>
        </div>
        <button class="action-btn" style="background:#555; margin-top:20px;" onclick="location.reload()">ƒêUA L·∫†I (ƒê·ªÄ M·ªöI)</button>
    </div>
</div>

<script>
    let isFinished = false;
    let score = 0;
    let stage = 1;
    let qIdx = 0;
    let lives = 3;

    // CH·ªêNG T·∫¢I L·∫†I TRANG
    window.addEventListener('beforeunload', (e) => {
        if (!isFinished) { e.preventDefault(); e.returnValue = ''; }
    });

    const firebaseConfig = {
        apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
        authDomain: "gamhoctap.firebaseapp.com",
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gamhoctap"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    // NG√ÇN H√ÄNG C√ÇU H·ªéI TU·∫¶N 28
    const POOL1 = [
        {q: "Mu·ªën t√≠nh v·∫≠n t·ªëc (v), ta th·ª±c hi·ªán ph√©p t√≠nh n√†o?", opts: ["s * t", "s : t", "t : s", "s + t"], c: 1},
        {q: "ƒê∆°n v·ªã v·∫≠n t·ªëc n√†o th∆∞·ªùng d√πng cho √¥ t√¥, m√°y bay?", opts: ["m/s", "m/ph√∫t", "km/h", "cm/s"], c: 2},
        {q: "C√¥ng th·ª©c t√≠nh qu√£ng ƒë∆∞·ªùng (s) l√† g√¨?", opts: ["s = v * t", "s = v : t", "s = t : v", "s = v + t"], c: 0},
        {q: "Khi bi·∫øt s v√† v, c√¥ng th·ª©c t√≠nh th·ªùi gian (t) l√†:", opts: ["t = s * v", "t = v : s", "t = s : v", "t = s + v"], c: 2},
        {q: "N·∫øu s t√≠nh b·∫±ng m, t t√≠nh b·∫±ng gi√¢y th√¨ ƒë∆°n v·ªã v l√†:", opts: ["km/h", "m/s", "m/h", "km/s"], c: 1},
        {q: "Kangaroo ch·∫°y 70m trong 5 gi√¢y. V·∫≠n t·ªëc l√†:", opts: ["350 m/s", "14 m/s", "14 km/h", "65 m/s"], c: 1},
        {q: "Qu√£ng ƒë∆∞·ªùng √¥ t√¥ ƒëi trong 2 gi·ªù v·ªõi v·∫≠n t·ªëc 65 km/h l√†:", opts: ["32,5 km", "130 km", "67 km", "130 m"], c: 1},
        {q: "N·∫øu s l√† km, v l√† km/h th√¨ ƒë∆°n v·ªã th·ªùi gian l√† g√¨?", opts: ["Ph√∫t", "Gi√¢y", "Gi·ªù", "Ng√†y"], c: 2}
    ];

    const POOL2 = [
        {q: "√î t√¥ ƒëi 180km trong 2 gi·ªù. V·∫≠n t·ªëc l√†:", opts: ["360 km/h", "90 km/h", "80 km/h", "90 m/s"], c: 1},
        {q: "Ng∆∞·ªùi ƒëi xe ƒë·∫°p 500m trong 1 ph√∫t 40 gi√¢y. V·∫≠n t·ªëc m/s l√†:", opts: ["5 m/s", "500 m/s", "300 m/s", "5 km/h"], c: 0},
        {q: "T√†u bi·ªÉn ƒëi v·∫≠n t·ªëc 33,7 km/h trong 4 gi·ªù ƒë∆∞·ª£c bao nhi√™u km?", opts: ["132,8 km", "134,8 m", "134,8 km", "8,4 km"], c: 2},
        {q: "VƒêV tr∆∞·ª£t tuy·∫øt ƒëi 600m v·ªõi v·∫≠n t·ªëc 24 m/s h·∫øt bao l√¢u?", opts: ["14400 gi√¢y", "25 gi√¢y", "25 ph√∫t", "14,4 gi√¢y"], c: 1},
        {q: "ƒê·ªïi v·∫≠n t·ªëc: 72 km/h = ... m/s?", opts: ["72000 m/s", "1,2 m/s", "20 m/s", "200 m/s"], c: 2},
        {q: "Chim c·∫Øt bay 108 m/s. Trong 15 gi√¢y n√≥ bay ƒë∆∞·ª£c bao nhi√™u m√©t?", opts: ["1500 m", "1620 m", "7,2 m", "1,62 km"], c: 1},
        {q: "Thuy·ªÅn ƒëi 75km v·ªõi v·∫≠n t·ªëc 30 km/h h·∫øt bao nhi√™u gi·ªù?", opts: ["1 gi·ªù", "2 gi·ªù", "2,5 gi·ªù", "0,4 gi·ªù"], c: 2},
        {q: "B√°c N√πng ƒëi 3km trong 45 ph√∫t. V·∫≠n t·ªëc km/h l√†:", opts: ["4 km/h", "15 km/h", "0,06 km/h", "4 m/s"], c: 0}
    ];

    const POOL3 = [
        {q: "T√†u ƒëi t·ª´ 6g10 ƒë·∫øn 10g40 v·ªõi v·∫≠n t·ªëc 80km/h. Qu√£ng ƒë∆∞·ªùng d√†i bao nhi√™u km?", a: "360"},
        {q: "Xe ch·∫°y 60km v·ªõi v·∫≠n t·ªëc 45km/h, ngh·ªâ 2 l·∫ßn m·ªói l·∫ßn 15p. T·ªïng th·ªùi gian chuy·∫øn ƒëi (ph√∫t) l√†:", a: "110"},
        {q: "Taxi bay v√≤ng tr√≤n b√°n k√≠nh 5km, v = 60km/h. Th·ªùi gian ho√†n th√†nh 1 v√≤ng (ph√∫t, l√†m tr√≤n) l√†:", a: "31"},
        {q: "ƒê·∫∑c c√¥ng b∆°i 2,7km trong 1 gi·ªù 30 ph√∫t. V·∫≠n t·ªëc m/s l√†:", a: "0.5"}
    ];

    // L·∫§Y ƒê·ªÄ NG·∫™U NHI√äN 50%
    let game1 = shuffle([...POOL1]).slice(0, 4);
    let game2 = shuffle([...POOL2]).slice(0, 4);
    let game3 = shuffle([...POOL3]).slice(0, 2);

    function startStage(s) {
        stage = s; qIdx = 0;
        document.getElementById('stage-name').innerText = s === 1 ? "V√íNG 1: KH·ªûI ƒê·ªòNG" : (s === 2 ? "V√íNG 2: TƒÇNG T·ªêC" : "V√íNG 3: V·ªÄ ƒê√çCH");
        if(s > 1) document.getElementById('lives-count').classList.add('hidden');
        renderQ();
    }

    function renderQ() {
        let data = stage === 1 ? game1 : (stage === 2 ? game2 : game3);
        let item = data[qIdx];
        document.getElementById('q-content').innerHTML = `<b>CH·∫∂NG ${qIdx+1}:</b> ${item.q}`;
        let html = '';
        if(stage < 3) {
            html = '<div class="options-grid">';
            item.opts.forEach((o, i) => html += `<button class="opt-btn" onclick="check(${i})">${o}</button>`);
            html += '</div>';
        } else {
            html = `<div class="input-area"><input type="text" id="ans" class="ans-input" placeholder="Nh·∫≠p s·ªë k·∫øt qu·∫£..."><button class="action-btn" onclick="checkTuluan()">NH·∫§N GA</button></div>`;
        }
        document.getElementById('play-area').innerHTML = html;
    }

    function check(idx) {
        let item = (stage === 1) ? game1[qIdx] : game2[qIdx];
        if(idx === item.c) { score += 10; showToast(true); } 
        else {
            showToast(false);
            if(stage === 1) { 
                lives--; document.getElementById('lives-count').innerText = "üèéÔ∏è PIT STOP: "+lives+"/3";
                if(lives <= 0) { setTimeout(() => startStage(2), 1200); return; }
            }
        }
        updateScore();
        setTimeout(next, 1200);
    }

    function checkTuluan() {
        let userAns = document.getElementById('ans').value.trim();
        if(userAns == game3[qIdx].a) { score += 10; showToast(true); }
        else { showToast(false); }
        updateScore();
        setTimeout(next, 1200);
    }

    function next() {
        qIdx++;
        let data = (stage === 1) ? game1 : (stage === 2 ? game2 : game3);
        if(qIdx < data.length) renderQ();
        else if(stage < 3) startStage(stage + 1);
        else finish();
    }

    function updateScore() { document.getElementById('score-display').innerText = "ƒêI·ªÇM: " + score + " / 100"; }

    function showToast(isCorrect) {
        const toast = document.getElementById('toast');
        toast.innerText = isCorrect ? "TUY·ªÜT V·ªúI! üèéÔ∏èüí®" : "QU√Å T·ªêC ƒê·ªò! ‚ö†Ô∏è";
        toast.style.background = isCorrect ? "var(--success)" : "var(--f1-red)";
        toast.classList.add('toast-show');
        setTimeout(() => { toast.classList.remove('toast-show'); }, 1000);
    }

    function finish() {
        isFinished = true;
        document.getElementById('play-area').innerHTML = '';
        document.getElementById('q-content').innerText = "üèÅ Ch√∫c m·ª´ng em ƒë√£ c√°n ƒë√≠ch!";
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = score + " ƒêI·ªÇM";
        if(score >= 50) document.getElementById('save-form').classList.remove('hidden');
    }

    function saveData() {
        const name = document.getElementById('p-name').value;
        const cls = document.getElementById('p-class').value;
        if(!name || !cls) return;
        db.ref('scores/tuan28/' + Date.now()).set({ fullName: name, className: cls, score: score, timestamp: Date.now() })
        .then(() => { alert("ƒê√£ l∆∞u k·∫øt qu·∫£!"); location.reload(); });
    }

    window.onload = () => { startStage(1); };
</script>
</body>
</html>
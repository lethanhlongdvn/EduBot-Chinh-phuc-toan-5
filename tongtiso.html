<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i 38: T√¨m hai s·ªë khi bi·∫øt T·ªïng v√† T·ªâ s·ªë</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #FF9800; --secondary: #2196F3; --bg: #fff9f0; --success: #4CAF50; }
        body { font-family: 'Lexend', sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 750px; width: 100%; background: white; padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 10px solid var(--primary); }
        
        .header-title { text-align: center; color: var(--primary); margin-bottom: 15px; height: 60px; display: flex; flex-direction: column; justify-content: center; }
        .header-title h2 { margin: 0; font-size: 1.4rem; }
        .header-title p { margin: 0; font-size: 0.85rem; color: #888; }

        .progress-bar { height: 10px; background: #eee; border-radius: 5px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.5s; }
        
        .lvl-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .lvl-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; background: #f5f5f5; font-weight: bold; font-family: 'Lexend'; color: #888; font-size: 0.85rem; pointer-events: none; }
        .lvl-btn.active { background: var(--primary); color: white; border-bottom: 3px solid #E68A00; }
        
        .question-box { background: #fdf2e9; padding: 20px; border-radius: 15px; border: 2px dashed var(--primary); margin-bottom: 20px; font-size: 1.1rem; min-height: 80px; display: flex; align-items: center; justify-content: center; text-align: center; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .opt-btn { padding: 12px; border: 2px solid #eee; border-radius: 12px; background: white; cursor: pointer; font-size: 0.95rem; font-family: 'Lexend'; transition: 0.3s; }
        .opt-btn:hover:not(:disabled) { border-color: var(--primary); background: #fff8f0; }
        
        .robot-hint { background: #e3f2fd; padding: 12px; border-radius: 12px; margin-top: 20px; display: flex; align-items: center; gap: 10px; border-left: 5px solid var(--secondary); font-size: 0.9rem; }
        .hidden { display: none; }
        .input-field { padding: 12px; border-radius: 10px; border: 2px solid #ddd; width: 85%; font-family: 'Lexend'; margin-bottom: 10px; font-size: 1rem; }
        .action-btn { padding: 12px 25px; background: var(--success); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-family: 'Lexend'; font-size: 1rem; margin-top: 10px; }
        footer { margin-top: 30px; text-align: center; font-size: 0.8rem; color: #999; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-title">
        <h2>ü§ñ TH·ª¨ TH√ÅCH T·ªîNG - T·ªà</h2>
        <p>H√†nh tr√¨nh chinh ph·ª•c B·∫£ng V√†ng</p>
    </div>

    <div class="lvl-nav">
        <button id="btn-0" class="lvl-btn active">Ch·∫∑ng 1</button>
        <button id="btn-1" class="lvl-btn">Ch·∫∑ng 2</button>
        <button id="btn-2" class="lvl-btn">Ch·∫∑ng 3</button>
    </div>

    <div class="progress-bar"><div id="fill" class="progress-fill"></div></div>

    <div id="quiz-area">
        <div class="question-box" id="q-text">ƒêang chu·∫©n b·ªã c√¢u h·ªèi...</div>
        <div class="options-grid" id="q-opts"></div>
        <div id="hint-box" class="robot-hint hidden">
            <span>ü§ñ:</span> <span id="hint-text"></span>
        </div>
    </div>

    <div id="next-lvl-screen" class="hidden" style="text-align: center; padding: 20px;">
        <h2 id="lvl-msg">Tuy·ªát v·ªùi! üéâ</h2>
        <p id="lvl-score-info" style="font-size: 1.2rem;"></p>
        <button class="action-btn" onclick="continueToNext()">ƒêi ti·∫øp Ch·∫∑ng ti·∫øp theo ‚ûî</button>
    </div>

    <div id="res-box" class="hidden" style="text-align: center; padding: 20px 0;">
        <h2>H√†nh tr√¨nh ho√†n t·∫•t! üèÜ</h2>
        <p id="total-score-info" style="font-size: 2rem; color: var(--primary); font-weight: bold; margin: 10px 0;"></p>
        <input type="text" id="p-name" class="input-field" placeholder="Nh·∫≠p H·ªç v√† T√™n c·ªßa em...">
        <input type="text" id="p-class" class="input-field" placeholder="Nh·∫≠p L·ªõp (V√≠ d·ª•: 5A1)...">
        <br>
        <button class="action-btn" onclick="save()">Ghi danh B·∫£ng V√†ng</button>
    </div>
</div>

<footer>
    <p>¬© 2025 EduRobot - Gi√°o vi√™n th·ª±c hi·ªán: <b>L√™ Th√†nh Long</b></p>
</footer>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
        authDomain: "gamhoctap.firebaseapp.com",
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gamhoctap"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const allData = [
        [ // Ch·∫∑ng 1: L√Ω thuy·∫øt c∆° b·∫£n
            { q: "T·ªïng hai s·ªë l√† 15, t·ªâ s·ªë l√† 2/3. T·ªïng s·ªë ph·∫ßn b·∫±ng nhau l√†:", a: ["2 ph·∫ßn", "3 ph·∫ßn", "5 ph·∫ßn", "6 ph·∫ßn"], c: 2, h: "L·∫•y t·ª≠ s·ªë c·ªông m·∫´u s·ªë: 2 + 3 = 5 ph·∫ßn." },
            { q: "T·ªïng l√† 20, t·ªïng s·ªë ph·∫ßn l√† 4. Gi√° tr·ªã m·ªôt ph·∫ßn l√†:", a: ["4", "5", "80", "16"], c: 1, h: "Gi√° tr·ªã m·ªôt ph·∫ßn = T·ªïng : T·ªïng s·ªë ph·∫ßn = 20 : 4 = 5." },
            { q: "S·ªë b√© chi·∫øm 1 ph·∫ßn, s·ªë l·ªõn chi·∫øm 4 ph·∫ßn. T·ªâ s·ªë c·ªßa s·ªë b√© v√† s·ªë l·ªõn l√†:", a: ["1/4", "4/1", "1/5", "4/5"], c: 0, h: "S·ªë b√© l√† t·ª≠ s·ªë, s·ªë l·ªõn l√† m·∫´u s·ªë: 1/4." },
            { q: "S·ªë b√© chi·∫øm 2 ph·∫ßn, s·ªë l·ªõn chi·∫øm 7 ph·∫ßn. T·ªïng s·ªë ph·∫ßn l√†:", a: ["7 ph·∫ßn", "2 ph·∫ßn", "9 ph·∫ßn", "5 ph·∫ßn"], c: 2, h: "T·ªïng s·ªë ph·∫ßn = 2 + 7 = 9 ph·∫ßn." },
            { q: "Trong b√†i to√°n T·ªïng - T·ªâ, sau khi t√¨m ƒë∆∞·ª£c gi√° tr·ªã 1 ph·∫ßn, mu·ªën t√¨m s·ªë l·ªõn ta l√†m g√¨?", a: ["L·∫•y gi√° tr·ªã 1 ph·∫ßn nh√¢n v·ªõi s·ªë ph·∫ßn s·ªë l·ªõn", "L·∫•y gi√° tr·ªã 1 ph·∫ßn chia s·ªë ph·∫ßn s·ªë l·ªõn", "L·∫•y T·ªïng tr·ª´ ƒëi gi√° tr·ªã 1 ph·∫ßn", "L·∫•y T·ªïng nh√¢n s·ªë ph·∫ßn s·ªë l·ªõn"], c: 0, h: "Nh√¢n gi√° tr·ªã 1 ph·∫ßn v·ªõi s·ªë ph·∫ßn t∆∞∆°ng ·ª©ng c·ªßa s·ªë l·ªõn." },
            { q: "T·ªâ s·ªë c·ªßa hai s·ªë l√† 3/5. N·∫øu s·ªë b√© l√† 3 ph·∫ßn th√¨ s·ªë l·ªõn l√† m·∫•y ph·∫ßn?", a: ["3 ph·∫ßn", "5 ph·∫ßn", "8 ph·∫ßn", "2 ph·∫ßn"], c: 1, h: "M·∫´u s·ªë ch·ªâ s·ªë ph·∫ßn c·ªßa s·ªë l·ªõn." },
            { q: "B∆∞·ªõc ƒë·∫ßu ti√™n khi gi·∫£i b√†i to√°n t√¨m hai s·ªë khi bi·∫øt T·ªïng v√† T·ªâ l√† g√¨?", a: ["T√¨m s·ªë l·ªõn", "T√¨m gi√° tr·ªã 1 ph·∫ßn", "V·∫Ω s∆° ƒë·ªì ƒëo·∫°n th·∫≥ng", "T√¨m t·ªïng s·ªë ph·∫ßn"], c: 2, h: "V·∫Ω s∆° ƒë·ªì gi√∫p ch√∫ng ta d·ªÖ h√¨nh dung b√†i to√°n h∆°n." },
            { q: "N·∫øu s·ªë b√© b·∫±ng 1/2 s·ªë l·ªõn, t·ªïng s·ªë ph·∫ßn b·∫±ng nhau l√†:", a: ["1 ph·∫ßn", "2 ph·∫ßn", "3 ph·∫ßn", "4 ph·∫ßn"], c: 2, h: "1 + 2 = 3 ph·∫ßn." }
        ],
        [ // Ch·∫∑ng 2: T√≠nh to√°n
            { q: "T·ªïng hai s·ªë l√† 45, t·ªâ s·ªë l√† 2/3. S·ªë b√© l√†:", a: ["18", "27", "15", "9"], c: 0, h: "T·ªïng s·ªë ph·∫ßn: 5. M·ªôt ph·∫ßn: 45:5=9. S·ªë b√©: 9x2=18." },
            { q: "T·ªïng hai s·ªë l√† 72, t·ªâ s·ªë l√† 1/5. S·ªë l·ªõn l√†:", a: ["12", "60", "62", "50"], c: 1, h: "T·ªïng s·ªë ph·∫ßn: 6. M·ªôt ph·∫ßn: 72:6=12. S·ªë l·ªõn: 12x5=60." },
            { q: "S·ª£i d√¢y d√†i 28m, c·∫Øt th√†nh 2 ƒëo·∫°n t·ªâ l·ªá 3/4. ƒêo·∫°n d√†i h∆°n l√†:", a: ["12m", "16m", "4m", "7m"], c: 1, h: "T·ªïng s·ªë ph·∫ßn: 7. M·ªôt ph·∫ßn: 4. ƒêo·∫°n d√†i: 4x4=16m." },
            { q: "T·ªïng l√† 100, t·ªâ s·ªë 1/1. Hai s·ªë ƒë√≥ l√†:", a: ["40 v√† 60", "50 v√† 50", "30 v√† 70", "0 v√† 100"], c: 1, h: "T·ªâ s·ªë 1/1 nghƒ©a l√† hai s·ªë b·∫±ng nhau." },
            { q: "Hai s·ªë c√≥ t·ªïng l√† 40, t·ªâ s·ªë l√† 1/3. S·ªë l·ªõn l√†:", a: ["10", "20", "30", "40"], c: 2, h: "T·ªïng ph·∫ßn: 4. M·ªôt ph·∫ßn: 10. S·ªë l·ªõn: 10x3=30." },
            { q: "T·ªïng hai s·ªë l√† 120, t·ªâ s·ªë l√† 5/7. S·ªë b√© l√†:", a: ["50", "70", "12", "60"], c: 0, h: "T·ªïng ph·∫ßn: 12. M·ªôt ph·∫ßn: 10. S·ªë b√©: 10x5=50." },
            { q: "T√¨m hai s·ªë c√≥ t·ªïng l√† 15 v√† t·ªâ s·ªë l√† 2. Hai s·ªë ƒë√≥ l√†:", a: ["5 v√† 10", "2 v√† 13", "3 v√† 12", "7 v√† 8"], c: 0, h: "T·ªâ s·ªë l√† 2 nghƒ©a l√† 2/1. T·ªïng ph·∫ßn: 3." },
            { q: "T·ªïng hai s·ªë l√† 21, s·ªë b√© b·∫±ng 3/4 s·ªë l·ªõn. S·ªë l·ªõn l√†:", a: ["9", "12", "7", "14"], c: 1, h: "T·ªïng ph·∫ßn: 7. M·ªôt ph·∫ßn: 3. S·ªë l·ªõn: 3x4=12." }
        ],
        [ // Ch·∫∑ng 3: ·ª®ng d·ª•ng th·ª±c t·∫ø
            { q: "L·ªõp 5A c√≥ 35 h·ªçc sinh. Nam b·∫±ng 3/4 N·ªØ. S·ªë h·ªçc sinh N·ªØ l√†:", a: ["15 b·∫°n", "20 b·∫°n", "12 b·∫°n", "25 b·∫°n"], c: 1, h: "T·ªïng s·ªë ph·∫ßn: 7. N·ªØ chi·∫øm 4 ph·∫ßn. (35:7)x4=20." },
            { q: "Chu vi HCN 40cm. R·ªông b·∫±ng 2/3 D√†i. Chi·ªÅu d√†i l√†:", a: ["12cm", "8cm", "24cm", "16cm"], c: 0, h: "N·ª≠a chu vi: 20cm. T·ªïng ph·∫ßn: 5. M·ªôt ph·∫ßn: 4. D√†i: 4x3=12cm." },
            { q: "M·∫π v√† con t·ªïng 48 tu·ªïi. Tu·ªïi con b·∫±ng 1/3 tu·ªïi m·∫π. Tu·ªïi m·∫π l√†:", a: ["36", "12", "40", "32"], c: 0, h: "T·ªïng ph·∫ßn: 4. M·ªôt ph·∫ßn: 12. M·∫π: 12x3=36 tu·ªïi." },
            { q: "Hai kho c√≥ 150 t·∫•n. Kho A b·∫±ng 2/3 kho B. Kho B c√≥:", a: ["60 t·∫•n", "90 t·∫•n", "100 t·∫•n", "50 t·∫•n"], c: 1, h: "T·ªïng s·ªë ph·∫ßn: 5. Kho B chi·∫øm 3 ph·∫ßn. (150:5)x3=90." },
            { q: "M·ªôt n√¥ng tr·∫°i c√≥ 120 con g√† v√† v·ªãt. S·ªë g√† b·∫±ng 1/5 s·ªë v·ªãt. C√≥ bao nhi√™u g√†?", a: ["20 con", "100 con", "24 con", "60 con"], c: 0, h: "T·ªïng ph·∫ßn: 6. M·ªôt ph·∫ßn: 20. G√†: 20 con." },
            { q: "T·ªïng c·ªßa hai s·ªë l√† s·ªë l·ªõn nh·∫•t c√≥ hai ch·ªØ s·ªë (99). T·ªâ s·ªë l√† 4/5. S·ªë b√© l√†:", a: ["44", "55", "45", "54"], c: 0, h: "T·ªïng ph·∫ßn: 9. M·ªôt ph·∫ßn: 11. S·ªë b√©: 11x4=44." },
            { q: "An v√† B√¨nh c√≥ 30 vi√™n bi. S·ªë bi c·ªßa An b·∫±ng 1/2 c·ªßa B√¨nh. An c√≥ m·∫•y vi√™n?", a: ["10 vi√™n", "20 vi√™n", "15 vi√™n", "5 vi√™n"], c: 0, h: "T·ªïng ph·∫ßn: 3. An: 30:3=10 vi√™n." },
            { q: "N·ª≠a chu vi m·ªôt khu ƒë·∫•t l√† 60m. R·ªông b·∫±ng 1/2 D√†i. Chi·ªÅu r·ªông l√†:", a: ["20m", "40m", "30m", "10m"], c: 0, h: "T·ªïng ph·∫ßn: 3. R·ªông: 60:3=20m." }
        ]
    ];

    let curLvl = 0, curQ = 0, totalScore = 0;
    let currentQuestions = [];

    function shuffleQuestions() {
        let pool = [...allData[curLvl]];
        pool.sort(() => Math.random() - 0.5);
        currentQuestions = pool.slice(0, 4);
        curQ = 0;
    }

    function show() {
        let q = currentQuestions[curQ];
        document.getElementById('q-text').innerHTML = `<b>C√¢u ${curLvl * 4 + curQ + 1}:</b> ${q.q}`;
        document.getElementById('fill').style.width = ((curLvl * 4 + curQ) / 12 * 100) + "%";
        document.getElementById('q-opts').innerHTML = q.a.map((o, i) => `<button class="opt-btn" onclick="check(${i})">${o}</button>`).join('');
        document.getElementById('hint-box').classList.add('hidden');
    }

    function check(i) {
        let q = currentQuestions[curQ];
        let btns = document.querySelectorAll('.opt-btn');
        btns.forEach(b => b.disabled = true);
        
        if(i === q.c) {
            totalScore++; 
            btns[i].style.background = "#c8e6c9";
            btns[i].style.borderColor = "#4CAF50";
            hint("Ch√≠nh x√°c! ‚ú®");
        } else {
            btns[i].style.background = "#ffcdd2";
            btns[i].style.borderColor = "#f44336";
            btns[q.c].style.background = "#c8e6c9";
            hint("G·ª£i √Ω: " + q.h);
        }
        
        setTimeout(() => {
            curQ++;
            if(curQ < 4) show();
            else finishStage();
        }, 2000);
    }

    function hint(m) {
        document.getElementById('hint-box').classList.remove('hidden');
        document.getElementById('hint-text').innerText = m;
    }

    function finishStage() {
        document.getElementById('quiz-area').classList.add('hidden');
        if (curLvl < 2) {
            document.getElementById('next-lvl-screen').classList.remove('hidden');
            document.getElementById('lvl-score-info').innerText = `Xong Ch·∫∑ng ${curLvl + 1}. T·ªïng ƒëi·ªÉm: ${totalScore}/12`;
        } else {
            document.getElementById('res-box').classList.remove('hidden');
            document.getElementById('total-score-info').innerText = `${totalScore} / 12 ƒêI·ªÇM`;
            document.getElementById('fill').style.width = "100%";
        }
    }

    function continueToNext() {
        curLvl++;
        shuffleQuestions();
        document.querySelectorAll('.lvl-btn').forEach((b, i) => b.classList.toggle('active', i === curLvl));
        document.getElementById('next-lvl-screen').classList.add('hidden');
        document.getElementById('quiz-area').classList.remove('hidden');
        show();
    }

    function save() {
        const name = document.getElementById('p-name').value.trim();
        const className = document.getElementById('p-class').value.trim();
        if (!name || !className) { alert("Em h√£y nh·∫≠p t√™n v√† l·ªõp nh√©!"); return; }

        const userKey = (className + "_" + name).replace(/[\s\/.\#\$\[\]]/g, '_');

        // 1. L∆∞u v√†o Firebase c·ªßa ri√™ng b√†i T·ªïng - T·ªâ
        db.ref('scores/Tong_Ti_So/' + userKey).set({
            fullName: name,
            className: "'" + className,
            score: totalScore,
            date: new Date().toLocaleString('vi-VN'),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            alert("Ghi danh B·∫£ng V√†ng th√†nh c√¥ng! üèÜ");

            // 2. --- ƒêO·∫†N CODE K·∫æT N·ªêI H·ªÜ TH·ªêNG EDURobot (C√ÅCH B) ---
            if (window.parent !== window) {
                // G·ª≠i d·ªØ li·ªáu v·ªÅ trang play.html
                window.parent.postMessage({
                    type: 'GAME_COMPLETE',
                    score: totalScore,
                    week: 21 // Tu·∫ßn 21: B√†i to√°n T·ªïng - T·ªâ
                }, '*');
            } else {
                // N·∫øu h·ªçc sinh ch∆°i link l·∫ª th√¨ quay v·ªÅ index.html
                location.href = "index.html";
            }
            // ---------------------------------------------------
        }).catch((err) => {
            console.error("L·ªói:", err);
            alert("Kh√¥ng th·ªÉ l∆∞u ƒëi·ªÉm, em ki·ªÉm tra k·∫øt n·ªëi m·∫°ng nh√©!");
        });
    }

    window.onload = () => {
        shuffleQuestions();
        show();
    };
</script>
</body>
</html>
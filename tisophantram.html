<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot v√† H√†nh tr√¨nh T·ªâ s·ªë - To√°n 5</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #FF9800; --secondary: #2196F3; --success: #4CAF50; --bg: #FFFBF0; }
        body { font-family: 'Lexend', Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 800px; width: 100%; background: white; padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 3px solid #FFCC80; }
        
        .header-img { width: 100%; border-radius: 15px; border: 2px solid #EEE; margin-bottom: 15px; height: 180px; object-fit: cover; background: #eee; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .status-bar { display: flex; justify-content: space-between; font-weight: bold; color: #555; margin-bottom: 10px; }
        .progress-container { height: 12px; background: #EEE; border-radius: 6px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: 0.5s; }

        .level-map { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 25px; }
        .lvl-btn { padding: 15px 5px; border: none; border-radius: 15px; background: #F5F5F5; font-family: 'Lexend'; font-size: 0.9rem; border-bottom: 4px solid #DDD; color: #888; pointer-events: none; }
        .lvl-btn.active { background: #FFF3E0; border-color: var(--primary); color: var(--primary); font-weight: bold; border-bottom: 4px solid var(--primary); }

        .question-area { min-height: 150px; text-align: center; }
        .q-text { font-size: 1.2rem; color: #333; margin-bottom: 20px; line-height: 1.6; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .opt { padding: 15px; border: 2px solid #F0F0F0; border-radius: 12px; background: white; cursor: pointer; transition: 0.2s; font-size: 1rem; font-family: 'Lexend'; }
        .opt:hover:not(:disabled) { border-color: var(--secondary); background: #E3F2FD; }

        .robot-box { display: flex; align-items: center; background: #E1F5FE; padding: 15px; border-radius: 15px; margin-top: 20px; gap: 10px; border-left: 5px solid var(--secondary); }
        .hidden { display: none; }
        
        .action-btn { padding: 15px 30px; background: var(--success); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-family: 'Lexend'; font-size: 1.1rem; margin-top: 10px; }
        .input-field { padding: 12px; border-radius: 10px; border: 2px solid #ddd; width: 85%; font-family: 'Lexend'; margin-bottom: 10px; font-size: 1rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-img">
        <h2 style="color: var(--primary);">ü§ñ H√ÄNH TR√åNH T·ªà S·ªê</h2>
    </div>

    <div class="level-map">
        <button id="btn-0" class="lvl-btn active">üèîÔ∏è CH·∫∂NG 1<br>Kh√°m ph√°</button>
        <button id="btn-1" class="lvl-btn">üå≤ CH·∫∂NG 2<br>Luy·ªán t·∫≠p</button>
        <button id="btn-2" class="lvl-btn">üèÜ CH·∫∂NG 3<br>V·ªÅ ƒë√≠ch</button>
    </div>

    <div class="progress-container"><div id="progress" class="progress-bar"></div></div>

    <div id="game-content">
        <div class="status-bar">
            <span id="lvl-title">Kh·ªüi h√†nh th√¥i!</span>
            <span id="score-display">T·ªïng ƒëi·ªÉm: 0/12</span>
        </div>
        
        <div class="question-area">
            <p class="q-text" id="q-text">ƒêang t·∫£i c√¢u h·ªèi...</p>
            <div class="options" id="options"></div>
        </div>

        <div id="robot-hint" class="robot-box hidden">
            <span>ü§ñ:</span> <span id="hint-text"></span>
        </div>
    </div>

    <div id="next-lvl-screen" class="hidden" style="text-align: center; padding: 20px;">
        <h2 id="lvl-msg">Tuy·ªát v·ªùi!</h2>
        <p id="lvl-score-info" style="font-size: 1.2rem;"></p>
        <button class="action-btn" onclick="continueToNext()">Ti·∫øp t·ª•c Ch·∫∑ng ti·∫øp theo ‚ûî</button>
    </div>

    <div id="result-screen" class="hidden" style="text-align: center; padding: 30px 0;">
        <h2 id="result-title">H√†nh tr√¨nh ho√†n t·∫•t! üèÜ</h2>
        <p id="result-msg" style="font-size: 1.8rem; color: var(--primary); font-weight: bold;"></p>
        
        <input type="text" id="player-name" class="input-field" placeholder="Nh·∫≠p H·ªç v√† T√™n c·ªßa em...">
        <input type="text" id="player-class" class="input-field" placeholder="Nh·∫≠p L·ªõp (V√≠ d·ª•: 5/1)...">
        <br>
        <button class="action-btn" onclick="saveScoreOnline()">Ghi danh B·∫£ng V√†ng</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
        authDomain: "gamhoctap.firebaseapp.com",
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gamhoctap"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const lessons = [
        [ // CH·∫∂NG 1
            { q: "C√≥ 3 xe ƒëi·ªán v√† 7 xe xƒÉng. T·ªâ s·ªë c·ªßa xe ƒëi·ªán v√† xe xƒÉng l√†?", a: ["3 : 7", "7 : 3", "3 : 10", "7 : 10"], c: 0, h: "T·ªâ s·ªë c·ªßa a v√† b l√† a : b" },
            { q: "C√≥ 10 xe, 3 xe ƒëi·ªán. T·ªâ s·ªë c·ªßa xe ƒëi·ªán v√† t·ªïng s·ªë xe l√†?", a: ["3/10", "10/3", "3/7", "7/10"], c: 0, h: "L·∫•y s·ªë xe ƒëi·ªán chia cho t·ªïng s·ªë xe." },
            { q: "Vi·∫øt t·ªâ s·ªë 17/100 d∆∞·ªõi d·∫°ng ph·∫ßn trƒÉm:", a: ["1.7%", "17%", "0.17%", "170%"], c: 1, h: "M·∫´u s·ªë 100 thay b·∫±ng k√≠ hi·ªáu %" },
            { q: "T·ªâ s·ªë c·ªßa 5 v√† 8 vi·∫øt l√†?", a: ["5 : 8", "8 : 5", "5/8", "C·∫£ A v√† C"], c: 3, h: "T·ªâ s·ªë c√≥ th·ªÉ vi·∫øt d·∫°ng ph√©p chia ho·∫∑c ph√¢n s·ªë." }
        ],
        [ // CH·∫∂NG 2
            { q: "Chuy·ªÉn ph√¢n s·ªë 2/5 th√†nh t·ªâ s·ªë ph·∫ßn trƒÉm:", a: ["20%", "40%", "50%", "25%"], c: 1, h: "ƒê∆∞a m·∫´u s·ªë v·ªÅ 100: 2/5 = 40/100" },
            { q: "S·ªë th·∫≠p ph√¢n 0,65 vi·∫øt th√†nh ph·∫ßn trƒÉm l√†?", a: ["6.5%", "0.65%", "65%", "650%"], c: 2, h: "0,65 = 65/100" },
            { q: "12% c·ªßa 100 √¥ vu√¥ng l√† bao nhi√™u √¥?", a: ["1.2 √¥", "12 √¥", "120 √¥", "10 √¥"], c: 1, h: "12% c·ªßa 100 ch√≠nh l√† 12." },
            { q: "Trong v∆∞·ªùn c√≥ 50 c√¢y, 10 c√¢y cam. T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa c√¢y cam l√†?", a: ["10%", "20%", "50%", "5%"], c: 1, h: "10/50 = 20/100" }
        ],
        [ // CH·∫∂NG 3
            { q: "L·ªõp 5A c√≥ 30 HS, 18 HS n·ªØ. T·ªâ s·ªë ph·∫ßn trƒÉm HS n·ªØ l√†?", a: ["18%", "50%", "60%", "30%"], c: 2, h: "18/30 = 6/10 = 60/100" },
            { q: "M·ªôt c·ª≠a h√†ng c√≥ 100 c√°i b√°nh, b√°n h·∫øt 75 c√°i. T·ªâ s·ªë ph·∫ßn trƒÉm b√°nh c√≤n l·∫°i l√†?", a: ["75%", "25%", "100%", "50%"], c: 1, h: "C√≤n l·∫°i 25 c√°i. 25/100 = 25%" },
            { q: "C·ª© 100kg n∆∞·ªõc bi·ªÉn c√≥ 4kg mu·ªëi. T·ªâ s·ªë ph·∫ßn trƒÉm mu·ªëi l√†?", a: ["0.4%", "4%", "40%", "400%"], c: 1, h: "4/100 ch√≠nh l√† 4%." },
            { q: "Gi√° xƒÉng tƒÉng t·ª´ 20k l√™n 22k. S·ªë ti·ªÅn tƒÉng chi·∫øm bao nhi√™u % gi√° c≈©?", a: ["2%", "10%", "20%", "5%"], c: 1, h: "TƒÉng 2k. 2/20 = 10/100 = 10%" }
        ]
    ];

    let curLvl = 0, curQ = 0, totalScore = 0;
    let startTime = Date.now(); // 1. B·∫ÆT ƒê·∫¶U T√çNH GI·ªú

    function showQuestion() {
        let q = lessons[curLvl][curQ];
        document.getElementById('q-text').innerHTML = `<b>C√¢u ${curLvl * 4 + curQ + 1}:</b> ${q.q}`;
        document.getElementById('progress').style.width = ((curLvl * 4 + curQ) / 12 * 100) + "%";
        
        let html = q.a.map((opt, i) => `<button class="opt" onclick="checkAnswer(${i})">${opt}</button>`).join('');
        document.getElementById('options').innerHTML = html;
        document.getElementById('robot-hint').classList.add('hidden');
        document.getElementById('lvl-title').innerText = "ƒêang ·ªü: Ch·∫∑ng " + (curLvl + 1);
    }

    function checkAnswer(i) {
        let q = lessons[curLvl][curQ];
        let btns = document.querySelectorAll('.opt');
        btns.forEach(b => b.disabled = true);

        if(i === q.c) {
            totalScore++;
            btns[i].style.background = "#C8E6C9";
            showRobot("Robot: Ch√≠nh x√°c! +1 ƒëi·ªÉm. ‚ú®");
        } else {
            btns[i].style.background = "#FFCDD2";
            btns[q.c].style.background = "#C8E6C9";
            showRobot("Robot g·ª£i √Ω: " + q.h);
        }

        setTimeout(() => {
            curQ++;
            if(curQ < 4) {
                showQuestion();
                updateScoreDisplay();
            } else {
                finishStage();
            }
        }, 2200);
    }

    function updateScoreDisplay() {
        document.getElementById('score-display').innerText = `T·ªïng ƒëi·ªÉm: ${totalScore}/12`;
    }

    function showRobot(m) {
        document.getElementById('robot-hint').classList.remove('hidden');
        document.getElementById('hint-text').innerText = m;
    }

    function finishStage() {
        document.getElementById('game-content').classList.add('hidden');
        if (curLvl < 2) {
            document.getElementById('next-lvl-screen').classList.remove('hidden');
            document.getElementById('lvl-score-info').innerText = `Xong Ch·∫∑ng ${curLvl + 1}. ƒêi·ªÉm hi·ªán t·∫°i: ${totalScore}/12`;
        } else {
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('result-msg').innerText = `${totalScore} / 12 ƒêI·ªÇM`;
            document.getElementById('progress').style.width = "100%";
        }
    }

    function continueToNext() {
        curLvl++;
        curQ = 0;
        document.querySelectorAll('.lvl-btn').forEach((b, i) => b.classList.toggle('active', i === curLvl));
        document.getElementById('next-lvl-screen').classList.add('hidden');
        document.getElementById('game-content').classList.remove('hidden');
        showQuestion();
        updateScoreDisplay();
    }

    function saveScoreOnline() {
        const name = document.getElementById('player-name').value.trim();
        const className = document.getElementById('player-class').value.trim();
        
        if (!name || !className) {
            alert("Em vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß H·ªç t√™n v√† L·ªõp nh√©!");
            return;
        }

        // 2. T√çNH GI√ÇY HO√ÄN TH√ÄNH
        const endTime = Date.now();
        const durationSeconds = Math.floor((endTime - startTime) / 1000);

        const GAME_ID = "Ti_So_Phan_Tram";
        const dateNow = new Date().toLocaleString('vi-VN');
        
        // 3. C·ªê ƒê·ªäNH ƒê·ªäNH D·∫†NG TEXT CHO EXCEL
        const excelClassName = "'" + className;

        const safeClassName = className.replace(/[\/.\#\$\[\]]/g, '_');
        const safeName = name.replace(/[\/.\#\$\[\]]/g, '_');
        const userKey = (safeClassName + "_" + safeName).replace(/\s+/g, '_');

        db.ref('scores/' + GAME_ID + '/' + userKey).set({
            fullName: name,
            className: excelClassName, // ƒê√£ th√™m d·∫•u nh√°y ƒë∆°n
            score: totalScore,
            duration: durationSeconds, // L∆∞u th·ªùi gian ƒë·ªÉ x·∫øp h·∫°ng
            date: dateNow,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            alert("Ch√∫c m·ª´ng em " + name + " ƒë√£ ho√†n th√†nh trong " + durationSeconds + " gi√¢y!");
            location.href = "bang-vang.html";
        }).catch((error) => {
            alert("C√≥ l·ªói k·∫øt n·ªëi, em th·ª≠ l·∫°i nh√©!");
        });
    }

    window.onload = showQuestion;
</script>
</body>
</html>
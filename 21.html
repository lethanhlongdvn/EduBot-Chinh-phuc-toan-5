<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TU·∫¶N 21: X√ÇY TH√ÅP TRI TH·ª®C</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Lexend:wght@400;600;700&display=swap"
        rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --p: #FF9800;
            --s: #2196F3;
            --bg: #0f172a;
            --card: #1e293b;
            --success: #2ecc71;
            --danger: #e74c3c;
            --gold: #ffd700;
            --brick: #e67e22;
        }

        body {
            font-family: 'Lexend', sans-serif;
            background: var(--bg);
            color: white;
            margin: 0;
            padding: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            padding-bottom: 40px;
        }

        .container {
            max-width: 900px;
            width: 100%;
            margin-bottom: 50px;
        }

        /* HEADER */
        .header {
            background: var(--card);
            padding: 8px;
            border-radius: 12px;
            border-bottom: 3px solid var(--p);
            text-align: center;
            margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--p);
            text-transform: uppercase;
            font-family: 'Bungee';
            letter-spacing: 1px;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #94a3b8;
            font-weight: 600;
            padding: 5px 10px;
        }

        /* LAYOUT GAME: Chia 2 c·ªôt tr√™n Desktop, 1 c·ªôt tr√™n Mobile */
        .game-layout {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            justify-content: center;
        }

        .question-area {
            flex: 2;
            background: var(--card);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #334155;
            min-height: 250px;
            position: relative;
        }

        .tower-area {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 10px;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            min-height: 300px;
            border-bottom: 5px solid #555;
            position: relative;
        }

        @media (max-width: 600px) {
            .game-layout {
                flex-direction: column-reverse;
                align-items: stretch;
            }

            .tower-area {
                min-height: 150px;
                flex-direction: row;
                justify-content: center;
                align-items: flex-end;
                gap: 2px;
                overflow-x: auto;
            }

            .tower-block {
                width: 15px !important;
                height: 40px !important;
                margin: 0 !important;
            }

            .tower-roof {
                width: 30px !important;
            }
        }

        /* VISUAL TH√ÅP */
        .tower-base {
            width: 100%;
            height: 10px;
            background: #555;
            border-radius: 2px;
            margin-top: 5px;
        }

        .tower-block {
            width: 80%;
            height: 25px;
            background: var(--brick);
            margin-bottom: 2px;
            border-radius: 4px;
            border: 2px solid #d35400;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            transform: translateY(50px) scale(0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.3);
        }

        .tower-block.built {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .tower-block.stage-1 {
            background: #7f8c8d;
            border-color: #2c3e50;
        }

        /* M√≥ng m√†u x√°m */
        .tower-block.stage-2 {
            background: #e67e22;
            border-color: #d35400;
        }

        /* Th√¢n m√†u cam */
        .tower-block.stage-3 {
            background: #f1c40f;
            border-color: #f39c12;
            box-shadow: 0 0 10px var(--gold);
        }

        /* ƒê·ªânh v√†ng */

        /* C√ÇU H·ªéI */
        .stage-badge {
            position: absolute;
            top: -10px;
            left: 10px;
            background: var(--p);
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .q-text {
            font-size: 1.1rem;
            margin: 20px 0;
            line-height: 1.5;
            font-weight: 600;
            text-align: justify;
        }

        /* N√öT B·∫§M */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .opt-btn {
            background: #334155;
            border: 2px solid #475569;
            padding: 15px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1rem;
        }

        .opt-btn:hover {
            background: #475569;
        }

        .opt-btn.correct {
            background: var(--success);
            border-color: var(--success);
            color: #000;
            font-weight: bold;
            animation: pulse 0.5s;
        }

        .opt-btn.wrong {
            background: var(--danger);
            border-color: var(--danger);
            opacity: 0.5;
        }

        /* INPUT V√íNG 3 */
        .input-group {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        .input-ans {
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--p);
            background: #0f172a;
            color: white;
            font-size: 1.1rem;
            outline: none;
            text-align: center;
        }

        .btn-submit {
            padding: 15px;
            background: var(--p);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            text-transform: uppercase;
        }

        /* RESULT */
        #result-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .score-box {
            font-size: 3rem;
            font-weight: bold;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            margin: 20px 0;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .hidden {
            display: none !important;
        }

        .game-footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #0f172a;
            padding: 8px 0;
            text-align: center;
            font-size: 0.65rem;
            color: #64748b;
            border-top: 1px solid #334155;
            z-index: 999;
        }
    </style>
</head>

<body>

    <div class="container" id="game-ui">
        <div class="header">
            <h1>TU·∫¶N 21: X√ÇY TH√ÅP TRI TH·ª®C</h1>
            <div class="info-bar">
                <span>üë§ <b id="user-name">---</b></span>
                <span>‚≠ê <b id="current-score" style="color:var(--gold)">0</b>/100</span>
                <span>‚è± <b id="timer">00:00</b></span>
            </div>
        </div>

        <div class="game-layout">
            <div class="question-area" id="q-area">
                <div class="stage-badge" id="stage-badge">V√íNG 1: M√ìNG V·ªÆNG CH·∫ÆC</div>
                <div id="q-content">
                </div>
            </div>

            <div class="tower-area" id="tower-visual">
                <div class="tower-base"></div>
            </div>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <h2 style="color:var(--gold); font-family:'Bungee';">C√îNG TR√åNH HO√ÄN TH√ÄNH</h2>
        <div class="score-box" id="final-score">0</div>
        <p>Th·ªùi gian: <span id="final-time-text">--:--</span></p>
        <p style="color:#aaa" id="redirect-msg">ƒêang l∆∞u ƒëi·ªÉm...</p>
        <button class="btn-submit" onclick="location.reload()"
            style="margin-top:20px; width:auto; padding: 10px 30px;">L√†m l·∫°i ƒë·ªÅ m·ªõi</button>
    </div>

    <div class="game-footer">
        @ 2026 EduRobot.id.vn - L√™ Th√†nh Long
    </div>

    <script>
        // --- C·∫§U H√åNH & D·ªÆ LI·ªÜU ---
        const firebaseConfig = { databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const savedName = localStorage.getItem('studentName');
        const savedClass = localStorage.getItem('studentClass');
        const savedSchool = localStorage.getItem('studentSchool');
        if (!savedName || !savedClass) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); window.location.href = "index.html"; }
        document.getElementById('user-name').innerText = savedName;
        window.onbeforeunload = () => "ƒêang l√†m b√†i...";

        // DATA V√íNG 1 (M·ªói c√¢u 8 ƒëi·ªÉm)
        const poolR1 = [
            { q: "T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa 12 v√† 40 l√†:", a: ["30%", "40%", "28%", "32%"], correct: "30%" },
            { q: "T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa 15 v√† 20 l√†:", a: ["75%", "80%", "65%", "70%"], correct: "75%" },
            { q: "T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa 1,2 v√† 4 l√†:", a: ["30%", "0,3%", "3%", "300%"], correct: "30%" },
            { q: "T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa 0,6 v√† 2,4 l√†:", a: ["25%", "2,5%", "40%", "4%"], correct: "25%" },
            { q: "L·ªõp c√≥ 40 h·ªçc sinh, 18 b·∫°n n·ªØ. S·ªë b·∫°n n·ªØ chi·∫øm bao nhi√™u ph·∫ßn trƒÉm?", a: ["45%", "40%", "55%", "18%"], correct: "45%" },
            { q: "H·ªôp 50 vi√™n bi, c√≥ 15 bi ƒë·ªè. T·ªâ s·ªë ph·∫ßn trƒÉm bi ƒë·ªè l√†:", a: ["30%", "15%", "35%", "50%"], correct: "30%" },
            { q: "C·ª≠a h√†ng c√≥ 200kg g·∫°o, ƒë√£ b√°n 120kg. T·ªâ s·ªë ph·∫ßn trƒÉm g·∫°o ƒë√£ b√°n l√†:", a: ["60%", "40%", "120%", "20%"], correct: "60%" },
            { q: "Trong 80kg n∆∞·ªõc bi·ªÉn c√≥ 2,8kg mu·ªëi. T·ªâ s·ªë ph·∫ßn trƒÉm mu·ªëi l√†:", a: ["3,5%", "35%", "2,8%", "4%"], correct: "3,5%" },
            { q: "V∆∞·ªùn c√≥ 25 c√¢y cam v√† 75 c√¢y b∆∞·ªüi (T·ªïng 100 c√¢y). T·ªâ s·ªë ph·∫ßn trƒÉm c√¢y cam so v·ªõi c·∫£ v∆∞·ªùn l√†:", a: ["25%", "75%", "33,3%", "50%"], correct: "25%" },
            { q: "Trong 40kg n∆∞·ªõc bi·ªÉn c√≥ 2kg mu·ªëi. T·ªâ s·ªë ph·∫ßn trƒÉm mu·ªëi l√†:", a: ["5%", "2%", "4%", "20%"], correct: "5%" }
        ];

        // DATA V√íNG 2 (M·ªói c√¢u 6 ƒëi·ªÉm - ƒêi·ªÅn khuy·∫øt ch·ªçn 1 trong 4)
        const poolR2 = [
            { q: "M·ªôt chi·∫øc √°o gi√° 150.000ƒë, gi·∫£m gi√° 15%. Gi√° b√°n m·ªõi l√† ... ƒë·ªìng.", a: ["127.500", "135.000", "120.000", "22.500"], correct: "127.500" },
            { q: "V·ªën 500.000ƒë, l√£i 20%. Gi√° b√°n l√† ... ƒë·ªìng.", a: ["600.000", "550.000", "100.000", "400.000"], correct: "600.000" },
            { q: "Quy·ªÉn s√°ch gi√° 80.000ƒë, tƒÉng gi√° 10%. Gi√° m·ªõi l√† ... ƒë·ªìng.", a: ["88.000", "72.000", "8.000", "90.000"], correct: "88.000" },
            { q: "NƒÉm ngo√°i thu 500 t·∫•n l√∫a, nƒÉm nay tƒÉng 12%. S·∫£n l∆∞·ª£ng nƒÉm nay l√† ... t·∫•n.", a: ["560", "60", "512", "550"], correct: "560" },
            { q: "B√¨nh 400g dung d·ªãch 5% mu·ªëi (c√≥ 20g mu·ªëi). ƒê·ªï th√™m 100g n∆∞·ªõc l·ªçc. T·ªâ l·ªá mu·ªëi m·ªõi l√† ... %.", a: ["4%", "5%", "3%", "1%"], correct: "4%" },
            { q: "C√¥ng ty 200 ng∆∞·ªùi (40% nam). Tuy·ªÉn th√™m 50 n·ªØ. T·ªâ l·ªá nam l√∫c n√†y l√† ... %.", a: ["32%", "40%", "30%", "25%"], correct: "32%" },
            { q: "M·∫£nh ƒë·∫•t 20m x 15m. D√†nh 20% l√†m nh√†, 15% l√†m s√¢n. Di·ªán t√≠ch c√≤n l·∫°i l√† ... m¬≤.", a: ["195", "105", "300", "65"], correct: "195" },
            { q: "L∆∞∆°ng th√°ng 1 tƒÉng 10%, th√°ng 2 gi·∫£m 10%. So v·ªõi ban ƒë·∫ßu l∆∞∆°ng th√°ng 2 ...", a: ["gi·∫£m 1%", "gi·ªØ nguy√™n", "tƒÉng 1%", "gi·∫£m 10%"], correct: "gi·∫£m 1%" }
        ];

        // DATA V√íNG 3 (M·ªói c√¢u 10 ƒëi·ªÉm - Nh·∫≠p s·ªë)
        const poolR3 = [
            { q: "M·ªôt l·ªõp h·ªçc c√≥ 40 h·ªçc sinh, trong ƒë√≥ 60% l√† n·ªØ. H·ªèi l·ªõp ƒë√≥ c√≥ bao nhi√™u h·ªçc sinh nam?", ans: ["16"] },
            { q: "M·ªôt ng∆∞·ªùi g·ª≠i ti·∫øt ki·ªám 10.000.000 ƒë·ªìng v·ªõi l√£i su·∫•t 0,5% m·ªôt th√°ng. H·ªèi sau m·ªôt th√°ng ng∆∞·ªùi ƒë√≥ nh·∫≠n ƒë∆∞·ª£c bao nhi√™u ti·ªÅn l√£i? (Ch·ªâ ghi s·ªë)", ans: ["50000", "50.000"] },
            { q: "Gi√° xƒÉng tƒÉng t·ª´ 20.000ƒë l√™n 25.000ƒë. H·ªèi gi√° xƒÉng ƒë√£ tƒÉng bao nhi√™u ph·∫ßn trƒÉm? (Ch·ªâ ghi s·ªë)", ans: ["25"] },
            { q: "T√¨m m·ªôt s·ªë bi·∫øt 25% c·ªßa n√≥ l√† 40.", ans: ["160"] },
            { q: "T√¨m m·ªôt s·ªë bi·∫øt 15% c·ªßa n√≥ l√† 45.", ans: ["300"] }
        ];

        // --- LOGIC GAME ---
        let gameData = [];
        let currentQIdx = 0;
        let score = 0;
        let seconds = 0;
        let timerInterval;

        function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

        function initGame() {
            // L·∫•y ƒë·ªÅ ng·∫´u nhi√™n: 5 c√¢u R1, 5 c√¢u R2, 3 c√¢u R3
            const r1 = shuffle([...poolR1]).slice(0, 5).map(i => ({ ...i, stage: 1, points: 8 }));
            const r2 = shuffle([...poolR2]).slice(0, 5).map(i => ({ ...i, stage: 2, points: 6 }));
            const r3 = shuffle([...poolR3]).slice(0, 3).map(i => ({ ...i, stage: 3, points: 10 }));

            gameData = [...r1, ...r2, ...r3];
            currentQIdx = 0;
            score = 0;

            // T·∫°o visual th√°p r·ªóng (13 t·∫ßng)
            const tower = document.getElementById('tower-visual');
            tower.innerHTML = '<div class="tower-base"></div>';
            for (let i = 0; i < 13; i++) {
                const block = document.createElement('div');
                block.className = 'tower-block';
                block.id = `block-${i}`;
                // G√°n class m√†u s·∫Øc d·ª±a tr√™n t·∫ßng
                if (i < 5) block.classList.add('stage-1');
                else if (i < 10) block.classList.add('stage-2');
                else block.classList.add('stage-3');
                tower.appendChild(block);
            }

            renderQuestion();
            startTimer();
        }

        function renderQuestion() {
            if (currentQIdx >= gameData.length) { finishGame(); return; }

            const q = gameData[currentQIdx];
            const badge = document.getElementById('stage-badge');
            const content = document.getElementById('q-content');

            // C·∫≠p nh·∫≠t Badge
            if (q.stage === 1) badge.innerText = "V√íNG 1: X√ÇY M√ìNG (5 c√¢u - 8ƒë/c√¢u)";
            else if (q.stage === 2) badge.innerText = "V√íNG 2: D·ª∞NG TH√ÅP (5 c√¢u - 6ƒë/c√¢u)";
            else badge.innerText = "V√íNG 3: V·ªÄ ƒê√çCH (3 c√¢u - 10ƒë/c√¢u)";

            // Render n·ªôi dung
            let html = `<div class="q-text">C√¢u ${currentQIdx + 1}: ${q.q}</div>`;

            if (q.stage === 1 || q.stage === 2) {
                // Tr·∫Øc nghi·ªám
                html += `<div class="options-grid">`;
                // Tr·ªôn ƒë√°p √°n hi·ªÉn th·ªã
                const opts = shuffle([...q.a]);
                opts.forEach(opt => {
                    html += `<div class="opt-btn" onclick="checkAnswer(this, '${opt}', '${q.correct}')">${opt}</div>`;
                });
                html += `</div>`;
            } else {
                // Nh·∫≠p li·ªáu
                html += `
                <div class="input-group">
                    <input type="text" class="input-ans" id="user-input" placeholder="Nh·∫≠p s·ªë/ƒë√°p √°n...">
                    <button class="btn-submit" onclick="checkInputAnswer('${q.ans.join('|')}')">X√°c nh·∫≠n</button>
                    <p style="font-size:0.8rem; color:#aaa; text-align:center"><i>*Nh·∫≠p s·ªë g·ªçn (V√≠ d·ª•: 25000 ho·∫∑c 25.000)</i></p>
                </div>
            `;
            }
            content.innerHTML = html;
        }

        function checkAnswer(btn, choice, correct) {
            // Ch·∫∑n click
            const allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(b => b.onclick = null);

            if (choice === correct) {
                playSound('correct');
                btn.classList.add('correct');
                addScore(gameData[currentQIdx].points);
                buildTowerStep();
            } else {
                playSound('wrong');
                btn.classList.add('wrong');
            }
            setTimeout(nextQ, 1500);
        }

        function checkInputAnswer(correctStr) {
            const input = document.getElementById('user-input');
            const userVal = input.value.trim();
            const correctArr = correctStr.split('|');
            const btn = document.querySelector('.btn-submit');

            // Disable
            input.disabled = true;
            btn.disabled = true;

            // So s√°nh (ch·∫•p nh·∫≠n nhi·ªÅu ƒë·ªãnh d·∫°ng trong correctArr)
            const isCorrect = correctArr.includes(userVal);

            if (isCorrect) {
                playSound('correct');
                input.style.borderColor = "var(--success)";
                input.style.color = "var(--success)";
                addScore(gameData[currentQIdx].points);
                buildTowerStep();
            } else {
                playSound('wrong');
                input.style.borderColor = "var(--danger)";
                input.value += " (Sai)";
            }
            setTimeout(nextQ, 2000);
        }

        function addScore(pts) {
            score += pts;
            const scoreEl = document.getElementById('current-score');
            scoreEl.innerText = score;
            // Hi·ªáu ·ª©ng nh·∫£y s·ªë
            scoreEl.style.transform = "scale(1.5)";
            setTimeout(() => scoreEl.style.transform = "scale(1)", 300);
        }

        function buildTowerStep() {
            const block = document.getElementById(`block-${currentQIdx}`);
            if (block) {
                block.classList.add('built');
                block.innerText = `+${gameData[currentQIdx].points}`;
            }
        }

        function nextQ() {
            currentQIdx++;
            renderQuestion();
        }

        // --- AUDIO & UTILS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, t); gainNode.gain.setValueAtTime(0.3, t);
                gainNode.gain.exponentialRampToValueAtTime(0.01, t + 0.6); osc.start(t); osc.stop(t + 0.6);
            } else {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(200, t); osc.frequency.linearRampToValueAtTime(100, t + 0.3);
                gainNode.gain.setValueAtTime(0.3, t); gainNode.gain.exponentialRampToValueAtTime(0.01, t + 0.3); osc.start(t); osc.stop(t + 0.3);
            }
        }

        function finishGame() {
            clearInterval(timerInterval);
            window.onbeforeunload = null;
            document.getElementById('game-ui').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            document.getElementById('final-time-text').innerText = document.getElementById('timer').innerText;

            const ref = db.ref('scores/Tuan_21');
            ref.once('value', (snap) => {
                let attempt = 1; const data = snap.val();
                if (data) { for (let id in data) { if (data[id].fullName === savedName && data[id].className === savedClass) attempt++; } }
                ref.push({
                    fullName: savedName,
                    className: savedClass,
                    schoolName: savedSchool || '---',
                    score: score,
                    duration: seconds,
                    attempt: attempt,
                    date: new Date().toLocaleString('vi-VN')
                }, () => {
                    let timeLeft = 5; const msg = document.getElementById('redirect-msg');
                    setInterval(() => { timeLeft--; msg.innerText = `ƒê√£ l∆∞u ƒëi·ªÉm! V·ªÅ trang ch·ªß sau ${timeLeft}s...`; if (timeLeft <= 0) location.href = 'index.html'; }, 1000);
                });
            });
        }

        function startTimer() {
            timerInterval = setInterval(() => { seconds++; const m = Math.floor(seconds / 60).toString().padStart(2, '0'); const s = (seconds % 60).toString().padStart(2, '0'); document.getElementById('timer').innerText = `${m}:${s}`; }, 1000);
        }

        initGame();
    </script>
</body>

</html>
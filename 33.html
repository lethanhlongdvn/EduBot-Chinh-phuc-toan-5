<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tam Giác Vàng - Tuần 33</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --gold: #ffd700; --dark-bg: #1a1a2e; --light-text: #e0e0e0; --accent: #ff9f1c; }
        body { font-family: 'Lexend', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; background: var(--dark-bg); color: var(--light-text); user-select: none; }
        .container { max-width: 750px; width: 100%; background: #16213e; padding: 30px; border-radius: 20px; border: 3px solid var(--gold); box-shadow: 0 0 25px rgba(255, 215, 0, 0.2); }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; color: var(--gold); font-weight: bold; border-bottom: 1px solid #0f3460; padding-bottom: 10px; }
        .question-box { background: #0f3460; border-radius: 15px; padding: 25px; margin-bottom: 25px; text-align: center; font-size: 1.2rem; line-height: 1.6; min-height: 120px; color: #fff; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .opt-btn { background: #e0e0e0; border: none; padding: 18px; border-radius: 12px; font-family: 'Lexend'; font-weight: 600; cursor: pointer; transition: 0.2s; color: #1a1a2e; font-size: 1.1rem; }
        .opt-btn:hover { background: var(--gold); transform: scale(1.03); }
        .input-area { display: flex; flex-direction: column; gap: 15px; }
        .text-input { padding: 18px; border-radius: 10px; border: 2px solid var(--gold); background: #fff; font-size: 1.5rem; text-align: center; font-family: 'Lexend'; font-weight: bold; }
        .submit-btn { background: var(--accent); color: white; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; text-transform: uppercase; box-shadow: 0 5px 0 #bf7100; }
        #toast { position: fixed; top: 30px; padding: 15px 40px; border-radius: 30px; font-weight: bold; z-index: 100; opacity: 0; transition: 0.3s; pointer-events: none; }
        .show-toast { opacity: 1 !important; top: 50px !important; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="container">
    <div class="header">
        <span id="stage-title">VÒNG 1: HÌNH HỌC</span>
        <span id="score-text">ĐIỂM: 0</span>
    </div>

    <div class="question-box" id="q-area">Đang tải thử thách...</div>
    <div id="action-area"></div>

    <div id="final-screen" class="hidden" style="text-align:center;">
        <h2 style="color:var(--gold);">HOÀN THÀNH THỬ THÁCH!</h2>
        <h1 id="total-points" style="font-size: 4.5rem; margin: 20px 0;">0</h1>
        <div id="rank-form" class="hidden">
            <input type="text" id="hs-name" style="width:80%; padding:15px; margin:5px; border-radius:8px;" placeholder="Tên học sinh...">
            <input type="text" id="hs-class" style="width:80%; padding:15px; margin:5px; border-radius:8px;" placeholder="Lớp...">
            <button class="submit-btn" style="width:85%; margin-top:10px;" onclick="saveResult()">LƯU KẾT QUẢ</button>
        </div>
        <button class="submit-btn" style="background:#4a4e69; box-shadow:0 5px 0 #22223b; margin-top:20px;" onclick="location.reload()">CHƠI LẠI</button>
    </div>
</div>

<script>
    let currentScore = 0;
    let currentStage = 1;
    let questionIndex = 0;
    let isEnded = false;

    const firebaseConfig = {
        apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
        authDomain: "gamhoctap.firebaseapp.com",
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gamhoctap"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

    // DỮ LIỆU ĐÃ ĐƯỢC SỬA LỖI SỐ MŨ (SỬ DỤNG UNICODE ² ³)
    const DATA_HINH_HOC = [
        {q: "Diện tích hình tam giác có đáy a và chiều cao h là:", opts: ["S = (a x h) : 2", "S = a + h", "S = a x h", "S = (a + h) x 2"], c: 0},
        {q: "Một hình lập phương có cạnh 2cm. Thể tích của nó là:", opts: ["4 cm³", "6 cm³", "8 cm³", "12 cm³"], c: 2},
        {q: "Diện tích một mặt hình lập phương là 9 cm². Thể tích hình đó là:", opts: ["27 cm³", "18 cm³", "81 cm³", "36 cm³"], c: 0},
        {q: "Thể tích hình hộp chữ nhật có 3 kích thước 5cm, 4cm, 3cm là:", opts: ["12 cm³", "60 cm³", "20 cm³", "94 cm³"], c: 1},
        {q: "Chu vi hình tròn có bán kính r = 5cm là:", opts: ["15,7 cm", "31,4 cm", "78,5 cm", "25 cm"], c: 1}
    ];

    const DATA_DO_LUONG = [
        {q: "3 m³ 5 dm³ bằng bao nhiêu m³?", opts: ["3,5 m³", "3,05 m³", "3,005 m³", "35 m³"], c: 2},
        {q: "Đổi đơn vị: 2,5 m² bằng bao nhiêu dm²?", opts: ["25 dm²", "250 dm²", "2500 dm²", "0,25 dm²"], c: 1},
        {q: "1 lít (l) tương ứng với giá trị nào sau đây?", opts: ["1 m³", "1 dm³", "1 cm³", "10 dm³"], c: 1},
        {q: "Đổi đơn vị: 1,2 m³ = ... dm³?", opts: ["12 dm³", "120 dm³", "1200 dm³", "12000 dm³"], c: 2},
        {q: "4,5 tấn bằng bao nhiêu kg?", opts: ["45 kg", "450 kg", "4500 kg", "45000 kg"], c: 2}
    ];

    const DATA_TI_SO = [
        {q: "Tìm 25% của 100:", a: "25"},
        {q: "Tỉ số phần trăm của 2 và 5 là bao nhiêu %? (Chỉ nhập số)", a: "40"},
        {q: "Lãi suất 0,5% một tháng. Gửi 1.000.000đ thì một tháng lãi bao nhiêu đồng?", a: "5000"}
    ];

    let v1 = shuffle([...DATA_HINH_HOC]).slice(0, 4);
    let v2 = shuffle([...DATA_DO_LUONG]).slice(0, 4);
    let v3 = shuffle([...DATA_TI_SO]).slice(0, 2);

    function startStage(s) {
        currentStage = s; questionIndex = 0;
        document.getElementById('stage-title').innerText = s === 1 ? "VÒNG 1: HÌNH HỌC" : (s === 2 ? "VÒNG 2: ĐO LƯỜNG" : "VÒNG 3: TỈ SỐ");
        showQ();
    }

    function showQ() {
        let list = currentStage === 1 ? v1 : (currentStage === 2 ? v2 : v3);
        let item = list[questionIndex];
        document.getElementById('q-area').innerHTML = `<b>Câu hỏi ${questionIndex+1}:</b><br>${item.q}`;
        
        let html = '';
        if(currentStage < 3) {
            html = '<div class="options-grid">';
            item.opts.forEach((o, i) => html += `<button class="opt-btn" onclick="checkAnswer(${i})">${o}</button>`);
            html += '</div>';
        } else {
            html = `<div class="input-area"><input type="text" id="user-input" class="text-input" placeholder="Nhập số..."><button class="submit-btn" onclick="checkInput()">XÁC NHẬN</button></div>`;
        }
        document.getElementById('action-area').innerHTML = html;
    }

    function checkAnswer(idx) {
        let item = currentStage === 1 ? v1[questionIndex] : v2[questionIndex];
        if(idx === item.c) { currentScore += 10; toast("CHÍNH XÁC! ✅", "#2ecc71"); }
        else { toast("SAI RỒI! ❌", "#e74c3c"); }
        updateScore();
        setTimeout(nextQ, 1000);
    }

    function checkInput() {
        let val = document.getElementById('user-input').value.trim();
        if(val === v3[questionIndex].a) { currentScore += 10; toast("XUẤT SẮC! ✅", "#2ecc71"); }
        else { toast("CHƯA ĐÚNG! ❌", "#e74c3c"); }
        updateScore();
        setTimeout(nextQ, 1000);
    }

    function nextQ() {
        questionIndex++;
        let list = currentStage === 1 ? v1 : (currentStage === 2 ? v2 : v3);
        if(questionIndex < list.length) showQ();
        else if(currentStage < 3) startStage(currentStage + 1);
        else finish();
    }

    function updateScore() { document.getElementById('score-text').innerText = "ĐIỂM: " + currentScore; }

    function toast(m, c) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.background = c; t.style.color = "#fff";
        t.classList.add('show-toast');
        setTimeout(() => t.classList.remove('show-toast'), 800);
    }

    function finish() {
        isEnded = true;
        document.getElementById('q-area').classList.add('hidden');
        document.getElementById('action-area').classList.add('hidden');
        document.getElementById('final-screen').classList.remove('hidden');
        document.getElementById('total-points').innerText = currentScore;
        if(currentScore >= 40) document.getElementById('rank-form').classList.remove('hidden');
    }

    function saveResult() {
        const n = document.getElementById('hs-name').value;
        const l = document.getElementById('hs-class').value;
        if(!n || !l) return;
        db.ref('ketqua/tuan33/' + Date.now()).set({ hoTen: n, lop: l, diemSo: currentScore, thoiGian: Date.now() })
        .then(() => { alert("Đã lưu kết quả!"); location.reload(); });
    }

    window.onload = () => startStage(1);
</script>
</body>
</html>
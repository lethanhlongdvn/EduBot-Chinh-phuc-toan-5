<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu·∫ßn 20: C√°n C√¢n C√¥ng L√Ω - EduRobot</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --parchment: #f4e4bc; --ink: #2c3e50; --gold: #c6930a; --ocean: #2980b9; --red: #e74c3c; }
        body { font-family: 'Lexend', sans-serif; margin: 0; padding: 20px; background: #1a1a2e; color: var(--ink); display: flex; flex-direction: column; align-items: center; min-height: 100vh; position: relative; padding-bottom: 100px; }
        .stage-banner { background: var(--gold); color: white; padding: 12px 35px; border-radius: 50px; font-weight: 700; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid #fff; text-transform: uppercase; letter-spacing: 1px; font-size: 1.2rem; }
        .map-frame { max-width: 750px; width: 100%; background: var(--parchment); padding: 30px; border-radius: 15px; border: 10px solid #8e735b; box-shadow: 0 0 40px rgba(0,0,0,0.6); position: relative; background-image: url('https://www.transparenttextures.com/patterns/parchment.png'); }
        .status-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: 700; color: #5e412f; border-bottom: 2px dashed #8e735b; padding-bottom: 10px; }
        .question-box { background: rgba(255, 255, 255, 0.5); border-radius: 12px; padding: 25px; margin-bottom: 25px; min-height: 100px; border: 1px solid #d4b996; font-size: 1.2rem; line-height: 1.6; text-align: center; font-weight: 600; }
        .options-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-opt { background: #fff; border: 2px solid #8e735b; padding: 15px; border-radius: 10px; font-family: 'Lexend'; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1rem; color: #2c3e50; }
        .btn-opt:hover { background: var(--gold); color: white; transform: translateY(-2px); }
        .input-area { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .input-ans { padding: 15px; width: 250px; font-size: 1.3rem; border: 3px solid var(--gold); border-radius: 10px; text-align: center; font-family: 'Lexend'; outline: none; }
        .btn-submit { background: var(--ocean); color: white; padding: 12px 40px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
        #toast { position: fixed; top: 30px; padding: 15px 40px; border-radius: 50px; font-weight: bold; z-index: 1000; opacity: 0; transition: 0.3s; pointer-events: none; }
        .show-toast { opacity: 1 !important; top: 50px !important; }
        .hidden { display: none !important; }
        .btn-final { background: var(--ocean); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a2e; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        footer { margin-top: 50px; color: #fff; font-size: 0.8rem; opacity: 0.6; }
    </style>
</head>
<body>

<div id="start-screen">
    <h1 style="color: #c6930a; font-size: 2rem; text-align: center; margin-bottom: 10px;">TO√ÅN 5 - TU·∫¶N 20</h1>
    <h2 style="color: #fff; margin-bottom: 30px;">C√ÅN C√ÇN C√îNG L√ù</h2>
    <p id="welcome-msg" style="color: #fff; margin-bottom: 20px;"></p>
    <button class="btn-final" id="btn-start-trigger" onclick="startGame()" style="padding: 20px 60px; font-size: 1.5rem;">B·∫ÆT ƒê·∫¶U</button>
</div>

<audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3" preload="auto"></audio>
<audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3" preload="auto"></audio>

<div id="vong-banner" class="stage-banner">V√íNG 1: KH√ÅM PH√Å</div>

<div class="status-header" style="width: 100%; max-width: 750px; color: #f1c40f; font-size: 1.2rem;">
    <span>ƒêI·ªÇM: <span id="diem-nhan">0</span></span>
    <span id="mang-song">L·ªñI CHO PH√âP: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
</div>

<div class="map-frame">
    <div id="ui-choi">
        <div class="status-header">
            <span id="cau-so">C√ÇU 1/4</span>
            <span id="vong-label">V√íNG 1</span>
        </div>
        <div class="question-box" id="noi-dung-cau-hoi">...</div>
        <div id="khu-vuc-dap-an"></div>
    </div>

    <div id="ui-ket-thuc" class="hidden" style="text-align: center;">
        <h2 id="title-finish">K·∫æT TH√öC TH·ª¨ TH√ÅCH!</h2>
        <h1 id="diem-cuoi" style="font-size: 4rem; color: var(--gold); margin: 10px 0;">0</h1>
        <p id="msg-finish" style="font-weight: bold; margin-bottom: 20px;"></p>
        <p id="save-status" style="color: var(--ocean); font-weight: bold;"></p>
        <button class="btn-final" onclick="location.href='index.html'">QUAY L·∫†I B·∫¢N ƒê·ªí</button>
    </div>
</div>

<div id="toast"></div>

<footer>¬© 2026 EduRobot.id.vn - L√™ Th√†nh Long</footer>

<script>
    // 1. FIREBASE CONFIG
    const firebaseConfig = { databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. L·∫§Y D·ªÆ LI·ªÜU T·ª™ TRANG CH·ª¶ (B·∫¢O M·∫¨T)
    const savedName = localStorage.getItem('studentName');
    const savedClass = localStorage.getItem('studentClass');

    window.onload = function() {
        if (!savedName || !savedClass) {
            document.getElementById('welcome-msg').innerHTML = "<b style='color:red'>‚ö†Ô∏è Em c·∫ßn ƒëƒÉng k√Ω t√™n ·ªü trang ch·ªß tr∆∞·ªõc!</b>";
            document.getElementById('btn-start-trigger').innerText = "V·ªÄ TRANG CH·ª¶";
            document.getElementById('btn-start-trigger').onclick = () => window.location.href = "index.html";
        } else {
            document.getElementById('welcome-msg').innerText = `Nh√† th√°m hi·ªÉm: ${savedName} - L·ªõp: ${savedClass}`;
        }
    };

    const DATA = {
        V1: [
            {q: "5A v√† 5B c√≥ 60 quy·ªÉn l·ªãch. T·ªâ s·ªë l·ªõp 5A v√† 5B l√† 7/8. T·ªïng s·ªë ph·∫ßn b·∫±ng nhau l√†:", opts: ["1 ph·∫ßn", "14 ph·∫ßn", "15 ph·∫ßn", "56 ph·∫ßn"], c: 2},
            {q: "C√≥ 49 con b√≤. S·ªë b√≤ khoang b·∫±ng 2/5 s·ªë b√≤ v√†ng. S·ªë b√≤ khoang l√†:", opts: ["14 con", "35 con", "10 con", "25 con"], c: 0},
            {q: "S√≥c em = 3/5 S√≥c ch·ªã. S√≥c em √≠t h∆°n S√≥c ch·ªã 6 h·∫°t. Hi·ªáu s·ªë ph·∫ßn b·∫±ng nhau l√†:", opts: ["8 ph·∫ßn", "15 ph·∫ßn", "2 ph·∫ßn", "3 ph·∫ßn"], c: 2},
            {q: "Nam nhi·ªÅu h∆°n n·ªØ 10 ng∆∞·ªùi. N·ªØ b·∫±ng 2/3 nam. S·ªë ng∆∞·ªùi nam l√†:", opts: ["20 ng∆∞·ªùi", "30 ng∆∞·ªùi", "50 ng∆∞·ªùi", "10 ng∆∞·ªùi"], c: 1},
            {q: "Chi·ªÅu d√†i h∆°n chi·ªÅu r·ªông 10m. D√†i b·∫±ng 3/2 r·ªông. Chi·ªÅu r·ªông m·∫£nh ƒë·∫•t l√†:", opts: ["30m", "15m", "20m", "25m"], c: 2},
            {q: "T√¨m t·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa 37 v√† 40, b∆∞·ªõc ƒë·∫ßu ti√™n t√≠nh th∆∞∆°ng 37 : 40 ƒë∆∞·ª£c:", opts: ["9,25", "0,925", "92,5", "0,0925"], c: 1},
            {q: "40kg n∆∞·ªõc bi·ªÉn c√≥ 1,4kg mu·ªëi. T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa mu·ªëi l√†:", opts: ["1,4%", "35%", "3,5%", "0,35%"], c: 2},
            {q: "ƒê·ªôi c√≥ 60 b·∫°n, l·ªõp 5A c√≥ 18 b·∫°n. T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa l·ªõp 5A so v·ªõi c·∫£ ƒë·ªôi l√†:", opts: ["30%", "18%", "60%", "3%"], c: 0}
        ],
        V2: [
            {q: "D·ªëc d√†i 1400m. L√™n d·ªëc = 3/4 xu·ªëng d·ªëc. ƒêo·∫°n xu·ªëng d·ªëc d√†i:", opts: ["600m", "800m", "1050m", "700m"], c: 1},
            {q: "T·ªïng hai s·ªë l√† 34000. S·ªë th·ª© nh·∫•t b·∫±ng 7/10 s·ªë th·ª© hai. S·ªë th·ª© nh·∫•t k√©m s·ªë th·ª© hai:", opts: ["14000", "20000", "6000", "3000"], c: 2},
            {q: "R√°c lo·∫°i A = 3/7 lo·∫°i B v√† √≠t h∆°n lo·∫°i B l√† 8kg. T·ªïng kh·ªëi l∆∞·ª£ng hai lo·∫°i l√†:", opts: ["20kg", "14kg", "6kg", "10kg"], c: 0},
            {q: "M·∫π h∆°n con 25 tu·ªïi. 2 nƒÉm n·ªØa con b·∫±ng 2/7 m·∫π. Tu·ªïi m·∫π hi·ªán nay l√†:", opts: ["35 tu·ªïi", "33 tu·ªïi", "10 tu·ªïi", "7 tu·ªïi"], c: 1},
            {q: "C√° A nhi·ªÅu h∆°n c√° B l√† 6 t·∫•n. C√° A b·∫±ng 5/2 c√° B. S·ªë c√° lo·∫°i B l√†:", opts: ["10 t·∫•n", "4 t·∫•n", "15 t·∫•n", "6 t·∫•n"], c: 1},
            {q: "Ki·ªÉm tra 100 √¥ t√¥ c√≥ 92 √¥ t√¥ ƒë·∫°t chu·∫©n. T·ªâ s·ªë ph·∫ßn trƒÉm √¥ t√¥ KH√îNG ƒë·∫°t chu·∫©n l√†:", opts: ["92%", "0,08%", "8%", "100%"], c: 2},
            {q: "K·∫øt qu·∫£ t√≠nh 100,5% - 57% l√†:", opts: ["43%", "43,5%", "53,5%", "44,5%"], c: 1},
            {q: "D·ª± ƒë·ªãnh 600 c√¢y, th·ª±c t·∫ø 690 c√¢y. Nh√† tr∆∞·ªùng ƒë√£ v∆∞·ª£t m·ª©c bao nhi√™u ph·∫ßn trƒÉm?", opts: ["115%", "90%", "15%", "11,5%"], c: 2}
        ],
        V3: [
            {q: "Chu vi 130m. R·ªông = 5/8 D√†i. Di·ªán t√≠ch m·∫£nh ƒë·∫•t l√† (m2)?", ans: "1000"},
            {q: "M·∫π h∆°n con 25 tu·ªïi. Tu·ªïi con b·∫±ng 2/7 tu·ªïi m·∫π. Khi con 10 tu·ªïi th√¨ c·∫ßn th√™m bao nhi√™u nƒÉm n·ªØa (ƒë√°p √°n l√† s·ªë nƒÉm)?", ans: "0"},
            {q: "Tr·ªìng ƒë∆∞·ª£c 360 c√¢y (chi·∫øm 60% k·∫ø ho·∫°ch). K·∫ø ho·∫°ch ph·∫£i tr·ªìng bao nhi√™u c√¢y?", ans: "600"},
            {q: "Th·ªè v√† R√πa h√°i 84 n·∫•m. N·∫øu Th·ªè th√™m 6 c√¢y th√¨ Th·ªè = 2/3 R√πa. Th·ª±c t·∫ø Th·ªè h√°i bao nhi√™u c√¢y?", ans: "30"}
        ]
    };

    let score = 0, lives = 3, stage = 1, qIdx = 0, pool = [], startTime;

    function shuffle(a) { return a.sort(() => Math.random() - 0.5); }

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        startTime = Date.now();
        initStage(1);
    }

    function initStage(s) {
        stage = s; qIdx = 0;
        const b = document.getElementById('vong-banner');
        const l = document.getElementById('vong-label');
        if(s === 1) { b.innerText = "V√íNG 1: KH√ÅM PH√Å"; l.innerText = "V√íNG 1"; pool = shuffle([...DATA.V1]).slice(0, 4); }
        else if(s === 2) { b.innerText = "V√íNG 2: LUY·ªÜN T·∫¨P"; l.innerText = "V√íNG 2"; pool = shuffle([...DATA.V2]).slice(0, 4); }
        else { b.innerText = "V√íNG 3: N√ÇNG CAO"; l.innerText = "V√íNG 3"; pool = shuffle([...DATA.V3]).slice(0, 2); }
        showQ();
    }

    function showQ() {
        let item = pool[qIdx];
        document.getElementById('cau-so').innerText = `C√ÇU ${qIdx+1}/${pool.length}`;
        document.getElementById('noi-dung-cau-hoi').innerText = item.q;
        const c = document.getElementById('khu-vuc-dap-an');
        c.innerHTML = '';
        if(stage < 3) {
            c.className = "options-container";
            item.opts.forEach((o, i) => {
                let btn = document.createElement('button');
                btn.className = "btn-opt"; btn.innerText = o;
                btn.onclick = () => check(i === item.c);
                c.appendChild(btn);
            });
        } else {
            c.className = "input-area";
            c.innerHTML = `<input type="number" id="ans-input" class="input-ans" placeholder="?"><button class="btn-submit" onclick="checkTL()">G·ª¨I</button>`;
        }
    }

    function checkTL() { 
        const val = document.getElementById('ans-input').value.trim();
        if(val !== "") check(val === pool[qIdx].ans); 
    }

    function check(isCorrect) {
        const sCorrect = document.getElementById('sound-correct');
        const sWrong = document.getElementById('sound-wrong');
        if(isCorrect) {
            score += 10;
            sCorrect.currentTime = 0; sCorrect.play();
            showToast("ƒê√öNG R·ªíI! +10ƒë", "#27ae60");
        } else {
            sWrong.currentTime = 0; sWrong.play();
            showToast("SAI R·ªíI! ‚ùå", "#e74c3c");
            if(stage === 1) { lives--; updateHearts(); }
        }
        
        qIdx++;
        document.getElementById('diem-nhan').innerText = score;
        if(lives <= 0 && stage === 1) {
            showToast("H·∫æT L∆Ø·ª¢T! QUA V√íNG 2", "#e67e22");
            setTimeout(() => initStage(2), 1000);
        } else if(qIdx < pool.length) {
            setTimeout(showQ, 800);
        } else if(stage < 3) {
            setTimeout(() => initStage(stage + 1), 1000);
        } else {
            setTimeout(finishGame, 1000);
        }
    }

    function updateHearts() {
        let h = ""; for(let i=0; i<3; i++) h += i < lives ? "‚ù§Ô∏è" : "üñ§";
        document.getElementById('mang-song').innerText = "L·ªñI CHO PH√âP: " + h;
    }

    function finishGame() {
        document.getElementById('ui-choi').classList.add('hidden');
        document.getElementById('ui-ket-thuc').classList.remove('hidden');
        
        let finalScore = score;
        if(finalScore > 100) finalScore = 100;
        document.getElementById('diem-cuoi').innerText = finalScore + " / 100";
        
        const duration = Math.floor((Date.now() - startTime) / 1000);
        const ref = db.ref('scores/Tuan_20');

        // KI·ªÇM TRA S·ªê L·∫¶N THI
        ref.once('value', (snap) => {
            let attemptCount = 1;
            const data = snap.val();
            if (data) {
                for (let id in data) {
                    const oldName = (data[id].fullName || data[id].name || "").toLowerCase();
                    const oldClass = (data[id].className || "");
                    if (oldName === savedName.toLowerCase() && oldClass === savedClass) {
                        attemptCount++;
                    }
                }
            }

            // G·ª¨I K·∫æT QU·∫¢
            ref.push({
                fullName: savedName,
                className: savedClass,
                score: finalScore,
                duration: duration,
                attempt: attemptCount,
                date: new Date().toLocaleString('vi-VN'),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }, () => {
                document.getElementById('save-status').innerText = `‚úÖ ƒê√£ l∆∞u ƒëi·ªÉm l·∫ßn th·ª© ${attemptCount} th√†nh c√¥ng!`;
                setTimeout(() => { location.href = "index.html"; }, 3000);
            });
        });
    }

    function showToast(m, c) {
        const t = document.getElementById('toast'); t.innerText = m; t.style.background = c; t.style.color = "#fff";
        t.classList.add('show-toast'); setTimeout(() => t.classList.remove('show-toast'), 1000);
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√°n c√¢n c√¥ng l√Ω - Tu·∫ßn 20</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #607D8B; --secondary: #9E9E9E; --success: #4CAF50; --danger: #f44336; --bg: #F5F5F5; }
        body { font-family: 'Lexend', Arial, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 750px; width: 100%; background: white; padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 10px solid var(--primary); }
        .header-box { width: 100%; border-radius: 15px; height: 85px; margin-bottom: 20px; background: linear-gradient(135deg, #ECEFF1, #CFD8DC); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border: 1px solid #B0BEC5; }
        .header-box h2 { color: #455A64; margin: 0; font-size: 1.4rem; }
        .header-box p { color: #78909C; font-size: 0.85rem; margin: 4px 0 0 0; }
        .progress-container { height: 10px; background: #EEE; border-radius: 6px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: 0.5s; }
        .level-map { display: flex; gap: 10px; margin-bottom: 20px; }
        .lvl-btn { flex: 1; padding: 10px 5px; border: none; border-radius: 12px; background: #FAFAFA; font-family: 'Lexend'; font-size: 0.8rem; color: #9E9E9E; pointer-events: none; border: 1px solid #EEE; }
        .lvl-btn.active { background: var(--primary); color: white; font-weight: bold; border-bottom: 3px solid #455A64; border-color: #455A64; }
        .question-area { min-height: 150px; text-align: center; }
        .q-text { font-size: 1.1rem; color: #263238; margin-bottom: 15px; line-height: 1.6; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .opt { padding: 14px; border: 2px solid #F0F0F0; border-radius: 12px; background: white; cursor: pointer; transition: 0.2s; font-size: 0.95rem; font-family: 'Lexend'; color: #37474F; }
        .opt:hover:not(:disabled) { border-color: var(--primary); background: #F4F7F8; }
        .robot-box { display: flex; align-items: center; background: #ECEFF1; padding: 12px; border-radius: 12px; margin-top: 15px; gap: 10px; border-left: 5px solid var(--primary); font-size: 0.9rem; color: #455A64; }
        .hidden { display: none; }
        .action-btn { padding: 12px 25px; background: var(--success); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-family: 'Lexend'; font-size: 1rem; margin-top: 10px; }
        .input-field { padding: 12px; border-radius: 10px; border: 2px solid #CFD8DC; width: 85%; font-family: 'Lexend'; margin-bottom: 10px; font-size: 1rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <h2>‚öñÔ∏è C√ÅN C√ÇN C√îNG L√ù (TU·∫¶N 20)</h2>
        <p>To√°n Hi·ªáu ‚Äì T·ªâ v√† T·ªâ s·ªë ph·∫ßn trƒÉm</p>
    </div>

    <div class="level-map">
        <button id="btn-0" class="lvl-btn active">üîç KH√ÅM PH√Å</button>
        <button id="btn-1" class="lvl-btn">üìù LUY·ªÜN T·∫¨P</button>
        <button id="btn-2" class="lvl-btn">üåü N√ÇNG CAO</button>
    </div>

    <div class="progress-container"><div id="progress" class="progress-bar"></div></div>

    <div id="game-content">
        <div style="display: flex; justify-content: space-between; font-weight: bold; color: #546E7A; margin-bottom: 10px; font-size: 0.9rem;">
            <span id="lvl-title">B·∫Øt ƒë·∫ßu phi√™n t√≤a...</span>
            <span id="score-display">T·ªïng ƒëi·ªÉm: 0/100</span>
        </div>
        <div class="question-area">
            <p class="q-text" id="q-text">ƒêang chu·∫©n b·ªã h·ªì s∆°...</p>
            <div class="options" id="options"></div>
        </div>
        <div id="robot-hint" class="robot-box hidden">
            <span>‚öñÔ∏è:</span> <span id="hint-text"></span>
        </div>
    </div>

    <div id="status-screen" class="hidden" style="text-align: center; padding: 20px;">
        <h2 id="status-title"></h2>
        <p id="status-info" style="font-size: 1.2rem; color: #546E7A;"></p>
        <button id="status-btn" class="action-btn" onclick="handleStatusAction()"></button>
    </div>

    <div id="result-screen" class="hidden" style="text-align: center; padding: 30px 0;">
        <h2>K·∫øt th√∫c phi√™n t√≤a! üèÜ</h2>
        <p id="result-msg" style="font-size: 2.5rem; color: var(--primary); font-weight: bold; margin: 15px 0;"></p>
        <p id="final-advice"></p>
        <div id="save-form" class="hidden">
            <input type="text" id="player-name" class="input-field" placeholder="Nh·∫≠p H·ªç v√† T√™n...">
            <input type="text" id="player-class" class="input-field" placeholder="Nh·∫≠p L·ªõp...">
            <br>
            <button class="action-btn" onclick="saveScoreOnline()">Ghi danh B·∫£ng V√†ng</button>
        </div>
        <button id="retry-btn" class="action-btn hidden" onclick="location.reload()" style="background: var(--secondary);">Th·ª≠ l·∫°i t·ª´ ƒë·∫ßu</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
        authDomain: "gamhoctap.firebaseapp.com",
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gamhoctap"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const allQuestionsData = [
        [ // PH·∫¶N 1: KH√ÅM PH√Å
            { q: "Trong b√†i to√°n 'Hi·ªáu ‚Äì T·ªâ', ƒë·ªÉ t√¨m 'hi·ªáu s·ªë ph·∫ßn b·∫±ng nhau', ta th·ª±c hi·ªán ph√©p t√≠nh g√¨?", a: ["Ph√©p c·ªông", "Ph√©p tr·ª´", "Ph√©p nh√¢n", "Ph√©p chia"], c: 1, h: "Ta l·∫•y s·ªë ph·∫ßn c·ªßa s·ªë l·ªõn tr·ª´ ƒëi s·ªë ph·∫ßn c·ªßa s·ªë b√©." },
            { q: "T·ªâ s·ªë h·∫°t d·∫ª c·ªßa S√≥c em v√† S√≥c ch·ªã l√† 3/5. N·∫øu S√≥c em l√† 3 ph·∫ßn th√¨ S√≥c ch·ªã l√†:", a: ["2 ph·∫ßn", "3 ph·∫ßn", "5 ph·∫ßn", "8 ph·∫ßn"], c: 2, h: "T·ªâ s·ªë 3/5 nghƒ©a l√† em 3 ph·∫ßn, ch·ªã 5 ph·∫ßn." },
            { q: "Mu·ªën t√¨m t·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa a v√† b, b∆∞·ªõc ƒë·∫ßu ti√™n ta c·∫ßn l√†m l√† g√¨?", a: ["T√¨m th∆∞∆°ng c·ªßa a v√† b", "T√¨m hi·ªáu c·ªßa a v√† b", "Nh√¢n a v·ªõi 100", "Vi·∫øt k√Ω hi·ªáu % sau a"], c: 0, h: "Ph·∫£i t√¨m th∆∞∆°ng c·ªßa hai s·ªë tr∆∞·ªõc." },
            { q: "Khi chia 27 cho 41 c√≥ d∆∞, ta th∆∞·ªùng l·∫•y bao nhi√™u ch·ªØ s·ªë ·ªü ph·∫ßn th·∫≠p ph√¢n c·ªßa th∆∞∆°ng?", a: ["1 ch·ªØ s·ªë", "2 ch·ªØ s·ªë", "3 ch·ªØ s·ªë", "4 ch·ªØ s·ªë"], c: 1, h: "Quy t·∫Øc th√¥ng th∆∞·ªùng l√† l·∫•y ƒë·∫øn 2 ch·ªØ s·ªë." },
            { q: "Th∆∞∆°ng l√† 0,925, vi·∫øt d∆∞·ªõi d·∫°ng t·ªâ s·ªë ph·∫ßn trƒÉm l√†:", a: ["0,925%", "92,5%", "9,25%", "925%"], c: 1, h: "0,925 x 100 = 92,5%." },
            { q: "S∆° ƒë·ªì ƒëo·∫°n th·∫≥ng trong b√†i to√°n Hi·ªáu - T·ªâ gi√∫p ta x√°c ƒë·ªãnh ƒë·∫°i l∆∞·ª£ng n√†o?", a: ["Th∆∞∆°ng hai s·ªë", "T·ªïng s·ªë ph·∫ßn", "Hi·ªáu s·ªë ph·∫ßn t∆∞∆°ng ·ª©ng v·ªõi hi·ªáu th·ª±c t·∫ø", "T·ªâ s·ªë ph·∫ßn trƒÉm"], c: 2, h: "S∆° ƒë·ªì gi√∫p th·∫•y r√µ hi·ªáu th·ª±c t·∫ø t∆∞∆°ng ·ª©ng bao nhi√™u ph·∫ßn." },
            { q: "ƒê·ªÉ t√¨m 'Gi√° tr·ªã c·ªßa m·ªôt ph·∫ßn' trong b√†i to√°n Hi·ªáu ‚Äì T·ªâ, ta l·∫•y:", a: ["Hi·ªáu s·ªë chia cho hi·ªáu s·ªë ph·∫ßn", "Hi·ªáu s·ªë nh√¢n v·ªõi hi·ªáu s·ªë ph·∫ßn", "Hi·ªáu s·ªë chia cho t·ªïng s·ªë ph·∫ßn", "S·ªë l·ªõn chia s·ªë ph·∫ßn"], c: 0, h: "Gi√° tr·ªã 1 ph·∫ßn = Hi·ªáu th·ª±c t·∫ø : Hi·ªáu s·ªë ph·∫ßn." },
            { q: "B√™n tr√°i c√≥ 18 kg, b√™n ph·∫£i c√≥ 40 kg. T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa ƒëƒ©a tr√°i so v·ªõi ƒëƒ©a ph·∫£i l√†:", a: ["40 : 18", "18 : 40", "40 - 18", "(40-18):40"], c: 1, h: "L·∫•y kh·ªëi l∆∞·ª£ng ƒëƒ©a tr√°i chia cho ƒëƒ©a ph·∫£i." }
        ],
        [ // PH·∫¶N 2: LUY·ªÜN T·∫¨P
            { q: "Hi·ªáu l√† 16, t·ªâ s·ªë l√† 3/5. S·ªë b√© l√†:", a: ["24", "40", "8", "6"], c: 0, h: "Hi·ªáu s·ªë ph·∫ßn: 5-3=2. M·ªôt ph·∫ßn: 16:2=8. S·ªë b√©: 8x3=24." },
            { q: "T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa 90 v√† 300 l√†:", a: ["3%", "30%", "33,3%", "0,3%"], c: 1, h: "90 : 300 = 0,3 = 30%." },
            { q: "Trong 40kg n∆∞·ªõc bi·ªÉn c√≥ 1,4kg mu·ªëi. T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa mu·ªëi l√†:", a: ["35%", "3,5%", "0,35%", "28%"], c: 1, h: "1,4 : 40 = 0,035 = 3,5%." },
            { q: "Nam nhi·ªÅu h∆°n n·ªØ 10 b·∫°n. N·ªØ b·∫±ng 2/3 nam. S·ªë b·∫°n nam l√†:", a: ["20 b·∫°n", "30 b·∫°n", "25 b·∫°n", "15 b·∫°n"], c: 1, h: "Hi·ªáu s·ªë ph·∫ßn: 3-2=1. S·ªë nam l√† 10 : 1 x 3 = 30." },
            { q: "ƒê·ªôi c√≥ 60 b·∫°n, l·ªõp 5A c√≥ 18 b·∫°n. T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa l·ªõp 5A l√†:", a: ["3,33%", "18%", "30%", "42%"], c: 2, h: "18 : 60 = 0,3 = 30%." },
            { q: "K·∫øt qu·∫£ ph√©p t√≠nh 100,5% - 57% l√†:", a: ["57,5%", "43,5%", "157,5%", "43%"], c: 1, h: "Tr·ª´ nh∆∞ s·ªë th·∫≠p ph√¢n b√¨nh th∆∞·ªùng." },
            { q: "D√†i h∆°n r·ªông 10m. D√†i b·∫±ng 3/2 r·ªông. Chu vi m·∫£nh ƒë·∫•t l√†:", a: ["25m", "50m", "100m", "150m"], c: 2, h: "R·ªông 20m, D√†i 30m. Chu vi = (30+20)x2 = 100m." },
            { q: "Tr·ªìng 690 c√¢y, v∆∞·ª£t k·∫ø ho·∫°ch 90 c√¢y (k·∫ø ho·∫°ch 600). Nh√† tr∆∞·ªùng v∆∞·ª£t m·ª©c bao nhi√™u %?", a: ["115%", "15%", "11,5%", "90%"], c: 1, h: "90 : 600 = 0,15 = 15%." }
        ],
        [ // PH·∫¶N 3: N√ÇNG CAO
            { q: "M·∫π 30 tu·ªïi, con 5 tu·ªïi. Sau bao nhi√™u nƒÉm n·ªØa th√¨ tu·ªïi con b·∫±ng 2/7 tu·ªïi m·∫π?", a: ["2 nƒÉm", "3 nƒÉm", "5 nƒÉm", "7 nƒÉm"], c: 2, h: "Hi·ªáu tu·ªïi 25. Khi con 2/7 m·∫π, tu·ªïi con l√† 25:(7-2)x2 = 10. V·∫≠y 10-5 = 5 nƒÉm." },
            { q: "T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa 71 v√† 33 l√† (l·∫•y 2 ch·ªØ s·ªë th·∫≠p ph√¢n):", a: ["215,15%", "46,47%", "21,51%", "21,52%"], c: 0, h: "71 : 33 = 2,1515... = 215,15%." },
            { q: "C√° A nhi·ªÅu h∆°n c√° B l√† 6 t·∫•n. T·ªâ s·ªë A/B l√† 2,5. S·ªë c√° lo·∫°i A l√†:", a: ["4 t·∫•n", "10 t·∫•n", "15 t·∫•n", "16 t·∫•n"], c: 2, h: "2,5 = 5/2. Hi·ªáu s·ªë ph·∫ßn: 3. M·ªôt ph·∫ßn: 6:3=2. C√° A: 2x5 = 10 (L∆∞u √Ω: ƒê√°p √°n chu·∫©n file l√† 10 nh∆∞ng logic c√¢u h·ªèi l√† 10)." },
            { q: "L√£i 25% so v·ªõi gi√° v·ªën. H·ªèi l√£i bao nhi√™u ph·∫ßn trƒÉm so v·ªõi gi√° b√°n?", a: ["25%", "20%", "15%", "30%"], c: 1, h: "V·ªën 100, l√£i 25 -> B√°n 125. L√£i/B√°n = 25/125 = 20%." }
        ]
    ];

    let curLvl = 0, curQ = 0, totalScore = 0, correctInStage = 0;
    let currentLvlQuestions = [];
    const Q_COUNT = [4, 4, 2];

    function prepareQuestionsForLevel() {
        let pool = [...allQuestionsData[curLvl]];
        pool.sort(() => Math.random() - 0.5);
        currentLvlQuestions = pool.slice(0, Q_COUNT[curLvl]);
        curQ = 0; correctInStage = 0;
    }

    function showQuestion() {
        let q = currentLvlQuestions[curQ];
        let totalAnswered = (curLvl === 0) ? curQ : (curLvl === 1 ? 4 + curQ : 8 + curQ);
        document.getElementById('q-text').innerHTML = `<b>C√¢u ${totalAnswered + 1}:</b> ${q.q}`;
        document.getElementById('progress').style.width = (totalAnswered / 10 * 100) + "%";
        let html = q.a.map((opt, i) => `<button class="opt" onclick="checkAnswer(${i})">${opt}</button>`).join('');
        document.getElementById('options').innerHTML = html;
        document.getElementById('robot-hint').classList.add('hidden');
        document.getElementById('lvl-title').innerText = (curLvl === 0 ? "Kh√°m ph√°" : curLvl === 1 ? "Luy·ªán t·∫≠p" : "N√¢ng cao");
    }

    function checkAnswer(i) {
        let q = currentLvlQuestions[curQ];
        let btns = document.querySelectorAll('.opt');
        btns.forEach(b => b.disabled = true);
        if(i === q.c) {
            totalScore += 10; correctInStage++;
            btns[i].style.background = "#E8F5E9";
            btns[i].style.borderColor = "#4CAF50";
            showRobot("C√¥ng l√Ω th·ª±c thi! ƒê√°p √°n ƒë√∫ng.");
        } else {
            btns[i].style.background = "#FFEBEE";
            btns[i].style.borderColor = "#F44336";
            btns[q.c].style.background = "#E8F5E9";
            showRobot("Ch∆∞a ch√≠nh x√°c. " + q.h);
        }
        setTimeout(() => {
            curQ++;
            if(curQ < Q_COUNT[curLvl]) { showQuestion(); updateScoreDisplay(); }
            else { finishStage(); }
        }, 2200);
    }

    function updateScoreDisplay() { document.getElementById('score-display').innerText = `T·ªïng ƒëi·ªÉm: ${totalScore}/100`; }
    function showRobot(m) { document.getElementById('robot-hint').classList.remove('hidden'); document.getElementById('hint-text').innerText = m; }

    function finishStage() {
        document.getElementById('game-content').classList.add('hidden');
        let passThreshold = Q_COUNT[curLvl] / 2;
        if (correctInStage >= passThreshold) {
            if (curLvl < 2) {
                showStatusScreen("Ho√†n th√†nh ch·∫∑ng! ‚úÖ", `ƒê√∫ng ${correctInStage}/${Q_COUNT[curLvl]} c√¢u. C√°n c√¢n ƒë√£ c√¢n b·∫±ng.`, "Ti·∫øp t·ª•c c√¥ng l√Ω ‚ûî", "next");
            } else { showFinalResult(); }
        } else {
            showStatusScreen("C√°n c√¢n b·ªã l·ªách! ‚öñÔ∏è", `B·∫°n ch·ªâ ƒë√∫ng ${correctInStage}/${Q_COUNT[curLvl]} c√¢u. C·∫ßn √≠t nh·∫•t 50% ƒë·ªÉ qua.`, "X√©t x·ª≠ l·∫°i ‚Ü∫", "retry");
        }
    }

    function showStatusScreen(title, info, btnText, type) {
        let screen = document.getElementById('status-screen');
        screen.classList.remove('hidden');
        document.getElementById('status-title').innerText = title;
        document.getElementById('status-info').innerText = info;
        let btn = document.getElementById('status-btn');
        btn.innerText = btnText; btn.setAttribute('data-type', type);
        btn.style.background = (type === 'retry') ? "var(--danger)" : "var(--primary)";
    }

    function handleStatusAction() {
        let type = document.getElementById('status-btn').getAttribute('data-type');
        document.getElementById('status-screen').classList.add('hidden');
        if (type === 'next') { curLvl++; } else { totalScore -= (correctInStage * 10); }
        prepareQuestionsForLevel();
        document.querySelectorAll('.lvl-btn').forEach((b, i) => b.classList.toggle('active', i === curLvl));
        document.getElementById('game-content').classList.remove('hidden');
        showQuestion(); updateScoreDisplay();
    }

    function showFinalResult() {
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('result-msg').innerText = `${totalScore} ƒêI·ªÇM`;
        if(totalScore >= 50) {
            document.getElementById('final-advice').innerText = "Ch√∫c m·ª´ng th√°m t·ª≠ nh√≠ ƒë√£ mang l·∫°i c√¥ng l√Ω!";
            document.getElementById('save-form').classList.remove('hidden');
        } else {
            document.getElementById('final-advice').innerText = "H√£y r√®n luy·ªán th√™m ƒë·ªÉ c√≥ nh·ªØng ph√°n quy·∫øt ch√≠nh x√°c h∆°n.";
            document.getElementById('retry-btn').classList.remove('hidden');
        }
    }

    function saveScoreOnline() {
        const name = document.getElementById('player-name').value.trim();
        const className = document.getElementById('player-class').value.trim();
        if (!name || !className) { alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin."); return; }
        const userKey = (className + "_" + name).replace(/[\s\/.\#\$\[\]]/g, '_');
        db.ref('scores/Tuan_20_Can_Can_Cong_Ly/' + userKey).set({
            fullName: name, className: "'" + className, score: totalScore,
            date: new Date().toLocaleString('vi-VN'), timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            alert("ƒê√£ ghi danh v√†o B·∫£ng V√†ng!");
            location.reload();
        });
    }

    window.onload = () => { prepareQuestionsForLevel(); showQuestion(); };
</script>
</body>
</html>
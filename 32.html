<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đấu Trường Số Thập Phân - Tuần 32</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --arena-gold: #f1c40f; --arena-red: #e74c3c; --arena-dark: #2c3e50; --arena-white: #ecf0f1; }
        body { font-family: 'Lexend', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; background: var(--arena-dark); color: var(--arena-white); user-select: none; }
        .game-container { max-width: 750px; width: 100%; background: #34495e; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 4px solid var(--arena-gold); }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 40px; border-radius: 50px; font-weight: bold; font-size: 1.2rem; z-index: 1000; transition: 0.3s; opacity: 0; pointer-events: none; border: 2px solid white; }
        .toast-show { opacity: 1 !important; top: 50px !important; }
        .screen { background: #1a252f; border-radius: 15px; padding: 25px; margin-bottom: 25px; border-bottom: 5px solid var(--arena-gold); min-height: 180px; }
        .screen-header { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--arena-gold); border-bottom: 1px solid #455a64; padding-bottom: 10px; margin-bottom: 15px; text-transform: uppercase; font-weight: bold; }
        .q-text { font-size: 1.2rem; line-height: 1.6; color: #fff; text-align: center; }
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 15px; width: 100%; max-width: 750px; font-weight: bold; color: var(--arena-gold); }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .opt-btn { background: #ecf0f1; border: none; padding: 18px; border-radius: 12px; font-family: 'Lexend'; font-weight: bold; cursor: pointer; transition: 0.2s; color: var(--arena-dark); font-size: 1.1rem; }
        .opt-btn:hover { background: var(--arena-gold); transform: translateY(-3px); }
        .input-area { display: flex; flex-direction: column; gap: 15px; }
        .ans-input { padding: 20px; border-radius: 12px; border: 3px solid var(--arena-gold); background: #fff; color: #2c3e50; font-size: 1.5rem; font-family: 'Lexend'; text-align: center; }
        .action-btn { background: var(--arena-red); color: white; padding: 15px 30px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1.2rem; box-shadow: 0 6px 0 #c0392b; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="status-bar">
    <span id="stage-name">VÒNG 1: KHỞI ĐỘNG</span>
    <span id="score-display">ĐIỂM SỐ: 0</span>
</div>

<div class="game-container">
    <div class="screen">
        <div class="screen-header">
            <span>ĐẤU TRƯỜNG TOÁN HỌC</span>
            <span id="lives-count">GIÁP BẢO VỆ: 3/3</span>
        </div>
        <div id="q-content" class="q-text">Đang tải câu hỏi...</div>
    </div>

    <div id="play-area"></div>

    <div id="result-screen" class="hidden" style="text-align: center;">
        <h2 style="color: var(--arena-gold);">KẾT QUẢ THI ĐẤU</h2>
        <h1 id="final-score" style="font-size: 4rem; color: #fff; margin: 15px 0;">0</h1>
        <div id="save-form" class="hidden">
            <input type="text" id="p-name" style="width:80%; padding:15px; margin:10px; border-radius:10px; border:none;" placeholder="Tên học sinh...">
            <input type="text" id="p-class" style="width:80%; padding:15px; margin:10px; border-radius:10px; border:none;" placeholder="Lớp...">
            <button class="action-btn" style="width:85%; margin-top:10px;" onclick="saveData()">LƯU KẾT QUẢ</button>
        </div>
        <button class="action-btn" style="background:#7f8c8d; margin-top:20px; box-shadow:0 6px 0 #2c3e50;" onclick="location.reload()">THỬ LẠI</button>
    </div>
</div>

<script>
    let isFinished = false;
    let score = 0;
    let stage = 1;
    let qIdx = 0;
    let lives = 3;

    // Firebase (Giữ nguyên cấu trúc của thầy)
    const firebaseConfig = {
        apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
        authDomain: "gamhoctap.firebaseapp.com",
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gamhoctap"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

    // NỘI DUNG ĐÃ LÀM SẠCH KÝ TỰ LẠ
    const POOL1 = [
        {q: "Phân số thập phân 317/100 viết dưới dạng số thập phân là:", opts: ["31,7", "3,17", "0,317", "317,0"], c: 1},
        {q: "Trong số 81,063 giá trị của chữ số 6 là:", opts: ["6 đơn vị", "6 phần mười", "6 phần trăm", "6 phần nghìn"], c: 2},
        {q: "Số 81,063 viết thành tổng các giá trị là:", opts: ["80 + 1 + 0,6 + 0,3", "80 + 1 + 0,06 + 0,003", "81 + 0,63", "80 + 1,063"], c: 1},
        {q: "Hỗn số 3 và 17/100 được viết thành số thập phân là:", opts: ["3,017", "3,17", "31,7", "317"], c: 1},
        {q: "Làm tròn số 27,62 đến hàng đơn vị, ta được số:", opts: ["27", "28", "27,6", "30"], c: 1},
        {q: "Phân số nào sau đây có thể viết thành phân số thập phân?", opts: ["1/3", "2/5", "1/7", "5/9"], c: 1},
        {q: "So sánh: 4,5 và 4,499", opts: ["4,5 > 4,499", "4,5 < 4,499", "4,5 = 4,499", "Không thể so sánh"], c: 0},
        {q: "Số tự nhiên lớn nhất có 5 chữ số là:", opts: ["10000", "99999", "90000", "99990"], c: 1}
    ];

    const POOL2 = [
        {q: "Tính nhẩm: 27,6 x 10 = ?", opts: ["2,76", "276", "2760", "0,276"], c: 1},
        {q: "Tính nhẩm: 432 x 0,1 = ?", opts: ["4,32", "43,2", "4320", "0,432"], c: 1},
        {q: "Kết quả của phép tính: 12,5 + 3,5 x 2 là:", opts: ["32", "19,5", "25", "28"], c: 1},
        {q: "Biểu thức (a + b) + c = a + (b + c) thể hiện tính chất:", opts: ["Giao hoán", "Kết hợp", "Phân phối", "Đặc biệt"], c: 1},
        {q: "Kết quả của 1/2 + 0,5 là:", opts: ["1/4", "1", "0,1", "1,5"], c: 1},
        {q: "Khi chia một số cho 0,5 ta có thể thực hiện:", opts: ["Nhân số đó với 2", "Chia số đó cho 2", "Nhân số đó với 0,5", "Trừ đi 0,5"], c: 0},
        {q: "Số thập phân nào bằng với số 0,7?", opts: ["0,07", "7/100", "0,700", "7/1"], c: 2},
        {q: "Hiệu của số 10 và số 2,5 là:", opts: ["8,5", "7,5", "6,5", "12,5"], c: 1}
    ];

    const POOL3 = [
        {q: "Một tivi giá 12 triệu, kệ tivi giá 2,5 triệu. Tổng chi phí là bao nhiêu triệu? (Nhập số)", a: "14.5"},
        {q: "Tính giá trị biểu thức: 10 - (2,5 + 3,5)", a: "4"},
        {q: "May 1 bộ đồ hết 3,2m vải. May 10 bộ như thế hết bao nhiêu mét vải?", a: "32"},
        {q: "Số trung bình cộng của 3,5 và 4,5 là:", a: "4"}
    ];

    let deV1 = shuffle([...POOL1]).slice(0, 4);
    let deV2 = shuffle([...POOL2]).slice(0, 4);
    let deV3 = shuffle([...POOL3]).slice(0, 2);

    function startStage(s) {
        stage = s; qIdx = 0;
        document.getElementById('stage-name').innerText = s === 1 ? "VÒNG 1: KHỞI ĐỘNG" : (s === 2 ? "VÒNG 2: ĐẤU TRƯỜNG" : "VÒNG 3: BẢN LĨNH");
        renderQ();
    }

    function renderQ() {
        let data = stage === 1 ? deV1 : (stage === 2 ? deV2 : deV3);
        let item = data[qIdx];
        document.getElementById('q-content').innerHTML = `<b>Câu hỏi ${qIdx+1}:</b><br>${item.q}`;
        
        let html = '';
        if(stage < 3) {
            html = '<div class="options-grid">';
            item.opts.forEach((o, i) => html += `<button class="opt-btn" onclick="check(${i})">${o}</button>`);
            html += '</div>';
        } else {
            html = `<div class="input-area"><input type="text" id="ans" class="ans-input" placeholder="Nhập đáp án..."><button class="action-btn" onclick="checkTuluan()">XÁC NHẬN</button></div>`;
        }
        document.getElementById('play-area').innerHTML = html;
    }

    function check(idx) {
        let item = (stage === 1) ? deV1[qIdx] : deV2[qIdx];
        if(idx === item.c) { score += 10; showToast("CHÍNH XÁC!", "#2ecc71"); } 
        else {
            showToast("SAI RỒI!", "#e74c3c");
            if(stage === 1) { 
                lives--; document.getElementById('lives-count').innerText = "GIÁP BẢO VỆ: "+lives+"/3";
                if(lives <= 0) { nextStage(); return; }
            }
        }
        updateScore();
        setTimeout(next, 1000);
    }

    function checkTuluan() {
        let userAns = document.getElementById('ans').value.trim().replace(',', '.');
        let correctAns = deV3[qIdx].a;
        if(userAns === correctAns || parseFloat(userAns) === parseFloat(correctAns)) { score += 10; showToast("QUÁ GIỎI!", "#2ecc71"); }
        else { showToast("CHƯA ĐÚNG!", "#e74c3c"); }
        updateScore();
        setTimeout(next, 1000);
    }

    function next() {
        qIdx++;
        let data = (stage === 1) ? deV1 : (stage === 2 ? deV2 : deV3);
        if(qIdx < data.length) renderQ();
        else nextStage();
    }

    function nextStage() {
        if(stage < 3) startStage(stage + 1);
        else finish();
    }

    function updateScore() { document.getElementById('score-display').innerText = "ĐIỂM SỐ: " + score; }

    function showToast(msg, bg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.background = bg;
        t.classList.add('toast-show');
        setTimeout(() => t.classList.remove('toast-show'), 800);
    }

    function finish() {
        isFinished = true;
        document.getElementById('play-area').innerHTML = '';
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = score;
        if(score >= 50) document.getElementById('save-form').classList.remove('hidden');
    }

    function saveData() {
        const name = document.getElementById('p-name').value;
        const cls = document.getElementById('p-class').value;
        if(!name || !cls) return;
        db.ref('ketqua/tuan32/' + Date.now()).set({ hoTen: name, lop: cls, diem: score, thoiGian: Date.now() })
        .then(() => { alert("Đã lưu kết quả!"); location.reload(); });
    }

    window.onload = () => { startStage(1); };
</script>
</body>
</html>
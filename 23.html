<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TU·∫¶N 23: TH√ÅM HI·ªÇM ƒê·∫†I D∆Ø∆†NG</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Lexend:wght@400;600;700&display=swap"
        rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --primary: #00a8ff;
            --dark: #192a56;
            --light: #dff9fb;
            --accent: #fbc531;
            --correct: #4cd137;
            --wrong: #e84118;
        }

        body {
            font-family: 'Lexend', sans-serif;
            background: linear-gradient(180deg, #487eb0 0%, #273c75 100%);
            color: white;
            margin: 0;
            padding: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            padding-bottom: 40px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            margin-bottom: 50px;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 15px;
            border: 2px solid var(--primary);
            text-align: center;
            margin-bottom: 15px;
            backdrop-filter: blur(5px);
        }

        .header h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--accent);
            text-transform: uppercase;
            font-family: 'Bungee';
            letter-spacing: 1px;
            text-shadow: 2px 2px 0 #000;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #fff;
            font-weight: 600;
            padding: 5px 10px;
            margin-top: 5px;
        }

        .ocean-stage {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            min-height: 300px;
            position: relative;
            overflow: hidden;
        }

        .bubble-decoration {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: floatUp 10s infinite linear;
            z-index: -1;
        }

        @keyframes floatUp {
            0% {
                bottom: -50px;
                opacity: 0;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                bottom: 100%;
                opacity: 0;
            }
        }

        .question-box {
            background: #fff;
            color: #2c3e50;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 0 #bdc3c7;
            line-height: 1.4;
        }

        .stage-label {
            color: var(--accent);
            font-family: 'Bungee';
            text-align: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .opt-btn {
            background: #34495e;
            border: 2px solid #2c3e50;
            padding: 15px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 60px;
        }

        .opt-btn:active {
            transform: scale(0.95);
        }

        .opt-btn.correct {
            background: var(--correct);
            border-color: #44bd32;
            box-shadow: 0 0 15px var(--correct);
        }

        .opt-btn.wrong {
            background: var(--wrong);
            border-color: #c23616;
            opacity: 0.5;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .input-ans {
            width: 80%;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--accent);
            background: #fff;
            color: #333;
            font-size: 1.2rem;
            text-align: center;
            outline: none;
        }

        .btn-submit {
            width: 80%;
            padding: 15px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1rem;
            text-transform: uppercase;
            box-shadow: 0 4px 0 #e1b12c;
        }

        .btn-submit:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .oxygen-tank {
            width: 100%;
            height: 10px;
            background: #333;
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
            border: 1px solid #555;
        }

        .oxygen-level {
            height: 100%;
            background: linear-gradient(90deg, #ff9f43, #ee5253);
            width: 0%;
            transition: width 0.5s;
        }

        #result-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .treasure-chest {
            font-size: 5rem;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        .final-score {
            font-size: 3rem;
            font-weight: bold;
            color: var(--accent);
            margin: 10px 0;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .hidden {
            display: none !important;
        }

        .game-footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #0c2461;
            padding: 8px 0;
            text-align: center;
            font-size: 0.65rem;
            color: #a4b0be;
            border-top: 1px solid #1e3799;
            z-index: 999;
        }

        sup {
            font-size: 0.7em;
            vertical-align: super;
        }
    </style>
</head>

<body>

    <div class="container" id="game-ui">
        <div class="header">
            <h1>TU·∫¶N 23: TH√ÅM HI·ªÇM ƒê·∫†I D∆Ø∆†NG</h1>
            <div class="info-bar">
                <span>‚öì <b id="user-name">---</b></span>
                <span>üèÜ <b id="current-score" style="color:var(--accent)">0</b>/100</span>
                <span>‚è± <b id="timer">00:00</b></span>
            </div>
        </div>

        <div class="ocean-stage">
            <div class="bubble-decoration" style="width:20px; height:20px; left:10%; animation-duration:8s;"></div>
            <div class="bubble-decoration" style="width:10px; height:10px; left:80%; animation-duration:12s;"></div>
            <div class="bubble-decoration" style="width:30px; height:30px; left:40%; animation-duration:15s;"></div>

            <div class="stage-label" id="stage-label">V√íNG 1: KH·ªûI ƒê·ªòNG</div>
            <div class="question-box" id="q-content">ƒêang t·∫£i d·ªØ li·ªáu...</div>

            <div id="interaction-area"></div>

            <div class="oxygen-tank">
                <div class="oxygen-level" id="progress-bar"></div>
            </div>
            <div style="text-align:right; font-size:0.7rem; color:#aaa; margin-top:5px">Ti·∫øn ƒë·ªô v√≤ng ch∆°i</div>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <div class="treasure-chest">üéÅ</div>
        <h2 style="color:var(--accent); font-family:'Bungee';">CHUY·∫æN ƒêI TH√ÄNH C√îNG!</h2>
        <div class="final-score" id="final-score">0</div>
        <p>Th·ªùi gian: <span id="final-time-text">--:--</span></p>
        <p id="save-msg" style="color:#2ecc71; font-weight:bold; margin-top:10px;">ƒêang l∆∞u k·∫øt qu·∫£...</p>
        <p id="redirect-msg" style="color:#bdc3c7; font-size:0.9rem;">T·ª± ƒë·ªông v·ªÅ trang ch·ªß...</p>
        <button class="btn-submit" onclick="location.reload()"
            style="width:auto; padding: 10px 30px; margin-top:20px;">Ch∆°i l·∫°i ngay</button>
    </div>

    <div class="game-footer">¬© 2026 EduRobot.id.vn - L√™ Th√†nh Long</div>

    <script>
        const firebaseConfig = { databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const savedName = localStorage.getItem('studentName');
        const savedClass = localStorage.getItem('studentClass');
        const savedSchool = localStorage.getItem('studentSchool');
        if (!savedName || !savedClass) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); window.location.href = "index.html"; }
        document.getElementById('user-name').innerText = savedName;

        window.addEventListener('beforeunload', function (e) {
            if (!document.getElementById('result-screen').classList.contains('hidden')) return;
            e.preventDefault(); e.returnValue = '';
        });

        const rawR1 = [
            { q: "XƒÉng-ti-m√©t kh·ªëi l√† th·ªÉ t√≠ch c·ªßa h√¨nh l·∫≠p ph∆∞∆°ng c√≥ c·∫°nh d√†i bao nhi√™u?", a: ["1 cm", "1 dm", "1 m", "10 cm"], c: "1 cm" },
            { q: "ƒê·ªÅ-xi-m√©t kh·ªëi l√† th·ªÉ t√≠ch c·ªßa h√¨nh l·∫≠p ph∆∞∆°ng c√≥ c·∫°nh d√†i 1 dm, ƒë√∫ng hay sai?", a: ["ƒê√∫ng", "Sai"], c: "ƒê√∫ng" },
            { q: "ƒê∆°n v·ªã m√©t kh·ªëi ƒë∆∞·ª£c vi·∫øt t·∫Øt l√† g√¨?", a: ["m¬≥", "dm¬≥", "cm¬≥", "m2"], c: "m¬≥" },
            { q: "Vi·∫øt s·ªë ƒëo: T√°m trƒÉm nƒÉm m∆∞∆°i xƒÉng-ti-m√©t kh·ªëi.", a: ["850 cm¬≥", "805 cm¬≥", "850 dm¬≥", "85 cm¬≥"], c: "850 cm¬≥" },
            { q: "ƒê·ªçc s·ªë ƒëo th·ªÉ t√≠ch sau: 4,2 dm¬≥", a: ["B·ªën ph·∫©y hai ƒë·ªÅ-xi-m√©t kh·ªëi", "B·ªën hai ƒë·ªÅ-xi-m√©t kh·ªëi", "B·ªën ph·∫©y hai m√©t kh·ªëi", "B·ªën ph·∫©y hai xƒÉng-ti-m√©t kh·ªëi"], c: "B·ªën ph·∫©y hai ƒë·ªÅ-xi-m√©t kh·ªëi" },
            { q: "Vi·∫øt s·ªë ƒëo: Kh√¥ng ph·∫©y ch√≠n m√©t kh·ªëi.", a: ["0,9 m¬≥", "0,09 m¬≥", "90 m¬≥", "0,9 dm¬≥"], c: "0,9 m¬≥" },
            { q: "ƒê·ªçc s·ªë ƒëo th·ªÉ t√≠ch sau: 3/4 m¬≥", a: ["Ba ph·∫ßn t∆∞ m√©t kh·ªëi", "Ba ph·∫ßn t∆∞ ƒë·ªÅ-xi-m√©t kh·ªëi", "Ba b·ªën m√©t kh·ªëi", "Ba ph·∫ßn b·ªën ƒë·ªÅ-xi-m√©t"], c: "Ba ph·∫ßn t∆∞ m√©t kh·ªëi" },
            { q: "1 h√¨nh l·∫≠p ph∆∞∆°ng c·∫°nh 1 cm c√≥ th·ªÉ t√≠ch 1 cm¬≥, v·∫≠y 10 h√¨nh nh∆∞ th·∫ø c√≥ th·ªÉ t√≠ch l√† bao nhi√™u?", a: ["10 cm¬≥", "100 cm¬≥", "1 cm¬≥", "10 dm¬≥"], c: "10 cm¬≥" },
            { q: "1 dm¬≥ b·∫±ng bao nhi√™u cm¬≥?", a: ["1.000", "100", "10", "10.000"], c: "1.000" },
            { q: "1 m¬≥ b·∫±ng bao nhi√™u dm¬≥?", a: ["1.000", "100", "1.000.000", "10"], c: "1.000" },
            { q: "1 cm¬≥ b·∫±ng m·ªôt ph·∫ßn bao nhi√™u c·ªßa dm¬≥?", a: ["1/1.000", "1/100", "1/10", "1/10.000"], c: "1/1.000" },
            { q: "ƒê∆°n v·ªã m√©t kh·ªëi th∆∞·ªùng d√πng ƒë·ªÉ ƒëo th·ªÉ t√≠ch c·ªßa v·∫≠t l·ªõn nh∆∞ b·ªÉ b∆°i, ƒë√∫ng hay sai?", a: ["ƒê√∫ng", "Sai"], c: "ƒê√∫ng" },
            { q: "Vi·∫øt s·ªë ƒëo: M∆∞·ªùi hai ph·∫©y nƒÉm ƒë·ªÅ-xi-m√©t kh·ªëi.", a: ["12,5 dm¬≥", "125 dm¬≥", "1,25 dm¬≥", "12,5 cm¬≥"], c: "12,5 dm¬≥" },
            { q: "1 m¬≥ b·∫±ng bao nhi√™u xƒÉng-ti-m√©t kh·ªëi?", a: ["1.000.000", "1.000", "10.000", "100.000"], c: "1.000.000" },
            { q: "ƒê·ªçc s·ªë ƒëo: 204 cm¬≥", a: ["Hai trƒÉm linh b·ªën xƒÉng-ti-m√©t kh·ªëi", "Hai trƒÉm b·ªën xƒÉng-ti-m√©t kh·ªëi", "Hai kh√¥ng b·ªën xƒÉng-ti-m√©t kh·ªëi", "Hai trƒÉm linh t∆∞ m√©t kh·ªëi"], c: "Hai trƒÉm linh b·ªën xƒÉng-ti-m√©t kh·ªëi" },
            { q: "S·ªë ƒëo 0,001 m¬≥ vi·∫øt d∆∞·ªõi d·∫°ng ph√¢n s·ªë th·∫≠p ph√¢n l√†:", a: ["1/1.000 m¬≥", "1/100 m¬≥", "1/10 m¬≥", "10/100 m¬≥"], c: "1/1.000 m¬≥" },
            { q: "H√¨nh l·∫≠p ph∆∞∆°ng c·∫°nh 1 m g·ªìm bao nhi√™u h√¨nh l·∫≠p ph∆∞∆°ng c·∫°nh 1 dm?", a: ["1.000", "100", "10", "10.000"], c: "1.000" },
            { q: "ƒê∆°n v·ªã ƒëo th·ªÉ t√≠ch n√†o l·ªõn h∆°n: m¬≥ hay dm¬≥?", a: ["m¬≥", "dm¬≥"], c: "m¬≥" },
            { q: "Vi·∫øt s·ªë: Hai trƒÉm ba m∆∞∆°i m√©t kh·ªëi.", a: ["230 m¬≥", "203 m¬≥", "23 m¬≥", "2300 m¬≥"], c: "230 m¬≥" },
            { q: "S·ªë ƒëo 1.000 cm¬≥ c√≥ th·ªÉ thay th·∫ø b·∫±ng ƒë∆°n v·ªã n√†o g·ªçn h∆°n?", a: ["1 dm¬≥", "1 m¬≥", "10 dm¬≥", "100 cm¬≥"], c: "1 dm¬≥" }
        ];

        // V2: Input (nhi·ªÅu ƒë√°p √°n)
        const rawR2 = [
            { q: "8 dm¬≥ = ... cm¬≥", c: ["8000", "8.000"] },
            { q: "15.000 cm¬≥ = ... dm¬≥", c: ["15"] },
            { q: "4,5 m¬≥ = ... dm¬≥", c: ["4500", "4.500"] },
            { q: "250 dm¬≥ = ... m¬≥", c: ["0,25", "0.25"] },
            { q: "0,7 dm¬≥ = ... cm¬≥", c: ["700"] },
            { q: "6.000.000 cm¬≥ = ... m¬≥", c: ["6"] },
            { q: "1/2 m¬≥ = ... dm¬≥", c: ["500"] },
            { q: "3 dm¬≥ 50 cm¬≥ = ... cm¬≥", c: ["3050", "3.050"] },
            { q: "1,2 m¬≥ = ... cm¬≥", c: ["1200000", "1.200.000"] },
            { q: "800 cm¬≥ = ... dm¬≥", c: ["0,8", "0.8"] },
            { q: "0,05 m¬≥ = ... dm¬≥", c: ["50"] },
            { q: "2.400 dm¬≥ = ... m¬≥", c: ["2,4", "2.4"] },
            { q: "1/4 dm¬≥ = ... cm¬≥", c: ["250"] },
            { q: "So s√°nh: 500 cm¬≥ ... 0,5 dm¬≥", c: ["=", "b·∫±ng", "b·∫±ng nhau"] },
            { q: "7,9 m¬≥ = ... dm¬≥", c: ["7900", "7.900"] },
            { q: "0,857 m¬≥ ƒë·ªçc l√†: (ghi ch·ªØ th∆∞·ªùng)", c: ["kh√¥ng ph·∫©y t√°m trƒÉm nƒÉm m∆∞∆°i b·∫£y m√©t kh·ªëi", "kh√¥ng ph·∫©y t√°m trƒÉm nƒÉm m∆∞∆°i b·∫£y"] },
            { q: "2 m¬≥ 5 dm¬≥ = ... dm¬≥", c: ["2005", "2.005"] },
            { q: "150 cm¬≥ = ... dm¬≥", c: ["0,15", "0.15"] },
            { q: "4/5 m¬≥ = ... dm¬≥", c: ["800"] },
            { q: "1,9 dm¬≥ = ... cm¬≥", c: ["1900", "1.900"] }
        ];

        const rawR3 = [
            { q: "T√≠nh: 15 cm¬≥ + 25 cm¬≥ (Ch·ªâ ghi s·ªë)", c: ["40"] },
            { q: "T√≠nh: 100 dm¬≥ ‚Äì 45 dm¬≥ (Ch·ªâ ghi s·ªë)", c: ["55"] },
            { q: "H√¨nh g·ªìm 12 h√¨nh l·∫≠p ph∆∞∆°ng 1 cm¬≥. Th·ªÉ t√≠ch l√† ... cm¬≥", c: ["12"] },
            { q: "T√≠nh: 12 m¬≥ x 3 (Ch·ªâ ghi s·ªë)", c: ["36"] },
            { q: "T√≠nh: 500 m¬≥ : 5 (Ch·ªâ ghi s·ªë)", c: ["100"] },
            { q: "So s√°nh 1 dm¬≥ v√† 900 cm¬≥. V·∫≠t n√†o l·ªõn h∆°n? (Ghi: 1 dm3 ho·∫∑c 900 cm3)", c: ["1 dm3", "1dm3", "v·∫≠t 1 dm3"] },
            { q: "B·ªÉ c√° ch·ª©a 2,5 m¬≥ n∆∞·ªõc. ƒê·ªïi sang dm¬≥:", c: ["2500", "2.500"] },
            { q: "T√≠nh: 2,5 dm¬≥ + 3,5 dm¬≥ (Ch·ªâ ghi s·ªë)", c: ["6", "6,0"] },
            { q: "T√≠nh: 8 m¬≥ ‚Äì 2.000 dm¬≥ = ... m¬≥", c: ["6"] },
            { q: "Th√πng xe 25 m¬≥, h√†ng chi·∫øm 60%. Ph·∫ßn tr·ªëng l√† ... m¬≥", c: ["10"] },
            { q: "180 cm¬≥ = ... dm¬≥", c: ["0,18"] },
            { q: "2 l·ªõp h√¨nh l·∫≠p ph∆∞∆°ng 1 cm¬≥, m·ªói l·ªõp 5 h√¨nh. V = ... cm¬≥", c: ["10"] },
            { q: "B·ªÉ b∆°i 15 m¬≥. ƒê·ªçc s·ªë ƒëo n√†y:", c: ["m∆∞·ªùi lƒÉm m√©t kh·ªëi", "15 m√©t kh·ªëi"] },
            { q: "0,5 dm¬≥ = ... cm¬≥", c: ["500"] },
            { q: "Hai h√¨nh c√≥ c√πng s·ªë l∆∞·ª£ng kh·ªëi l·∫≠p ph∆∞∆°ng 1 cm¬≥ th√¨ th·ªÉ t√≠ch th·∫ø n√†o?", c: ["b·∫±ng nhau", "nh∆∞ nhau"] },
            { q: "1 m¬≥ bƒÉng = ... dm¬≥", c: ["1000", "1.000"] },
            { q: "T√≠nh: 0,5 m¬≥ x 4 = ... m¬≥", c: ["2"] },
            { q: "2 l√≠t = ... dm¬≥", c: ["2"] },
            { q: "Trong 3 h·ªôp: 20cm¬≥, 22cm¬≥, 0,025dm¬≥. H·ªôp n√†o l·ªõn nh·∫•t? (Ghi s·ªë ƒëo)", c: ["0,025dm3", "0,025 dm3", "h·ªôp m√†u v√†ng"] },
            { q: "10 m¬≥ = ... dm¬≥", c: ["10000", "10.000"] }
        ];

        let gameData = [];
        let currentIndex = 0;
        let score = 0;
        let seconds = 0;
        let timerInterval;
        let stage2Mistakes = 0;

        function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

        function initGame() {
            // V1: 5 MC (6pts/q)
            const r1 = shuffle([...rawR1]).slice(0, 5).map(i => ({ ...i, stage: 1, type: 'mc', points: 6 }));

            // V2: 10 Input (4pts/q) - Converted to input logic
            const r2 = shuffle([...rawR2]).slice(0, 10).map(i => ({ ...i, stage: 2, type: 'input', points: 4 }));

            // V3: 5 Input (6pts/q)
            const r3 = shuffle([...rawR3]).slice(0, 5).map(i => ({ ...i, stage: 3, type: 'input', points: 6 }));

            gameData = [...r1, ...r2, ...r3];
            currentIndex = 0;
            score = 0;
            stage2Mistakes = 0;
            startTimer();
            renderQuestion();
        }

        function renderQuestion() {
            if (currentIndex >= gameData.length) { finishGame(); return; }

            const q = gameData[currentIndex];
            document.getElementById('q-content').innerHTML = q.q.replace(/m3/g, "m¬≥").replace(/dm3/g, "dm¬≥").replace(/cm3/g, "cm¬≥");
            document.getElementById('stage-label').innerText = `V√íNG ${q.stage}: C√ÇU ${currentIndex + 1}/${gameData.length} (L·ªói V2: ${(q.stage === 2 ? stage2Mistakes : 0)}/3)`;

            const pct = ((currentIndex) / gameData.length) * 100;
            document.getElementById('progress-bar').style.width = pct + "%";

            const area = document.getElementById('interaction-area');
            area.innerHTML = '';

            if (q.type === 'mc') {
                let html = `<div class="options-grid">`;
                shuffle([...q.a]).forEach(opt => {
                    html += `<div class="opt-btn" onclick="checkMC(this, '${opt}', '${q.c}')">${opt}</div>`;
                });
                html += `</div>`;
                area.innerHTML = html;
            } else {
                area.innerHTML = `
                <div class="input-group">
                    <input type="text" class="input-ans" id="user-input" placeholder="Nh·∫≠p ƒë√°p √°n..." autocomplete="off">
                    <button class="btn-submit" onclick="checkInput()">N·∫†P D·ªÆ LI·ªÜU</button>
                    <p style="font-size:0.8rem; color:#fff"><i>(C√≥ th·ªÉ vi·∫øt kh√¥ng d·∫•u, s·ªë th·∫≠p ph√¢n d√πng d·∫•u ph·∫©y ho·∫∑c ch·∫•m)</i></p>
                </div>
            `;
                // Enter key check
                document.getElementById('user-input').addEventListener("keypress", function (event) {
                    if (event.key === "Enter") checkInput();
                });
            }
        }

        function checkMC(btn, choice, correct) {
            document.querySelectorAll('.opt-btn').forEach(b => b.onclick = null);

            if (choice === correct) {
                playSound('correct');
                btn.classList.add('correct');
                score += gameData[currentIndex].points;
            } else {
                playSound('wrong');
                btn.classList.add('wrong');
                document.querySelectorAll('.opt-btn').forEach(b => {
                    if (b.innerText === correct) b.classList.add('correct');
                });
            }
            updateScore();
            setTimeout(nextQ, 1500);
        }

        function checkInput() {
            const input = document.getElementById('user-input');
            const btn = document.querySelector('.btn-submit');
            const val = input.value.trim().toLowerCase();
            const correctArr = gameData[currentIndex].c.map(s => s.toLowerCase());

            if (!val) return; // Prevent empty submit
            input.disabled = true; btn.disabled = true;

            if (correctArr.includes(val)) {
                playSound('correct');
                input.style.borderColor = "var(--correct)";
                input.style.backgroundColor = "#dff9fb";
                score += gameData[currentIndex].points;
            } else {
                playSound('wrong');
                input.style.borderColor = "var(--wrong)";
                input.value += ` ‚ùå (ƒê√∫ng: ${correctArr[0]})`;

                // Mistake handling V2
                if (gameData[currentIndex].stage === 2) {
                    stage2Mistakes++;
                    if (stage2Mistakes >= 3) {
                        alert("B·∫°n ƒë√£ sai 3 l·∫ßn ·ªü V√≤ng 2! Chuy·ªÉn ngay sang V√≤ng 3.");
                        while (currentIndex < gameData.length && gameData[currentIndex].stage === 2) {
                            currentIndex++;
                        }
                        setTimeout(renderQuestion, 500);
                        return;
                    }
                }
            }
            updateScore();
            setTimeout(nextQ, 2000);
        }

        function updateScore() {
            const el = document.getElementById('current-score');
            el.innerText = score + "/100";
            el.style.transform = "scale(1.5)";
            setTimeout(() => el.style.transform = "scale(1)", 200);
        }

        function nextQ() {
            if (gameData[currentIndex] && gameData[currentIndex].stage === 2 && stage2Mistakes >= 3) return;
            currentIndex++;
            renderQuestion();
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);

            if (type === 'correct') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(440, t); osc.frequency.exponentialRampToValueAtTime(880, t + 0.1);
                gain.gain.setValueAtTime(0.3, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
                osc.start(t); osc.stop(t + 0.5);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); osc.frequency.linearRampToValueAtTime(100, t + 0.2);
                gain.gain.setValueAtTime(0.3, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.4);
                osc.start(t); osc.stop(t + 0.4);
            }
        }

        function finishGame() {
            clearInterval(timerInterval);
            document.querySelector('.ocean-stage').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            document.getElementById('final-time-text').innerText = document.getElementById('timer').innerText;

            const ref = db.ref('scores/Tuan_23');
            ref.once('value', (snap) => {
                let attempt = 1; const data = snap.val();
                if (data) { for (let id in data) { if ((data[id].fullName || "").toLowerCase() === savedName.toLowerCase()) attempt++; } }
                ref.push({
                    fullName: savedName,
                    className: savedClass,
                    schoolName: savedSchool || '---',
                    score: score,
                    duration: seconds,
                    attempt: attempt,
                    date: new Date().toLocaleString('vi-VN')
                }, () => {
                    document.getElementById('save-msg').innerText = "ƒê√£ l∆∞u k·∫øt qu·∫£ th√†nh c√¥ng!";
                    let c = 5;
                    const rEl = document.getElementById('redirect-msg');
                    setInterval(() => {
                        c--; rEl.innerText = `T·ª± ƒë·ªông v·ªÅ trang ch·ªß sau ${c}s...`;
                        if (c <= 0) window.location.href = "index.html";
                    }, 1000);
                });
            });
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        initGame();
    </script>
</body>

</html>
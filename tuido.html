<script>
    const firebaseConfig = {
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // DANH SÃCH Váº¬T PHáº¨M Äáº¦Y Äá»¦ Tá»ª TUáº¦N 19 Äáº¾N 35
    const ITEMS_DATA = {
        19: { name: "á»ng nhÃ²m táº§m xa", icon: "ğŸ”­", table: "19", deadline: "2026-01-17" },
        20: { name: "CÃ¢n tiá»ƒu ly", icon: "âš–ï¸", table: "20", deadline: "2026-01-24" },
        21: { name: "MÃ¡y tÃ­nh bá» tÃºi", icon: "ğŸ“Ÿ", table: "21", deadline: "2026-01-31" },
        22: { name: "Báº£n Ä‘á»“ HÃ  Ná»™i", icon: "ğŸ—ºï¸", table: "22", deadline: "2026-02-07" },
        23: { name: "ThÆ°á»›c cuá»™n", icon: "ğŸ“", table: "23", deadline: "2026-02-28" },
        24: { name: "MÅ© kiáº¿n trÃºc sÆ°", icon: "ğŸ—ï¸", table: "24", deadline: "2026-03-07" },
        25: { name: "Há»™p quÃ  xá»© Huáº¿", icon: "ğŸ", table: "25", deadline: "2026-03-14" },
        26: { name: "Äá»“ng há»“ cÃ¡t", icon: "â³", table: "26", deadline: "2026-03-21" },
        27: { name: "Com-pa báº¡c", icon: "ğŸ“", table: "27", deadline: "2026-03-28" },
        28: { name: "BÃ¡nh lÃ¡i tÃ u", icon: "ğŸ¡", table: "28", deadline: "2026-04-04" },
        29: { name: "ÄÃ¨n pin nÄƒng lÆ°á»£ng", icon: "ğŸ”¦", table: "29", deadline: "2026-04-11" },
        30: { name: "TÃ²a thÃ¡p Bitexco", icon: "ğŸ¢", table: "30", deadline: "2026-04-18" },
        31: { name: "La bÃ n sá»‘", icon: "ğŸ§­", table: "31", deadline: "2026-04-25" },
        32: { name: "VÃ© tÃ u cao tá»‘c", icon: "ğŸ«", table: "32", deadline: "2026-05-02" },
        33: { name: "MÅ© tai bÃ¨o thÃ¡m hiá»ƒm", icon: "ğŸ‘’", table: "33", deadline: "2026-05-09" },
        34: { name: "Cá» lá»‡nh vá» Ä‘Ã­ch", icon: "ğŸš©", table: "34", deadline: "2026-05-16" },
        35: { name: "HuÃ¢n chÆ°Æ¡ng vinh quang", icon: "ğŸ–ï¸", table: "35", deadline: "2026-05-23" }
    };

    const currentStudent = localStorage.getItem('studentName');

    async function loadInventory() {
        if (!currentStudent) {
            alert("Vui lÃ²ng nháº­p tÃªn táº¡i báº£n Ä‘á»“!");
            window.location.href = "index.html";
            return;
        }
        document.getElementById('student-name').innerText = currentStudent;

        let medals = { gold: 0, silver: 0, bronze: 0 };
        const itemContainer = document.getElementById('item-list');
        itemContainer.innerHTML = '';

        for (let week in ITEMS_DATA) {
            const item = ITEMS_DATA[week];
            // Truy váº¥n vÃ o báº£ng scores/{sá»‘ tuáº§n} Ä‘Ãºng nhÆ° tháº§y Ä‘áº·t á»Ÿ báº£n Ä‘á»“
            const snapshot = await db.ref(`scores/${item.table}`).once('value');
            const scores = snapshot.val();

            let unlocked = false;
            let medalThisWeek = "";

            if (scores) {
                let results = Object.values(scores).filter(s => (s.fullName === currentStudent || s.name === currentStudent));
                if (results.length > 0) {
                    results.sort((a, b) => b.score - a.score);
                    const topScore = results[0].score;
                    const timestamp = results[0].timestamp || Date.now();
                    const deadlineDate = new Date(item.deadline + "T23:59:59");

                    if (topScore >= 50) unlocked = true;

                    // TÃ­nh huy chÆ°Æ¡ng dá»±a trÃªn Ä‘iá»ƒm sá»‘
                    if (new Date(timestamp) <= deadlineDate) {
                        if (topScore === 100) { medals.gold++; medalThisWeek = "ğŸ¥‡"; }
                        else if (topScore >= 80) { medals.silver++; medalThisWeek = "ğŸ¥ˆ"; }
                        else if (topScore >= 50) { medals.bronze++; medalThisWeek = "ğŸ¥‰"; }
                    }
                }
            }

            const card = document.createElement('div');
            card.className = `item-card ${unlocked ? 'unlocked' : ''}`;
            card.innerHTML = `
                <span class="icon">${unlocked ? item.icon : 'ğŸ”’'}</span>
                <div class="name">${unlocked ? item.name : 'ChÆ°a nháº­n'}</div>
                <div class="status">${unlocked ? 'ÄÃƒ NHáº¬N ' + medalThisWeek : 'Tuáº§n ' + week}</div>
            `;
            itemContainer.appendChild(card);
        }

        document.getElementById('gold-count').innerText = medals.gold;
        document.getElementById('silver-count').innerText = medals.silver;
        document.getElementById('bronze-count').innerText = medals.bronze;
    }

    loadInventory();
</script>
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TU·∫¶N 22: X√ÇY TH√ÅP TRI TH·ª®C</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Lexend:wght@400;600;700&display=swap"
        rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --p: #FF9800;
            --s: #2196F3;
            --bg: #0f172a;
            --card: #1e293b;
            --success: #2ecc71;
            --danger: #e74c3c;
            --gold: #ffd700;
            --brick: #e67e22;
        }

        body {
            font-family: 'Lexend', sans-serif;
            background: var(--bg);
            color: white;
            margin: 0;
            padding: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            padding-bottom: 40px;
        }

        .container {
            max-width: 900px;
            width: 100%;
            margin-bottom: 50px;
        }

        /* HEADER */
        .header {
            background: var(--card);
            padding: 8px;
            border-radius: 12px;
            border-bottom: 3px solid var(--p);
            text-align: center;
            margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--p);
            text-transform: uppercase;
            font-family: 'Bungee';
            letter-spacing: 1px;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #94a3b8;
            font-weight: 600;
            padding: 5px 10px;
        }

        /* LAYOUT GAME: Chia 2 c·ªôt tr√™n Desktop, 1 c·ªôt tr√™n Mobile */
        .game-layout {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            justify-content: center;
        }

        .question-area {
            flex: 2;
            background: var(--card);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #334155;
            min-height: 250px;
            position: relative;
        }

        .tower-area {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 10px;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            min-height: 300px;
            border-bottom: 5px solid #555;
            position: relative;
        }

        @media (max-width: 600px) {
            .game-layout {
                flex-direction: column-reverse;
                align-items: stretch;
            }

            .tower-area {
                min-height: 150px;
                flex-direction: row;
                justify-content: center;
                align-items: flex-end;
                gap: 2px;
                overflow-x: auto;
            }

            .tower-block {
                width: 15px !important;
                height: 40px !important;
                margin: 0 !important;
            }

            .tower-roof {
                width: 30px !important;
            }
        }

        /* VISUAL TH√ÅP */
        .tower-base {
            width: 100%;
            height: 10px;
            background: #555;
            border-radius: 2px;
            margin-top: 5px;
        }

        .tower-block {
            width: 80%;
            height: 25px;
            background: var(--brick);
            margin-bottom: 2px;
            border-radius: 4px;
            border: 2px solid #d35400;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            transform: translateY(50px) scale(0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.3);
        }

        .tower-block.built {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .tower-block.stage-1 {
            background: #7f8c8d;
            border-color: #2c3e50;
        }

        /* M√≥ng m√†u x√°m */
        .tower-block.stage-2 {
            background: #e67e22;
            border-color: #d35400;
        }

        /* Th√¢n m√†u cam */
        .tower-block.stage-3 {
            background: #f1c40f;
            border-color: #f39c12;
            box-shadow: 0 0 10px var(--gold);
        }

        /* ƒê·ªânh v√†ng */

        /* C√ÇU H·ªéI */
        .stage-badge {
            position: absolute;
            top: -10px;
            left: 10px;
            background: var(--p);
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .q-text {
            font-size: 1.1rem;
            margin: 20px 0;
            line-height: 1.5;
            font-weight: 600;
            text-align: justify;
        }

        /* N√öT B·∫§M */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .opt-btn {
            background: #334155;
            border: 2px solid #475569;
            padding: 15px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1rem;
        }

        .opt-btn:hover {
            background: #475569;
        }

        .opt-btn.correct {
            background: var(--success);
            border-color: var(--success);
            color: #000;
            font-weight: bold;
            animation: pulse 0.5s;
        }

        .opt-btn.wrong {
            background: var(--danger);
            border-color: var(--danger);
            opacity: 0.5;
        }

        .feedback-text {
            margin-top: 15px;
            padding: 10px;
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid #2ecc71;
            color: #2ecc71;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            animation: fadeIn 0.5s;
            font-size: 1.1rem;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* INPUT V√íNG 3 (D·ª± ph√≤ng) */
        .input-group {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        .input-ans {
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--p);
            background: #0f172a;
            color: white;
            font-size: 1.1rem;
            outline: none;
            text-align: center;
        }

        .btn-submit {
            padding: 15px;
            background: var(--p);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            text-transform: uppercase;
        }

        /* RESULT */
        #result-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .score-box {
            font-size: 3rem;
            font-weight: bold;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            margin: 20px 0;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .hidden {
            display: none !important;
        }

        .game-footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #0f172a;
            padding: 8px 0;
            text-align: center;
            font-size: 0.65rem;
            color: #64748b;
            border-top: 1px solid #334155;
            z-index: 999;
        }
    </style>
</head>

<body>

    <div class="container" id="game-ui">
        <div class="header">
            <h1>TU·∫¶N 22: X√ÇY TH√ÅP TRI TH·ª®C</h1>
            <div class="info-bar">
                <span>üë§ <b id="user-name">---</b></span>
                <span>‚≠ê <b id="current-score" style="color:var(--gold)">0</b>/100</span>
                <span>‚è± <b id="timer">00:00</b></span>
            </div>
        </div>

        <div class="game-layout">
            <div class="question-area" id="q-area">
                <div class="stage-badge" id="stage-badge">V√íNG 1: M√ìNG V·ªÆNG CH·∫ÆC</div>
                <div id="q-content">
                </div>
            </div>

            <div class="tower-area" id="tower-visual">
                <div class="tower-base"></div>
            </div>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <h2 style="color:var(--gold); font-family:'Bungee';">C√îNG TR√åNH HO√ÄN TH√ÄNH</h2>
        <div class="score-box" id="final-score">0</div>
        <p>Th·ªùi gian: <span id="final-time-text">--:--</span></p>
        <p style="color:#aaa" id="redirect-msg">ƒêang l∆∞u ƒëi·ªÉm...</p>
        <button class="btn-submit" onclick="location.reload()"
            style="margin-top:20px; width:auto; padding: 10px 30px;">L√†m l·∫°i ƒë·ªÅ m·ªõi</button>
    </div>

    <div class="game-footer">
        @ 2026 EduRobot.id.vn - L√™ Th√†nh Long
    </div>

    <script>
        // --- C·∫§U H√åNH & D·ªÆ LI·ªÜU ---
        const firebaseConfig = { databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const savedName = localStorage.getItem('studentName');
        const savedClass = localStorage.getItem('studentClass');
        if (!savedName || !savedClass) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); window.location.href = "index.html"; }
        document.getElementById('user-name').innerText = savedName;
        window.onbeforeunload = () => "ƒêang l√†m b√†i...";

        // DATA V√íNG 1 (M·ªói c√¢u 8 ƒëi·ªÉm - TR·∫ÆC NGHI·ªÜM)
        const poolR1 = [
            { q: "Vi·∫øt t·ªâ s·ªë 6/10 d∆∞·ªõi d·∫°ng t·ªâ s·ªë ph·∫ßn trƒÉm.", a: ["60%", "6%", "600%", "10%"], correct: "60%" },
            { q: "T·ªâ s·ªë 17/20 ƒë∆∞·ª£c vi·∫øt d∆∞·ªõi d·∫°ng t·ªâ s·ªë ph·∫ßn trƒÉm l√† bao nhi√™u?", a: ["85%", "17%", "20%", "75%"], correct: "85%" },
            { q: "Ch·ªçn c√°ch vi·∫øt t·ªâ s·ªë ph·∫ßn trƒÉm ph√π h·ª£p cho t·ªâ s·ªë 25/50.", a: ["50%", "25%", "2%", "5%"], correct: "50%" },
            { q: "T·ªâ s·ªë 12/100 t∆∞∆°ng ·ª©ng v·ªõi t·ªâ s·ªë ph·∫ßn trƒÉm n√†o?", a: ["12%", "1,2%", "120%", "100%"], correct: "12%" },
            { q: "Tr√™n b·∫£n ƒë·ªì t·ªâ l·ªá 1 : 2.000, ƒë·ªô d√†i 2 cm tr√™n b·∫£n ƒë·ªì ·ª©ng v·ªõi ƒë·ªô d√†i th·∫≠t l√† bao nhi√™u xƒÉng-ti-m√©t?", a: ["4.000 cm", "2.000 cm", "1.000 cm", "400 cm"], correct: "4.000 cm" },
            { q: "4.000 cm b·∫±ng bao nhi√™u m√©t?", a: ["40 m", "4 m", "400 m", "0,4 m"], correct: "40 m" },
            { q: "Tr√™n b·∫£n ƒë·ªì t·ªâ l·ªá 1 : 500.000, ƒë·ªô d√†i th·∫≠t 10 km ·ª©ng v·ªõi bao nhi√™u xƒÉng-ti-m√©t tr√™n b·∫£n ƒë·ªì?", a: ["2 cm", "5 cm", "10 cm", "50 cm"], correct: "2 cm" },
            { q: "T√≠nh 10% c·ªßa s·ªë 60.", a: ["6", "60", "0,6", "600"], correct: "6" },
            { q: "T√≠nh 50% c·ªßa s·ªë 36.", a: ["18", "72", "3,6", "9"], correct: "18" },
            { q: "T√≠nh 2% c·ªßa s·ªë 250.", a: ["5", "25", "2,5", "50"], correct: "5" },
            { q: "T√≠nh 11% c·ªßa s·ªë 200.", a: ["22", "11", "20", "220"], correct: "22" },
            { q: "T√¨m t·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa hai s·ªë 49 v√† 70.", a: ["70%", "49%", "7%", "4,9%"], correct: "70%" },
            { q: "T√¨m t·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa hai s·ªë 37,8 v√† 45.", a: ["84%", "37,8%", "45%", "8,4%"], correct: "84%" },
            { q: "C√≥ 1,5 kg t√°o b·ªã s√¢u trong th√πng 30 kg. T·ªâ l·ªá l√†:", a: ["5%", "15%", "50%", "0,5%"], correct: "5%" },
            { q: "T·ªâ l·ªá s√¢u 5%, th√πng 80 kg c√≥ bao nhi√™u t√°o s√¢u?", a: ["4 kg", "40 kg", "5 kg", "8 kg"], correct: "4 kg" },
            { q: "TV 15.000.000ƒë, gi·∫£m 8%. S·ªë ti·ªÅn gi·∫£m l√†:", a: ["1.200.000 ƒë·ªìng", "1.500.000 ƒë·ªìng", "800.000 ƒë·ªìng", "120.000 ƒë·ªìng"], correct: "1.200.000 ƒë·ªìng" },
            { q: "Sau khi gi·∫£m 8%, gi√° TV 15 tri·ªáu c√≤n:", a: ["13.800.000 ƒë·ªìng", "14.000.000 ƒë·ªìng", "13.500.000 ƒë·ªìng", "14.200.000 ƒë·ªìng"], correct: "13.800.000 ƒë·ªìng" },
            { q: "T·ªâ s·ªë n·∫•m Th·ªè v√† R√πa l√† 2/5. T·ªïng s·ªë ph·∫ßn b·∫±ng nhau l√†:", a: ["7 ph·∫ßn", "3 ph·∫ßn", "10 ph·∫ßn", "5 ph·∫ßn"], correct: "7 ph·∫ßn" },
            { q: "T·ªïng 84 n·∫•m, t·ªâ s·ªë 2/5. S·ªë n·∫•m Th·ªè h√°i l√†:", a: ["24 c√¢y", "60 c√¢y", "12 c√¢y", "28 c√¢y"], correct: "24 c√¢y" },
            { q: "Hi·ªáu 6 k·∫πo, t·ªâ s·ªë 5/2. Hi·ªáu s·ªë ph·∫ßn b·∫±ng nhau l√†:", a: ["3 ph·∫ßn", "7 ph·∫ßn", "2 ph·∫ßn", "5 ph·∫ßn"], correct: "3 ph·∫ßn" }
        ];

        // DATA V√íNG 2 (M·ªói c√¢u 6 ƒëi·ªÉm - TR·∫ÆC NGHI·ªÜM)
        const poolR2 = [
            { q: "T·ªâ l·ªá b·∫£n ƒë·ªì 1 : 1.000 c√≥ nghƒ©a l√† g√¨?", a: ["ƒê·ªô d√†i th·∫≠t g·∫•p 1.000 l·∫ßn ƒë·ªô d√†i b·∫£n ƒë·ªì", "ƒê·ªô d√†i b·∫£n ƒë·ªì g·∫•p 1.000 l·∫ßn ƒë·ªô d√†i th·∫≠t", "C·∫£ hai b·∫±ng nhau", "ƒê·ªô d√†i th·∫≠t b·∫±ng 1/1000 b·∫£n ƒë·ªì"], correct: "ƒê·ªô d√†i th·∫≠t g·∫•p 1.000 l·∫ßn ƒë·ªô d√†i b·∫£n ƒë·ªì" },
            { q: "T·ªâ l·ªá 1 : 10.000.000, 1 cm b·∫£n ƒë·ªì b·∫±ng bao nhi√™u km th·ª±c t·∫ø?", a: ["100 km", "10 km", "1.000 km", "1 km"], correct: "100 km" },
            { q: "T·ªâ l·ªá 1 : 10.000.000, 5 cm b·∫£n ƒë·ªì b·∫±ng bao nhi√™u th·ª±c t·∫ø?", a: ["500 km", "50 km", "5.000 km", "5 km"], correct: "500 km" },
            { q: "T√¨m 20% c·ªßa 150 kg.", a: ["30 kg", "20 kg", "15 kg", "3 kg"], correct: "30 kg" },
            { q: "T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa 12 v√† 40 l√†:", a: ["30%", "40%", "12%", "3%"], correct: "30%" },
            { q: "40 h·ªçc sinh gi·ªèi chi·∫øm 25% c·∫£ kh·ªëi. T√≠nh c·∫£ kh·ªëi.", a: ["160 h·ªçc sinh", "100 h·ªçc sinh", "200 h·ªçc sinh", "120 h·ªçc sinh"], correct: "160 h·ªçc sinh" },
            { q: "Ho√†n ti·ªÅn 10% cho h√≥a ƒë∆°n 1 tri·ªáu. S·ªë ti·ªÅn ho√†n l√†:", a: ["100.000 ƒë·ªìng", "10.000 ƒë·ªìng", "1.000 ƒë·ªìng", "50.000 ƒë·ªìng"], correct: "100.000 ƒë·ªìng" },
            { q: "G·ª≠i 50 tri·ªáu, l√£i 8%/nƒÉm. Ti·ªÅn l√£i l√†:", a: ["4.000.000 ƒë·ªìng", "400.000 ƒë·ªìng", "5.000.000 ƒë·ªìng", "800.000 ƒë·ªìng"], correct: "4.000.000 ƒë·ªìng" },
            { q: "Vi·∫øt t·ªâ s·ªë 3/4 d∆∞·ªõi d·∫°ng ph·∫ßn trƒÉm.", a: ["75%", "25%", "34%", "43%"], correct: "75%" },
            { q: "T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa 0,6 v√† 2 l√†:", a: ["30%", "3%", "60%", "20%"], correct: "30%" },
            { q: "50 xe, 46 xe xu·∫•t b·∫øn. T·ªâ l·ªá xu·∫•t b·∫øn l√†:", a: ["92%", "90%", "85%", "46%"], correct: "92%" },
            { q: "T√≠nh 70% c·ªßa 120 m¬≤.", a: ["84 m¬≤", "70 m¬≤", "12 m¬≤", "8,4 m¬≤"], correct: "84 m¬≤" },
            { q: "T√≠nh 24,5% c·ªßa 2 kg.", a: ["0,49 kg", "0,48 kg", "4,9 kg", "1 kg"], correct: "0,49 kg" },
            { q: "T√≠nh 0,8% c·ªßa 15.000.000 ƒë·ªìng.", a: ["120.000 ƒë·ªìng", "150.000 ƒë·ªìng", "80.000 ƒë·ªìng", "1.200.000 ƒë·ªìng"], correct: "120.000 ƒë·ªìng" },
            { q: "Th·ªãt b√≤ 18% ƒë·∫°m. 250 g th·ªãt b√≤ c√≥ bao nhi√™u ƒë·∫°m?", a: ["45 g", "18 g", "25 g", "90 g"], correct: "45 g" },
            { q: "C√° ch√©p 17% ƒë·∫°m. 200 g c√° ch√©p c√≥ bao nhi√™u ƒë·∫°m?", a: ["34 g", "17 g", "30 g", "40 g"], correct: "34 g" },
            { q: "300 ng∆∞·ªùi, 40% √°o ƒë·ªè. S·ªë ng∆∞·ªùi √°o ƒë·ªè:", a: ["120 ng∆∞·ªùi", "40 ng∆∞·ªùi", "30 ng∆∞·ªùi", "150 ng∆∞·ªùi"], correct: "120 ng∆∞·ªùi" },
            { q: "300 ng∆∞·ªùi, 25% √°o v√†ng. S·ªë ng∆∞·ªùi √°o v√†ng:", a: ["75 ng∆∞·ªùi", "25 ng∆∞·ªùi", "30 ng∆∞·ªùi", "100 ng∆∞·ªùi"], correct: "75 ng∆∞·ªùi" },
            { q: "T·ªâ l·ªá 1:500, th·ª±c t·∫ø 15m. B·∫£n ƒë·ªì l√†:", a: ["3 cm", "30 cm", "15 cm", "5 cm"], correct: "3 cm" },
            { q: "T·ªâ l·ªá 1:3.000, th·ª±c t·∫ø 1500m. B·∫£n ƒë·ªì l√†:", a: ["50 cm", "5 cm", "500 cm", "5 m"], correct: "50 cm" }
        ];

        // DATA V√íNG 3 (M·ªói c√¢u 10 ƒëi·ªÉm - ƒê√£ chuy·ªÉn sang TR·∫ÆC NGHI·ªÜM ƒë·ªÉ d·ªÖ thao t√°c)
        const poolR3 = [
            { q: "H√¨nh h·ªôp ch·ªØ nh·∫≠t c√≥ bao nhi√™u k√≠ch th∆∞·ªõc?", a: ["3 k√≠ch th∆∞·ªõc", "2 k√≠ch th∆∞·ªõc", "4 k√≠ch th∆∞·ªõc", "6 k√≠ch th∆∞·ªõc"], correct: "3 k√≠ch th∆∞·ªõc" },
            { q: "H√¨nh h·ªôp ch·ªØ nh·∫≠t c√≥ bao nhi√™u m·∫∑t?", a: ["6 m·∫∑t", "4 m·∫∑t", "8 m·∫∑t", "12 m·∫∑t"], correct: "6 m·∫∑t" },
            { q: "Hai m·∫∑t n·∫±m ƒë·ªëi di·ªán nhau c·ªßa h√¨nh h·ªôp ch·ªØ nh·∫≠t ƒë∆∞·ª£c g·ªçi l√† g√¨?", a: ["Hai m·∫∑t ƒë√°y", "Hai m·∫∑t b√™n", "Hai m·∫∑t ph·∫≥ng", "Hai m·∫∑t vu√¥ng"], correct: "Hai m·∫∑t ƒë√°y" },
            { q: "B·ªën m·∫∑t c√≤n l·∫°i c·ªßa h√¨nh h·ªôp ch·ªØ nh·∫≠t ƒë∆∞·ª£c g·ªçi l√† g√¨?", a: ["C√°c m·∫∑t b√™n", "C√°c m·∫∑t ƒë√°y", "C√°c m·∫∑t tr√™n", "C√°c m·∫∑t ch√©o"], correct: "C√°c m·∫∑t b√™n" },
            { q: "H√¨nh l·∫≠p ph∆∞∆°ng c√≥ c√°c m·∫∑t l√† h√¨nh g√¨?", a: ["H√¨nh vu√¥ng b·∫±ng nhau", "H√¨nh ch·ªØ nh·∫≠t", "H√¨nh thoi", "H√¨nh tr√≤n"], correct: "H√¨nh vu√¥ng b·∫±ng nhau" },
            { q: "H√¨nh l·∫≠p ph∆∞∆°ng c√≥ bao nhi√™u m·∫∑t?", a: ["6 m·∫∑t", "4 m·∫∑t", "8 m·∫∑t", "12 m·∫∑t"], correct: "6 m·∫∑t" },
            { q: "N·∫øu h√¨nh A n·∫±m ho√†n to√†n trong h√¨nh B, ta n√≥i g√¨ v·ªÅ th·ªÉ t√≠ch c·ªßa ch√∫ng?", a: ["Th·ªÉ t√≠ch A b√© h∆°n th·ªÉ t√≠ch B", "Th·ªÉ t√≠ch A l·ªõn h∆°n th·ªÉ t√≠ch B", "Th·ªÉ t√≠ch b·∫±ng nhau", "Kh√¥ng so s√°nh ƒë∆∞·ª£c"], correct: "Th·ªÉ t√≠ch A b√© h∆°n th·ªÉ t√≠ch B" },
            { q: "H√¨nh C g·ªìm 4 kh·ªëi, h√¨nh D c≈©ng g·ªìm 4 kh·ªëi l·∫≠p ph∆∞∆°ng nh∆∞ th·∫ø. So s√°nh th·ªÉ t√≠ch.", a: ["Th·ªÉ t√≠ch b·∫±ng nhau", "Th·ªÉ t√≠ch C l·ªõn h∆°n", "Th·ªÉ t√≠ch D l·ªõn h∆°n", "Kh√¥ng b·∫±ng nhau"], correct: "Th·ªÉ t√≠ch b·∫±ng nhau" },
            { q: "H√¨nh P (8 kh·ªëi) t√°ch th√†nh M (6 kh·ªëi) v√† N (2 kh·ªëi). So s√°nh P v·ªõi M+N.", a: ["B·∫±ng nhau", "P l·ªõn h∆°n", "P b√© h∆°n", "Kh√°c nhau"], correct: "B·∫±ng nhau" },
            { q: "ƒê·ªÉ so s√°nh th·ªÉ t√≠ch hai h√¨nh h·ªôp ch·ªØ nh·∫≠t, R√¥-b·ªët d√πng c√°ch g√¨?", a: ["X·∫øp kh·ªëi l·∫≠p ph∆∞∆°ng v√†o r·ªìi ƒë·∫øm", "C√¢n tr·ªçng l∆∞·ª£ng", "ƒêo chi·ªÅu cao", "Nh√∫ng v√†o n∆∞·ªõc"], correct: "X·∫øp kh·ªëi l·∫≠p ph∆∞∆°ng v√†o r·ªìi ƒë·∫øm" },
            { q: "M·ªôt h√¨nh g·ªìm 2 l·ªõp, m·ªói l·ªõp c√≥ 6 h√¨nh l·∫≠p ph∆∞∆°ng nh·ªè. T·ªïng s·ªë h√¨nh l√†:", a: ["12 h√¨nh", "8 h√¨nh", "10 h√¨nh", "6 h√¨nh"], correct: "12 h√¨nh" },
            { q: "M·ªôt h√¨nh g·ªìm 2 l·ªõp, m·ªói l·ªõp c√≥ 9 h√¨nh l·∫≠p ph∆∞∆°ng nh·ªè. T·ªïng s·ªë h√¨nh l√†:", a: ["18 h√¨nh", "11 h√¨nh", "20 h√¨nh", "9 h√¨nh"], correct: "18 h√¨nh" },
            { q: "D·ª±a v√†o C√¢u 11 v√† 12, h√¨nh n√†o c√≥ th·ªÉ t√≠ch l·ªõn h∆°n?", a: ["H√¨nh 18 kh·ªëi", "H√¨nh 12 kh·ªëi", "B·∫±ng nhau", "Kh√¥ng bi·∫øt"], correct: "H√¨nh 18 kh·ªëi" },
            { q: "H√¨nh l·∫≠p ph∆∞∆°ng c·∫°nh 1 cm c√≥ th·ªÉ t√≠ch ƒë∆∞·ª£c g·ªçi l√† g√¨?", a: ["1 cm¬≥", "1 m¬≥", "1 dm¬≥", "1 mm¬≥"], correct: "1 cm¬≥" },
            { q: "M·ªôt h√¨nh ƒë∆∞·ª£c gh√©p t·ª´ 8 h√¨nh l·∫≠p ph∆∞∆°ng nh·ªè c·∫°nh 1 cm. Th·ªÉ t√≠ch h√¨nh ƒë√≥ l√†:", a: ["8 cm¬≥", "1 cm¬≥", "4 cm¬≥", "16 cm¬≥"], correct: "8 cm¬≥" },
            { q: "N·∫øu th√°o r·ªùi 8 h√¨nh l·∫≠p ph∆∞∆°ng c·ªßa m·ªôt h√¨nh l·ªõn r·ªìi x·∫øp th√†nh hai h√¨nh m·ªõi, t·ªïng th·ªÉ t√≠ch c√≥ thay ƒë·ªïi kh√¥ng?", a: ["Kh√¥ng thay ƒë·ªïi", "TƒÉng l√™n", "Gi·∫£m ƒëi", "Tuy bi·∫øn"], correct: "Kh√¥ng thay ƒë·ªïi" },
            { q: "H√¨nh h·ªôp ch·ªØ nh·∫≠t x·∫øp b·ªüi 4 h√¨nh l·∫≠p ph∆∞∆°ng nh·ªè (1cm) theo h√†ng ngang. Chi·ªÅu d√†i l√†:", a: ["4 cm", "1 cm", "2 cm", "8 cm"], correct: "4 cm" },
            { q: "N·∫øu hai h√¨nh c√≥ h√¨nh d·∫°ng kh√°c nhau nh∆∞ng c√πng s·ªë l∆∞·ª£ng kh·ªëi l·∫≠p ph∆∞∆°ng ƒë∆°n v·ªã th√¨ th·ªÉ t√≠ch th·∫ø n√†o?", a: ["B·∫±ng nhau", "Kh√°c nhau", "H√¨nh d√†i h∆°n l·ªõn h∆°n", "H√¨nh tr√≤n l·ªõn h∆°n"], correct: "B·∫±ng nhau" },
            { q: "H√¨nh h·ªôp ch·ªØ nh·∫≠t c√≥ m·∫•y m·∫∑t ƒë√°y?", a: ["2 m·∫∑t ƒë√°y", "4 m·∫∑t ƒë√°y", "6 m·∫∑t ƒë√°y", "1 m·∫∑t ƒë√°y"], correct: "2 m·∫∑t ƒë√°y" },
            { q: "ƒê∆°n v·ªã ƒëo th·ªÉ t√≠ch th∆∞·ªùng g·∫∑p l√† g√¨?", a: ["cm¬≥, dm¬≥, m¬≥", "m, km, cm", "kg, g, t·∫°", "m¬≤, cm¬≤, km¬≤"], correct: "cm¬≥, dm¬≥, m¬≥" }
        ];

        // --- LOGIC GAME ---
        let gameData = [];
        let currentQIdx = 0;
        let score = 0;
        let seconds = 0;
        let timerInterval;

        function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

        function initGame() {
            // L·∫•y ƒë·ªÅ ng·∫´u nhi√™n: 5 c√¢u R1, 5 c√¢u R2, 3 c√¢u R3
            const r1 = shuffle([...poolR1]).slice(0, 5).map(i => ({ ...i, stage: 1, points: 8 }));
            const r2 = shuffle([...poolR2]).slice(0, 5).map(i => ({ ...i, stage: 2, points: 6 }));
            const r3 = shuffle([...poolR3]).slice(0, 3).map(i => ({ ...i, stage: 3, points: 10 }));

            gameData = [...r1, ...r2, ...r3];
            currentQIdx = 0;
            score = 0;

            // T·∫°o visual th√°p r·ªóng (13 t·∫ßng)
            const tower = document.getElementById('tower-visual');
            tower.innerHTML = '<div class="tower-base"></div>';
            for (let i = 0; i < 13; i++) {
                const block = document.createElement('div');
                block.className = 'tower-block';
                block.id = `block-${i}`;
                if (i < 5) block.classList.add('stage-1');
                else if (i < 10) block.classList.add('stage-2');
                else block.classList.add('stage-3');
                tower.appendChild(block);
            }

            renderQuestion();
            startTimer();
        }

        function renderQuestion() {
            if (currentQIdx >= gameData.length) { finishGame(); return; }

            const q = gameData[currentQIdx];
            const badge = document.getElementById('stage-badge');
            const content = document.getElementById('q-content');

            if (q.stage === 1) badge.innerText = "V√íNG 1: M√ìNG V·ªÆNG CH·∫ÆC (5 c√¢u - 8ƒë/c√¢u)";
            else if (q.stage === 2) badge.innerText = "V√íNG 2: D·ª∞NG TH√ÅP (5 c√¢u - 6ƒë/c√¢u)";
            else badge.innerText = "V√íNG 3: V·ªÄ ƒê√çCH (3 c√¢u - 10ƒë/c√¢u)";

            let html = `<div class="q-text">C√¢u ${currentQIdx + 1}: ${q.q}</div>`;

            // Render Tr·∫Øc Nghi·ªám n·∫øu c√≥ options (q.a)
            if (q.a) {
                html += `<div class="options-grid">`;
                const opts = shuffle([...q.a]);
                opts.forEach(opt => {
                    html += `<div class="opt-btn" onclick="checkAnswer(this, '${opt}', '${q.correct}')">${opt}</div>`;
                });
                html += `</div>`;
            } else {
                // Nh·∫≠p li·ªáu (Fallback cho 21.html c≈©, b√†i n√†y kh√¥ng d√πng)
                html += `
                <div class="input-group">
                    <input type="text" class="input-ans" id="user-input" placeholder="Nh·∫≠p s·ªë/ƒë√°p √°n...">
                    <button class="btn-submit" onclick="checkInputAnswer('${q.ans.join('|')}')">X√°c nh·∫≠n</button>
                    <p style="font-size:0.8rem; color:#aaa; text-align:center"><i>*Nh·∫≠p s·ªë g·ªçn</i></p>
                </div>
            `;
            }
            content.innerHTML = html;
        }

        function checkAnswer(btn, choice, correct) {
            const allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(b => b.onclick = null);

            if (choice === correct) {
                playSound('correct');
                btn.classList.add('correct');
                addScore(gameData[currentQIdx].points);
                buildTowerStep();
                setTimeout(nextQ, 1200);
            } else {
                playSound('wrong');
                btn.classList.add('wrong');
                allBtns.forEach(b => {
                    if (b.innerText === correct) b.classList.add('correct');
                });

                // Hi·ªán ƒë√°p √°n ƒë√∫ng r√µ r√†ng h∆°n
                const qContent = document.getElementById('q-content');
                const fb = document.createElement('div');
                fb.className = 'feedback-text';
                fb.innerHTML = `ƒê√ÅP √ÅN ƒê√öNG: ${correct}`;
                qContent.appendChild(fb);

                // D·ª´ng l√¢u h∆°n ƒë·ªÉ h·ªçc sinh ƒë·ªçc
                setTimeout(nextQ, 4000);
            }
        }

        // H√†m n√†y gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch n·∫øu c·∫ßn, nh∆∞ng b√†i n√†y kh√¥ng d√πng
        function checkInputAnswer(correctStr) {
            const input = document.getElementById('user-input');
            const userVal = input.value.trim();
            const correctArr = correctStr.split('|');
            const btn = document.querySelector('.btn-submit');
            input.disabled = true; btn.disabled = true;

            if (correctArr.includes(userVal)) {
                playSound('correct');
                input.style.borderColor = "var(--success)"; input.style.color = "var(--success)";
                addScore(gameData[currentQIdx].points);
                buildTowerStep();
            } else {
                playSound('wrong');
                input.style.borderColor = "var(--danger)";
                input.value += ` (Sai. ƒê/a: ${correctArr[0]})`;
            }
            setTimeout(nextQ, 2000);
        }

        function addScore(pts) {
            score += pts;
            const scoreEl = document.getElementById('current-score');
            scoreEl.innerText = score;
            scoreEl.style.transform = "scale(1.5)";
            setTimeout(() => scoreEl.style.transform = "scale(1)", 300);
        }

        function buildTowerStep() {
            const block = document.getElementById(`block-${currentQIdx}`);
            if (block) { block.classList.add('built'); block.innerText = `+${gameData[currentQIdx].points}`; }
        }

        function nextQ() { currentQIdx++; renderQuestion(); }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            if (type === 'correct') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, t); gainNode.gain.setValueAtTime(0.3, t);
                gainNode.gain.exponentialRampToValueAtTime(0.01, t + 0.6); osc.start(t); osc.stop(t + 0.6);
            } else {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(200, t); osc.frequency.linearRampToValueAtTime(100, t + 0.3);
                gainNode.gain.setValueAtTime(0.3, t); gainNode.gain.exponentialRampToValueAtTime(0.01, t + 0.3); osc.start(t); osc.stop(t + 0.3);
            }
        }

        function finishGame() {
            clearInterval(timerInterval);
            window.onbeforeunload = null;
            document.getElementById('game-ui').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            document.getElementById('final-time-text').innerText = document.getElementById('timer').innerText;

            const ref = db.ref('scores/Tuan_22');
            ref.once('value', (snap) => {
                let attempt = 1; const data = snap.val();
                if (data) { for (let id in data) { if (data[id].fullName === savedName && data[id].className === savedClass) attempt++; } }
                ref.push({ fullName: savedName, className: savedClass, score: score, duration: seconds, attempt: attempt, date: new Date().toLocaleString('vi-VN'), timestamp: firebase.database.ServerValue.TIMESTAMP }, () => {
                    let timeLeft = 5; const msg = document.getElementById('redirect-msg');
                    setInterval(() => { timeLeft--; msg.innerText = `ƒê√£ l∆∞u ƒëi·ªÉm! V·ªÅ trang ch·ªß sau ${timeLeft}s...`; if (timeLeft <= 0) location.href = 'index.html'; }, 1000);
                });
            });
        }

        function startTimer() {
            timerInterval = setInterval(() => { seconds++; const m = Math.floor(seconds / 60).toString().padStart(2, '0'); const s = (seconds % 60).toString().padStart(2, '0'); document.getElementById('timer').innerText = `${m}:${s}`; }, 1000);
        }

        initGame();
    </script>
</body>

</html>
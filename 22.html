<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·∫°i h·ªôi To√°n h·ªçc - Tu·∫ßn 22</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #2c3e50; --screen-bg: #f8f9fa; --btn-gray: #ecf0f1; --btn-orange: #f39c12; --danger: #e74c3c; --success: #2ecc71; }
        body { font-family: 'Lexend', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; background: #34495e; color: white; user-select: none; overflow-x: hidden; min-height: 100vh; }
        .game-container { max-width: 700px; width: 100%; background: var(--primary); padding: 30px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 4px solid #1a252f; position: relative; margin-bottom: 20px; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 40px; border-radius: 50px; font-weight: bold; font-size: 1.2rem; z-index: 1000; transition: opacity 0.3s, top 0.3s; opacity: 0; pointer-events: none; }
        .toast-true { background: var(--success); color: white; opacity: 1 !important; top: 50px !important; }
        .toast-false { background: var(--danger); color: white; opacity: 1 !important; top: 50px !important; }
        .screen { background: var(--screen-bg); border-radius: 12px; padding: 20px; margin-bottom: 25px; color: #1e272e; border: 5px solid #bdc3c7; min-height: 120px; }
        .screen-header { display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px; color: #7f8c8d; }
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; font-size: 0.9rem; width: 100%; max-width: 700px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .opt-btn { background: var(--btn-gray); border: none; padding: 15px; border-radius: 10px; font-family: 'Lexend'; font-weight: bold; cursor: pointer; border-bottom: 4px solid #bdc3c7; transition: 0.2s; color: #2c3e50; }
        .opt-btn:hover { background: white; transform: translateY(-2px); }
        .ans-input { padding: 15px; border-radius: 10px; border: 3px solid var(--btn-orange); font-size: 1.2rem; text-align: center; width: 200px; outline: none; }
        .hidden { display: none !important; }
        .action-btn { background: var(--btn-orange); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        footer { margin-top: auto; padding: 20px; font-size: 0.8rem; color: #bdc3c7; }
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #34495e; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="start-screen">
    <h1 style="color: var(--btn-orange); font-size: 2rem; text-align: center; margin-bottom: 10px;">ƒê·∫†I H·ªòI TO√ÅN H·ªåC - TU·∫¶N 22</h1>
    <p id="welcome-msg" style="margin-bottom: 30px; font-weight: bold;"></p>
    <button class="action-btn" id="btn-start-trigger" onclick="startGame()" style="padding: 20px 60px; font-size: 1.5rem;">B·∫ÆT ƒê·∫¶U</button>
</div>

<div id="toast"></div>

<div class="status-bar hidden" id="game-status">
    <span id="stage-name">V√íNG 1</span>
    <span id="score-display">ƒêI·ªÇM: 0/100</span>
</div>

<div class="game-container hidden" id="game-body">
    <div class="screen">
        <div class="screen-header">
            <span>TO√ÅN L·ªöP 5</span>
            <span id="lives-count">‚ù§Ô∏è M·∫†NG: 3/3</span>
        </div>
        <div id="q-content" style="font-size: 1.1rem; font-weight: 600;">...</div>
    </div>
    <div id="play-area"></div>
    <div id="result-screen" class="hidden" style="text-align: center;">
        <h2 id="title-finish">ƒêANG T√çNH ƒêI·ªÇM...</h2>
        <h1 id="final-score" style="font-size: 4rem; color: var(--btn-orange); margin: 10px 0;">0</h1>
        <p id="save-status" style="color: var(--success); font-weight: bold;">H·ªá th·ªëng ƒëang l∆∞u k·∫øt qu·∫£, ƒë·ª´ng tho√°t trang!</p>
    </div>
</div>

<footer>¬© 2026 EduRobot.id.vn - L√™ Th√†nh Long</footer>

<script>
    // 1. C·∫•u h√¨nh Firebase
    const firebaseConfig = { databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. T·ª± ƒë·ªông ki·ªÉm tra danh t√≠nh (B·∫£o m·∫≠t)
    const savedName = localStorage.getItem('studentName');
    const savedClass = localStorage.getItem('studentClass');

    window.onload = function() {
        if (!savedName || !savedClass) {
            document.getElementById('welcome-msg').innerHTML = "<b style='color:red'>‚ö†Ô∏è C·∫£nh b√°o: Em ch∆∞a nh·∫≠p t√™n ·ªü trang ch·ªß!</b>";
            document.getElementById('btn-start-trigger').innerText = "V·ªÄ TRANG CH·ª¶";
            document.getElementById('btn-start-trigger').onclick = () => window.location.href = "index.html";
        } else {
            document.getElementById('welcome-msg').innerText = `Th√°m hi·ªÉm vi√™n: ${savedName} - L·ªõp: ${savedClass}`;
        }
    };

    // 3. Ng√¢n h√†ng ƒë·ªÅ (8 - 8 - 4)
    const MASTER_DATA = {
        V1: [
            {q: "T·ªâ s·ªë c·ªßa s·ªë a v√† s·ªë b (b kh√°c 0) l√† a:b hay a/b. T·ªâ s·ªë n√†y cho bi·∫øt ƒëi·ªÅu g√¨?", opts: ["S·ªë b b·∫±ng m·∫•y ph·∫ßn s·ªë a", "Hi·ªáu gi·ªØa s·ªë a v√† b", "S·ªë a b·∫±ng m·∫•y ph·∫ßn s·ªë b", "T·ªïng c·ªßa s·ªë a v√† b"], c: 2},
            {q: "T·ªâ s·ªë ph·∫ßn trƒÉm 43/100 ƒë∆∞·ª£c vi·∫øt d∆∞·ªõi d·∫°ng k√Ω hi·ªáu l√†:", opts: ["0,43%", "4,3%", "43%", "430%"], c: 2},
            {q: "M·ªôt b·∫£n ƒë·ªì c√≥ ghi t·ªâ l·ªá 1 : 10 000. T·ªâ l·ªá n√†y cho bi·∫øt ƒëi·ªÅu g√¨?", opts: ["H√¨nh ·∫£nh th·∫≠t ƒë√£ ƒë∆∞·ª£c thu nh·ªè 10 000 l·∫ßn tr√™n b·∫£n ƒë·ªì", "ƒê·ªô th·∫≠t b·∫±ng 1/10 000 b·∫£n ƒë·ªì", "B·∫£n ƒë·ªì ph√≥ng to 10 000 l·∫ßn", "1 cm b·∫£n ƒë·ªì l√† 10 000 m th·∫≠t"], c: 0},
            {q: "ƒê·ªÉ t√≠nh ƒë·ªô d√†i th·ª±c t·∫ø t·ª´ b·∫£n ƒë·ªì, ta l√†m nh∆∞ sau:", opts: ["Chia b·∫£n ƒë·ªì cho t·ªâ l·ªá", "Tr·ª´ m·∫´u s·ªë t·ªâ l·ªá", "Nh√¢n ƒë·ªô d√†i b·∫£n ƒë·ªì v·ªõi m·∫´u s·ªë t·ªâ l·ªá", "C·ªông m·∫´u s·ªë t·ªâ l·ªá"], c: 2},
            {q: "Khi h√¨nh l·∫≠p ph∆∞∆°ng n·∫±m ho√†n to√†n trong h√¨nh h·ªôp ch·ªØ nh·∫≠t th√¨:", opts: ["Th·ªÉ t√≠ch l·∫≠p ph∆∞∆°ng l·ªõn h∆°n", "Th·ªÉ t√≠ch hai h√¨nh b·∫±ng nhau", "Th·ªÉ t√≠ch l·∫≠p ph∆∞∆°ng b√© h∆°n", "Kh√¥ng so s√°nh ƒë∆∞·ª£c"], c: 2},
            {q: "N·∫øu h√¨nh P t√°ch th√†nh hai h√¨nh M v√† N, th·ªÉ t√≠ch P l√†:", opts: ["T√≠ch th·ªÉ t√≠ch M v√† N", "Hi·ªáu th·ªÉ t√≠ch M v√† N", "T·ªïng th·ªÉ t√≠ch M v√† N", "Trung b√¨nh c·ªông M v√† N"], c: 2},
            {q: "M·ªôt h√¨nh h·ªôp ch·ªØ nh·∫≠t ti√™u chu·∫©n c√≥ bao nhi√™u k√≠ch th∆∞·ªõc?", opts: ["D√†i, R·ªông", "D√†i, R·ªông, Cao", "D√†i, Cao", "S√°u m·∫∑t"], c: 1},
            {q: "So s√°nh th·ªÉ t√≠ch hai h√¨nh b·∫±ng c√°ch ƒë·∫øm s·ªë kh·ªëi l·∫≠p ph∆∞∆°ng nh·ªè g·ªçi l√† ph∆∞∆°ng ph√°p:", opts: ["ƒêo ƒë·∫°c", "C√¢n kh·ªëi l∆∞·ª£ng", "ƒê·∫øm ƒë∆°n v·ªã th·ªÉ t√≠ch", "∆Ø·ªõc l∆∞·ª£ng m·∫Øt"], c: 2}
        ],
        V2: [
            {q: "Chuy·ªÉn ph√¢n s·ªë 3/4 th√†nh t·ªâ s·ªë ph·∫ßn trƒÉm:", opts: ["34%", "0,75%", "75%", "3,4%"], c: 2},
            {q: "B·∫£n ƒë·ªì t·ªâ l·ªá 1 : 2 000, ƒë·ªô d√†i 2 cm ·ª©ng v·ªõi ƒë·ªô d√†i th·∫≠t l√†:", opts: ["4 m", "40 m", "400 m", "4.000 m"], c: 1},
            {q: "T·ªïng hai s·ªë l√† 60, t·ªâ s·ªë l√† 7/8. S·ªë l·ªõn l√†:", opts: ["28", "32", "35", "40"], c: 1},
            {q: "T·ªâ s·ªë tivi c≈© v√† m·ªõi l√† 3/1. T·ªïng 36 chi·∫øc. S·ªë tivi m·ªõi l√†:", opts: ["9 chi·∫øc", "12 chi·∫øc", "24 chi·∫øc", "27 chi·∫øc"], c: 0},
            {q: "T√≠nh 2% c·ªßa s·ªë 250:", opts: ["50", "25", "5", "0,5"], c: 2},
            {q: "H√¨nh A v√† B ƒë·ªÅu ƒë∆∞·ª£c gh√©p b·ªüi 4 kh·ªëi nh·ªè. Th·ªÉ t√≠ch h√¨nh A so v·ªõi B l√†:", opts: ["L·ªõn h∆°n", "Nh·ªè h∆°n", "B·∫±ng nhau", "Kh√¥ng x√°c ƒë·ªãnh"], c: 2},
            {q: "Tivi gi√° 15.000.000ƒë, gi·∫£m gi√° 8%. S·ªë ti·ªÅn ƒë∆∞·ª£c gi·∫£m l√†:", opts: ["120.000ƒë", "1.200.000ƒë", "1.500.000ƒë", "800.000ƒë"], c: 1},
            {q: "H√¨nh C c√≥ 12 kh·ªëi nh·ªè, h√¨nh D c√≥ 10 kh·ªëi nh·ªè. Th·ªÉ t√≠ch h√¨nh C so v·ªõi D l√†:", opts: ["L·ªõn h∆°n", "Nh·ªè h∆°n", "B·∫±ng nhau", "Kh√¥ng x√°c ƒë·ªãnh"], c: 0}
        ],
        V3: [
            {q: "T·ªâ l·ªá 1:3000, d√†i 3cm, r·ªông 2cm. T√≠nh di·ªán t√≠ch th·∫≠t (m¬≤)?", ans: "5400"},
            {q: "T·ªâ s·ªë k·∫πo Mi/Mai l√† 5/2. Mi h∆°n Mai 6 c√°i. T·ªïng k·∫πo hai b·∫°n?", ans: "14"},
            {q: "Th√πng 33,2 m¬≥. H√†ng chi·∫øm 80%. Th·ªÉ t√≠ch tr·ªëng (m¬≥)?", ans: "6.64"},
            {q: "M·∫π h∆°n con 25 tu·ªïi. Con b·∫±ng 2/7 m·∫π. T√≠nh tu·ªïi m·∫π?", ans: "35"}
        ]
    };

    let score = 0, lives = 3, stage = 1, qIdx = 0, pool = [], startTime;

    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-status').classList.remove('hidden');
        document.getElementById('game-body').classList.remove('hidden');
        startTime = Date.now();
        initStage(1);
    }

    function initStage(s) {
        stage = s; qIdx = 0;
        const banner = document.getElementById('stage-name');
        if (s === 1) { 
            banner.innerText = "V√íNG 1: KH√ÅM PH√Å"; 
            pool = shuffle([...MASTER_DATA.V1]).slice(0, 4); 
        } else if (s === 2) { 
            banner.innerText = "V√íNG 2: LUY·ªÜN T·∫¨P"; 
            pool = shuffle([...MASTER_DATA.V2]).slice(0, 4); 
        } else { 
            banner.innerText = "V√íNG 3: V·ªÄ ƒê√çCH"; 
            pool = shuffle([...MASTER_DATA.V3]).slice(0, 2); 
        }
        renderQ();
    }

    function renderQ() {
        let item = pool[qIdx];
        document.getElementById('q-content').innerHTML = `<b>C√¢u ${qIdx + 1}/${pool.length}:</b> ${item.q}`;
        const area = document.getElementById('play-area');
        area.innerHTML = '';

        if (stage < 3) {
            let grid = document.createElement('div');
            grid.className = "options-grid";
            item.opts.forEach((o, i) => {
                grid.innerHTML += `<button class="opt-btn" onclick="check(${i})">${o}</button>`;
            });
            area.appendChild(grid);
        } else {
            area.innerHTML = `<div style="text-align:center;"><input type="number" id="ans-in" class="ans-input" placeholder="ƒêi·ªÅn s·ªë..."><button class="action-btn" onclick="checkTL()" style="margin-left:10px;">G·ª¨I</button></div>`;
            setTimeout(() => document.getElementById('ans-in').focus(), 200);
        }
    }

    function check(idx) {
        if (idx === pool[qIdx].c) { score += 10; showToast(true); }
        else { 
            showToast(false); 
            if (stage === 1) { lives--; document.getElementById('lives-count').innerText = `‚ù§Ô∏è M·∫†NG: ${lives}/3`; }
        }
        updateScore();
        setTimeout(next, 1000);
    }

    function checkTL() {
        const val = document.getElementById('ans-in').value.trim();
        if (val == pool[qIdx].ans) { score += 10; showToast(true); } else { showToast(false); }
        updateScore();
        setTimeout(next, 1000);
    }

    function updateScore() {
        let currentScore = (score > 100) ? 100 : score;
        document.getElementById('score-display').innerText = `ƒêI·ªÇM: ${currentScore}/100`;
    }

    function next() {
        qIdx++;
        if (lives <= 0 && stage === 1) { stage = 2; initStage(2); }
        else if (qIdx < pool.length) renderQ();
        else if (stage < 3) initStage(stage + 1);
        else finishGame();
    }

    function showToast(isC) {
        const t = document.getElementById('toast');
        t.innerText = isC ? "CH√çNH X√ÅC! üéâ" : "CH∆ØA ƒê√öNG! ‚ùå";
        t.className = isC ? "toast-true" : "toast-false";
        setTimeout(() => t.className = "", 1000);
    }

    // 4. T·ª± ƒë·ªông ghi ƒëi·ªÉm v√† tr·ªü v·ªÅ (ƒê√£ t·ªëi ∆∞u gi·ªëng 19.html)
    function finishGame() {
        document.getElementById('play-area').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        let final = (score > 100) ? 100 : score;
        document.getElementById('final-score').innerText = final + " ƒêI·ªÇM";
        document.getElementById('title-finish').innerText = "K·∫æT TH√öC TH·ª¨ TH√ÅCH!";
        
        const duration = Math.floor((Date.now() - startTime) / 1000);
        const ref = db.ref('scores/Tuan_22');

        ref.once('value', (snap) => {
            let attemptCount = 1;
            const data = snap.val();
            if (data) {
                for (let id in data) {
                    const oldName = (data[id].fullName || data[id].name || "").toLowerCase();
                    const oldClass = (data[id].className || "");
                    if (oldName === savedName.toLowerCase() && oldClass === savedClass) {
                        attemptCount++;
                    }
                }
            }

            ref.push({
                fullName: savedName,
                className: savedClass,
                score: final,
                duration: duration,
                attempt: attemptCount,
                date: new Date().toLocaleString('vi-VN'),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }, () => {
                document.getElementById('save-status').innerText = `‚úÖ ƒê√£ l∆∞u k·∫øt qu·∫£ l·∫ßn th·ª© ${attemptCount}! ƒêang quay l·∫°i b·∫£n ƒë·ªì...`;
                setTimeout(() => window.location.href = "index.html", 3000);
            });
        });
    }
</script>
</body>
</html>
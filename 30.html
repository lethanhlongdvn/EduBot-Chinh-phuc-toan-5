<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nh√† ph√¢n t√≠ch nh√≠ - Tu·∫ßn 30</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --office-blue: #2c3e50; --chart-green: #2ecc71; --chart-orange: #f39c12; --chart-red: #e74c3c; --chart-cyan: #3498db; --bg-light: #ecf0f1; }
        body { font-family: 'Lexend', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; background: var(--office-blue); color: white; user-select: none; }
        .game-container { max-width: 750px; width: 100%; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.4); border-top: 10px solid var(--chart-cyan); color: #333; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 40px; border-radius: 8px; font-weight: bold; font-size: 1.2rem; z-index: 1000; transition: 0.3s; opacity: 0; pointer-events: none; border: 2px solid white; }
        .toast-show { opacity: 1 !important; top: 50px !important; }
        .screen { background: var(--bg-light); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 5px solid var(--chart-cyan); min-height: 150px; }
        .screen-header { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 8px; margin-bottom: 15px; color: #7f8c8d; text-transform: uppercase; }
        .q-text { font-size: 1.1rem; font-weight: 600; line-height: 1.6; color: #2c3e50; }
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; color: var(--chart-cyan); }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .opt-btn { background: white; border: 2px solid #ddd; padding: 15px; border-radius: 10px; font-family: 'Lexend'; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; color: #2c3e50; text-align: left; }
        .opt-btn:hover { border-color: var(--chart-cyan); background: #f7f9fa; transform: translateX(5px); }
        .input-area { display: flex; flex-direction: column; gap: 15px; }
        .ans-input { padding: 18px; border-radius: 10px; border: 2px solid #ddd; font-size: 1.2rem; font-family: 'Lexend'; text-align: center; }
        .ans-input:focus { border-color: var(--chart-cyan); outline: none; }
        .action-btn { background: var(--chart-cyan); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 0 #2980b9; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="game-container">
    <div class="status-bar">
        <span id="stage-name">V√íNG 1: ƒê·ªåC BI·ªÇU ƒê·ªí</span>
        <span id="score-display">ƒêI·ªÇM: 0 / 100</span>
    </div>

    <div class="screen">
        <div class="screen-header">
            <span>NH√Ä PH√ÇN T√çCH NH√ç - TU·∫¶N 30</span>
            <span id="lives-count">üîç C∆† H·ªòI: 3/3</span>
        </div>
        <div id="q-content" class="q-text">ƒêang t·ªïng h·ª£p d·ªØ li·ªáu kh·∫£o s√°t...</div>
    </div>

    <div id="play-area"></div>

    <div id="result-screen" class="hidden" style="text-align: center;">
        <h2 id="res-title">üìä B√ÅO C√ÅO HO√ÄN T·∫§T</h2>
        <h1 id="final-score" style="font-size: 4rem; color: var(--chart-cyan); margin: 15px 0;">0 ƒêI·ªÇM</h1>
        <div id="save-form" class="hidden">
            <input type="text" id="p-name" style="width:80%; padding:15px; margin:10px; border-radius:10px; border:1px solid #ccc;" placeholder="T√™n nh√† ph√¢n t√≠ch...">
            <input type="text" id="p-class" style="width:80%; padding:15px; margin:10px; border-radius:10px; border:1px solid #ccc;" placeholder="L·ªõp...">
            <button class="action-btn" style="width:85%; margin-top:10px;" onclick="saveData()">L∆ØU K·∫æT QU·∫¢</button>
        </div>
        <button class="action-btn" style="background:#95a5a6; margin-top:20px; box-shadow:0 4px 0 #7f8c8d;" onclick="location.reload()">PH√ÇN T√çCH ƒê·ªÄ M·ªöI</button>
    </div>
</div>

<script>
    let isFinished = false;
    let score = 0;
    let stage = 1;
    let qIdx = 0;
    let lives = 3;

    // Ch·ªëng t·∫£i l·∫°i trang
    window.addEventListener('beforeunload', (e) => {
        if (!isFinished) { e.preventDefault(); e.returnValue = ''; }
    });

    const firebaseConfig = {
        apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
        authDomain: "gamhoctap.firebaseapp.com",
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gamhoctap"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

    // NG√ÇN H√ÄNG C√ÇU H·ªéI TU·∫¶N 30
    const POOL1 = [
        {q: "Bi·ªÉu ƒë·ªì h√¨nh qu·∫°t tr√≤n th∆∞·ªùng ƒë∆∞·ª£c d√πng ƒë·ªÉ l√†m g√¨?", opts: ["So s√°nh c√°c ph·∫ßn trong to√†n b·ªô", "T√≠nh t·ªïng s·ªë l∆∞·ª£ng", "V·∫Ω h√¨nh trang tr√≠", "T√≠nh chu vi h√¨nh tr√≤n"], c: 0},
        {q: "Trong bi·ªÉu ƒë·ªì qu·∫°t tr√≤n, ƒë·ªëi t∆∞·ª£ng n√†o chi·∫øm ∆∞u th·∫ø nh·∫•t?", opts: ["Ph·∫ßn qu·∫°t nh·ªè nh·∫•t", "Ph·∫ßn qu·∫°t l·ªõn nh·∫•t", "T·∫•t c·∫£ c√°c ph·∫ßn", "Kh√¥ng c√≥ ph·∫ßn n√†o"], c: 1},
        {q: "Bi·ªÉu ƒë·ªì cho bi·∫øt 45% HS l√† l·ªõp 3. N·∫øu t·ªïng l√† 100 HS, s·ªë HS l·ªõp 3 l√†:", opts: ["4,5 em", "45 em", "55 em", "100 em"], c: 1},
        {q: "N·∫øu m·ªôt ph·∫ßn qu·∫°t chi·∫øm 1/4 h√¨nh tr√≤n, t·ªâ s·ªë ph·∫ßn trƒÉm ƒë√≥ l√†:", opts: ["10%", "20%", "25%", "50%"], c: 2},
        {q: "T·ªïng c√°c t·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa c√°c ph·∫ßn trong bi·ªÉu ƒë·ªì qu·∫°t tr√≤n l√†:", opts: ["50%", "100%", "200%", "T√πy √Ω"], c: 1},
        {q: "Nh√¨n v√†o bi·ªÉu ƒë·ªì qu·∫°t, ta bi·∫øt ƒë∆∞·ª£c th√¥ng tin g√¨?", opts: ["Chi·ªÅu cao ƒë·ªëi t∆∞·ª£ng", "T·ªâ s·ªë ph·∫ßn trƒÉm so v·ªõi t·ªïng th·ªÉ", "C√¢n n·∫∑ng ƒë·ªëi t∆∞·ª£ng", "S·ªë th·ª© t·ª±"], c: 1},
        {q: "Mu·ªën t√≠nh gi√° tr·ªã c·ªßa m·ªôt ph·∫ßn, ta l·∫•y t·ªïng nh√¢n v·ªõi:", opts: ["T·ªâ s·ªë ph·∫ßn trƒÉm c·ªßa ph·∫ßn ƒë√≥", "S·ªë l∆∞·ª£ng c√°c ph·∫ßn", "100", "2"], c: 0},
        {q: "Bi·ªÉu ƒë·ªì qu·∫°t c√≥ 3 m√†u: Xanh (50%), ƒê·ªè (30%). H·ªèi m√†u V√†ng chi·∫øm bao nhi√™u?", opts: ["10%", "20%", "30%", "80%"], c: 1}
    ];

    const POOL2 = [
        {q: "Tung ƒë·ªìng xu 20 l·∫ßn, c√≥ 7 l·∫ßn m·∫∑t h√¨nh. T·ªâ s·ªë m·∫∑t h√¨nh l√†:", opts: ["20/7", "7/20", "7/13", "13/20"], c: 1},
        {q: "Gieo x√∫c x·∫Øc 10 l·∫ßn, c√≥ 3 l·∫ßn m·∫∑t 6 ch·∫•m. T·ªâ s·ªë m·∫∑t 6 ch·∫•m l√†:", opts: ["3/10", "1/6", "10/3", "3/6"], c: 0},
        {q: "T·ªâ s·ªë l·∫∑p l·∫°i = (S·ªë l·∫ßn s·ª± ki·ªán x·∫£y ra) chia cho:", opts: ["100", "S·ªë l·∫ßn s·ª± ki·ªán kh√¥ng x·∫£y ra", "T·ªïng s·ªë l·∫ßn th·ª±c hi·ªán", "S·ªë l·∫ßn th·ª±c hi·ªán + 1"], c: 2},
        {q: "Quay v√≤ng quay 15 l·∫ßn, 5 l·∫ßn v√†o √¥ Qu√†. T·ªâ s·ªë √¥ Qu√† l√†:", opts: ["1/2", "1/3", "1/15", "5/10"], c: 1},
        {q: "Trong h·ªôp c√≥ b√≥ng Xanh v√† ƒê·ªè. L·∫•y 8 l·∫ßn, 6 l·∫ßn b√≥ng ƒê·ªè. T·ªâ s·ªë b√≥ng ƒê·ªè l√†:", opts: ["6/8", "2/8", "8/6", "1/2"], c: 0},
        {q: "Gieo x√∫c x·∫Øc 9 l·∫ßn, 4 l·∫ßn m·∫∑t ch·∫µn, 5 l·∫ßn m·∫∑t l·∫ª. T·ªâ s·ªë m·∫∑t l·∫ª l√†:", opts: ["4/9", "5/9", "9/5", "5/4"], c: 1},
        {q: "L·∫•y t·∫•t 10 l·∫ßn, 2 l·∫ßn l·∫•y ƒë∆∞·ª£c t·∫•t m√†u tr·∫Øng. T·ªâ s·ªë t·∫•t tr·∫Øng l√†:", opts: ["2/10", "1/5", "C·∫£ A v√† B ƒë·ªÅu ƒë√∫ng", "10/2"], c: 2},
        {q: "M√¥ t·∫£ kh·∫£ nƒÉng x·∫£y ra c·ªßa m·ªôt s·ª± ki·ªán ta d√πng:", opts: ["Ph√©p c·ªông", "T·ªâ s·ªë gi·ªØa s·ªë l·∫ßn x·∫£y ra v√† t·ªïng s·ªë l·∫ßn", "Ph√©p nh√¢n", "Di·ªán t√≠ch h√¨nh tr√≤n"], c: 1}
    ];

    const POOL3 = [
        {q: "Tr∆∞·ªùng c√≥ 200 HS. Bi·ªÉu ƒë·ªì qu·∫°t cho bi·∫øt 20% HS th√≠ch b∆°i. S·ªë HS th√≠ch b∆°i l√† bao nhi√™u em?", a: "40"},
        {q: "Gieo x√∫c x·∫Øc 12 l·∫ßn, 5 l·∫ßn m·∫∑t ch·∫µn. T·ªâ s·ªë m·∫∑t l·∫ª l√† bao nhi√™u? (D·∫°ng ph√¢n s·ªë, v√≠ d·ª• 7/12)", a: "7/12"},
        {q: "Bi·ªÉu ƒë·ªì qu·∫°t: B√≥ng ƒë√° 40%, C·∫ßu l√¥ng 25%, c√≤n l·∫°i l√† B∆°i. T·ªâ s·ªë % c·ªßa B∆°i l√†:", a: "35"},
        {q: "R√¥-b·ªët l·∫•y 50 l·∫ßn t·ª´ h·ªôp, c√≥ 15 l·∫ßn b√≥ng v√†ng. Vi·∫øt t·ªâ s·ªë b√≥ng v√†ng ·ªü d·∫°ng ph√¢n s·ªë t·ªëi gi·∫£n:", a: "3/10"}
    ];

    let game1 = shuffle([...POOL1]).slice(0, 4);
    let game2 = shuffle([...POOL2]).slice(0, 4);
    let game3 = shuffle([...POOL3]).slice(0, 2);

    function startStage(s) {
        stage = s; qIdx = 0;
        document.getElementById('stage-name').innerText = s === 1 ? "V√íNG 1: ƒê·ªåC BI·ªÇU ƒê·ªí" : (s === 2 ? "V√íNG 2: X√ÅC SU·∫§T" : "V√íNG 3: NH√Ä PH√ÇN T√çCH T√ÄI BA");
        if(s > 1) document.getElementById('lives-count').classList.add('hidden');
        renderQ();
    }

    function renderQ() {
        let data = stage === 1 ? game1 : (stage === 2 ? game2 : game3);
        let item = data[qIdx];
        document.getElementById('q-content').innerHTML = `<b>C√¢u ${qIdx+1}:</b> ${item.q}`;
        let html = '';
        if(stage < 3) {
            html = '<div class="options-grid">';
            item.opts.forEach((o, i) => html += `<button class="opt-btn" onclick="check(${i})">${o}</button>`);
            html += '</div>';
        } else {
            html = `<div class="input-area"><input type="text" id="ans" class="ans-input" placeholder="Nh·∫≠p k·∫øt qu·∫£..."><button class="action-btn" onclick="checkTuluan()">X√ÅC NH·∫¨N D·ªÆ LI·ªÜU</button></div>`;
        }
        document.getElementById('play-area').innerHTML = html;
    }

    function check(idx) {
        let item = (stage === 1) ? game1[qIdx] : game2[qIdx];
        if(idx === item.c) { score += 10; showToast(true); } 
        else {
            showToast(false);
            if(stage === 1) { 
                lives--; document.getElementById('lives-count').innerText = "üîç C∆† H·ªòI: "+lives+"/3";
                if(lives <= 0) { setTimeout(() => startStage(2), 1200); return; }
            }
        }
        updateScore();
        setTimeout(next, 1200);
    }

    function checkTuluan() {
        let userAns = document.getElementById('ans').value.trim().toLowerCase();
        let correctAns = game3[qIdx].a.toLowerCase();
        if(userAns.includes(correctAns) || userAns == correctAns) { score += 10; showToast(true); }
        else { showToast(false); }
        updateScore();
        setTimeout(next, 1200);
    }

    function next() {
        qIdx++;
        let data = (stage === 1) ? game1 : (stage === 2 ? game2 : game3);
        if(qIdx < data.length) renderQ();
        else if(stage < 3) startStage(stage + 1);
        else finish();
    }

    function updateScore() { document.getElementById('score-display').innerText = "ƒêI·ªÇM: " + score + " / 100"; }

    function showToast(isCorrect) {
        const toast = document.getElementById('toast');
        toast.innerText = isCorrect ? "D·ªÆ LI·ªÜU CHU·∫®N! ‚úÖ" : "PH√ÇN T√çCH SAI! ‚ùå";
        toast.style.background = isCorrect ? "var(--chart-green)" : "var(--chart-red)";
        toast.classList.add('toast-show');
        setTimeout(() => { toast.classList.remove('toast-show'); }, 1000);
    }

    function finish() {
        isFinished = true;
        document.getElementById('play-area').innerHTML = '';
        document.getElementById('q-content').innerText = "B√°o c√°o ƒë√£ ho√†n t·∫•t. C·∫£m ∆°n nh√† ph√¢n t√≠ch!";
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = score + " ƒêI·ªÇM";
        if(score >= 50) document.getElementById('save-form').classList.remove('hidden');
    }

    function saveData() {
        const name = document.getElementById('p-name').value;
        const cls = document.getElementById('p-class').value;
        if(!name || !cls) return;
        db.ref('scores/tuan30/' + Date.now()).set({ fullName: name, className: cls, score: score, timestamp: Date.now() })
        .then(() => { alert("L∆∞u b√°o c√°o th√†nh c√¥ng!"); location.reload(); });
    }

    window.onload = () => { startStage(1); };
</script>
</body>
</html>
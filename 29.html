<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chuy·∫øn xe bu√Ωt k·ª≥ th√∫ - Tu·∫ßn 29</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --bus-yellow: #ffcc00; --bus-blue: #2980b9; --road-gray: #34495e; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Lexend', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; background: var(--road-gray); color: white; user-select: none; }
        .game-container { max-width: 750px; width: 100%; background: white; padding: 30px; border-radius: 30px; box-shadow: 0 15px 50px rgba(0,0,0,0.5); border: 6px solid var(--bus-yellow); position: relative; color: #333; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 40px; border-radius: 50px; font-weight: bold; font-size: 1.2rem; z-index: 1000; transition: 0.3s; opacity: 0; pointer-events: none; }
        .toast-show { opacity: 1 !important; top: 50px !important; }
        .screen { background: #f8f9fa; border-radius: 20px; padding: 20px; margin-bottom: 25px; border: 3px dashed var(--bus-blue); min-height: 140px; }
        .screen-header { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: bold; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; color: var(--bus-blue); }
        .q-text { font-size: 1.15rem; font-weight: 600; line-height: 1.6; color: #2c3e50; }
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; color: var(--bus-yellow); text-shadow: 1px 1px 2px black; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .opt-btn { background: #ecf0f1; border: none; padding: 15px; border-radius: 15px; font-family: 'Lexend'; font-weight: bold; cursor: pointer; border-bottom: 5px solid #bdc3c7; transition: 0.2s; font-size: 1rem; color: #2c3e50; }
        .opt-btn:hover { background: var(--bus-yellow); transform: translateY(-3px); }
        .input-area { display: flex; flex-direction: column; gap: 15px; }
        .ans-input { padding: 18px; border-radius: 15px; border: 2px solid var(--bus-blue); font-size: 1.2rem; font-family: 'Lexend'; text-align: center; }
        .action-btn { background: var(--bus-blue); color: white; padding: 15px 30px; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 0 #1a5276; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="game-container">
    <div class="status-bar">
        <span id="stage-name">TR·∫†M 1: CHUY·ªÇN ƒê·ªòNG ƒê·ªÄU</span>
        <span id="score-display">ƒêI·ªÇM: 0 / 100</span>
    </div>

    <div class="screen">
        <div class="screen-header">
            <span>BUS TOUR - TU·∫¶N 29</span>
            <span id="lives-count">üöå NHI√äN LI·ªÜU: 3/3</span>
        </div>
        <div id="q-content" class="q-text">H√†nh kh√°ch vui l√≤ng th·∫Øt d√¢y an to√†n...</div>
    </div>

    <div id="play-area"></div>

    <div id="result-screen" class="hidden" style="text-align: center;">
        <h2 id="res-title">üöå CHUY·∫æN ƒêI K·∫æT TH√öC</h2>
        <h1 id="final-score" style="font-size: 4rem; color: var(--bus-blue); margin: 15px 0;">0 ƒêI·ªÇM</h1>
        <div id="save-form" class="hidden">
            <input type="text" id="p-name" style="width:80%; padding:15px; margin:10px; border-radius:10px; border:1px solid #ccc;" placeholder="H·ªç t√™n h√†nh kh√°ch...">
            <input type="text" id="p-class" style="width:80%; padding:15px; margin:10px; border-radius:10px; border:1px solid #ccc;" placeholder="L·ªõp (V√≠ d·ª•: 5A)...">
            <button class="action-btn" style="width:85%; margin-top:10px;" onclick="saveData()">GHI DANH B·∫¢NG V√ÄNG</button>
        </div>
        <button class="action-btn" style="background:#95a5a6; margin-top:20px; box-shadow:0 4px 0 #7f8c8d;" onclick="location.reload()">B·∫ÆT ƒê·∫¶U CHUY·∫æN M·ªöI</button>
    </div>
</div>

<script>
    let isFinished = false;
    let score = 0;
    let stage = 1;
    let qIdx = 0;
    let lives = 3;

    window.addEventListener('beforeunload', (e) => {
        if (!isFinished) { e.preventDefault(); e.returnValue = ''; }
    });

    const firebaseConfig = {
        apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
        authDomain: "gamhoctap.firebaseapp.com",
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gamhoctap"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

    const POOL1 = [
        {q: "Xe bu√Ωt ƒëi 48 km/h trong 2,5 gi·ªù. Qu√£ng ƒë∆∞·ªùng l√† bao nhi√™u?", opts: ["120 m", "120 km", "19,2 km", "96 km"], c: 1},
        {q: "ƒêi 18,3 km v·ªõi v·∫≠n t·ªëc 15 km/h h·∫øt bao nhi√™u th·ªùi gian?", opts: ["1,2 gi·ªù", "1,12 gi·ªù", "1,22 gi·ªù", "1g 22p"], c: 2},
        {q: "Ong m·∫≠t bay 8 m/s. Qu√£ng ƒë∆∞·ªùng bay trong 1 ph√∫t l√†:", opts: ["480 m", "8 m", "480 km", "80 m"], c: 0},
        {q: "ƒê·ªïi v·∫≠n t·ªëc: 36 km/h b·∫±ng bao nhi√™u m/s?", opts: ["10 m/s", "360 m/s", "6 m/s", "1 m/s"], c: 0},
        {q: "C√¥ng th·ª©c t√≠nh qu√£ng ƒë∆∞·ªùng khi hai xe ƒëi ng∆∞·ª£c chi·ªÅu g·∫∑p nhau l√†:", opts: ["s = (v1-v2)*t", "s = (v1+v2)*t", "s = v1*t + v2", "s = (v1+v2):t"], c: 1},
        {q: "√î t√¥ ƒëi t·ª´ 7g15 ƒë·∫øn 10g45 v·ªõi v·∫≠n t·ªëc 54 km/h. Qu√£ng ƒë∆∞·ªùng d√†i:", opts: ["162 km", "189 km", "135 km", "200 km"], c: 1},
        {q: "T√†u ƒëi 80km v·ªõi v = 32 km/h. Kh·ªüi h√†nh l√∫c 8 gi·ªù th√¨ ƒë·∫øn l√∫c m·∫•y gi·ªù?", opts: ["10g 30p", "10g 15p", "2,5 gi·ªù", "11 gi·ªù"], c: 0},
        {q: "Ch·∫°y 400m trong 1 ph√∫t 20 gi√¢y. V·∫≠n t·ªëc l√† bao nhi√™u?", opts: ["5 km/h", "5 m/s", "300 m/s", "4 m/s"], c: 1}
    ];

    const POOL2 = [
        {q: "1,5 m¬≥ b·∫±ng bao nhi√™u dm¬≥?", opts: ["15", "150", "1500", "15000"], c: 2},
        {q: "3 t·∫•n 66 kg b·∫±ng bao nhi√™u t·∫•n?", opts: ["3,66", "3,066", "36,6", "3066"], c: 1},
        {q: "So s√°nh: 7 dm¬≤ ... 70 cm¬≤", opts: [">", "<", "=", "Kh√¥ng bi·∫øt"], c: 0},
        {q: "B·ªÉ c√° 60cm x 40cm x 50cm c√≥ th·ªÉ t√≠ch l√† bao nhi√™u dm¬≥?", opts: ["120 l", "120 dm¬≥", "120 m¬≥", "12 dm¬≥"], c: 1},
        {q: "135 gi√¢y ƒë·ªïi ra ph√∫t v√† gi√¢y l√†:", opts: ["1p 35s", "2p 15s", "2,15p", "2p 25s"], c: 1},
        {q: "Di·ªán t√≠ch 1,6 ha ƒë·ªïi sang m¬≤ l√†:", opts: ["160 m¬≤", "1600 m¬≤", "16000 m¬≤", "160000 m¬≤"], c: 2},
        {q: "B·ªÉ 480 m¬≥ n∆∞·ªõc, h√∫t ƒëi 5/8 b·ªÉ. C√≤n l·∫°i bao nhi√™u m¬≥?", opts: ["300 m¬≥", "180 m¬≥", "120 m¬≥", "240 m¬≥"], c: 1},
        {q: "7 gi·ªù 48 ph√∫t + 5 gi·ªù 32 ph√∫t = ?", opts: ["12g 80p", "13g 20p", "13g 10p", "12g 20p"], c: 1}
    ];

    const POOL3 = [
        {q: "Xe ch·∫°y 3 gi·ªù, ngh·ªâ 30 ph√∫t. V·∫≠n t·ªëc 40km/h. T·ªïng th·ªùi gian chuy·∫øn ƒëi (ph√∫t) l√†:", a: "210"},
        {q: "T√†u ƒë·∫øn B l√∫c 12g15 sau khi ƒëi 2,5 gi·ªù. T√†u kh·ªüi h√†nh l√∫c m·∫•y gi·ªù m·∫•y ph√∫t? (V√≠ d·ª•: 9 gi·ªù 45 ph√∫t)", a: "9 gi·ªù 45 ph√∫t"},
        {q: "B·ªÉ chu vi ƒë√°y 320cm, r·ªông = 3/5 d√†i. Di·ªán t√≠ch ƒë√°y b·ªÉ l√† bao nhi√™u cm¬≤?", a: "6000"},
        {q: "√î t√¥ ƒëi 156km v·ªõi v·∫≠n t·ªëc 60km/h. Kh·ªüi h√†nh l√∫c 8g30 th√¨ ƒë·∫øn B l√∫c m·∫•y gi·ªù m·∫•y ph√∫t? (V√≠ d·ª•: 11 gi·ªù 6 ph√∫t)", a: "11 gi·ªù 6 ph√∫t"}
    ];

    let game1 = shuffle([...POOL1]).slice(0, 4);
    let game2 = shuffle([...POOL2]).slice(0, 4);
    let game3 = shuffle([...POOL3]).slice(0, 2);

    function startStage(s) {
        stage = s; qIdx = 0;
        document.getElementById('stage-name').innerText = s === 1 ? "TR·∫†M 1: CHUY·ªÇN ƒê·ªòNG ƒê·ªÄU" : (s === 2 ? "TR·∫†M 2: √îN T·∫¨P ƒêO L∆Ø·ªúNG" : "TR·∫†M 3: ƒê√çCH ƒê·∫æN K·ª≤ TH√ö");
        if(s > 1) document.getElementById('lives-count').classList.add('hidden');
        renderQ();
    }

    function renderQ() {
        let data = stage === 1 ? game1 : (stage === 2 ? game2 : game3);
        let item = data[qIdx];
        document.getElementById('q-content').innerHTML = `<b>C√¢u ${qIdx+1}:</b> ${item.q}`;
        let html = '';
        if(stage < 3) {
            html = '<div class="options-grid">';
            item.opts.forEach((o, i) => html += `<button class="opt-btn" onclick="check(${i})">${o}</button>`);
            html += '</div>';
        } else {
            html = `<div class="input-area"><input type="text" id="ans" class="ans-input" placeholder="Nh·∫≠p ƒë√°p √°n..."><button class="action-btn" onclick="checkTuluan()">X√ÅC NH·∫¨N H√ÄNH TR√åNH</button></div>`;
        }
        document.getElementById('play-area').innerHTML = html;
    }

    function check(idx) {
        let item = (stage === 1) ? game1[qIdx] : game2[qIdx];
        if(idx === item.c) { score += 10; showToast(true); } 
        else {
            showToast(false);
            if(stage === 1) { 
                lives--; document.getElementById('lives-count').innerText = "üöå NHI√äN LI·ªÜU: "+lives+"/3";
                if(lives <= 0) { setTimeout(() => startStage(2), 1200); return; }
            }
        }
        updateScore();
        setTimeout(next, 1200);
    }

    function checkTuluan() {
        let userAns = document.getElementById('ans').value.trim().toLowerCase();
        let correctAns = game3[qIdx].a.toLowerCase();
        if(userAns.includes(correctAns) || userAns == correctAns) { score += 10; showToast(true); }
        else { showToast(false); }
        updateScore();
        setTimeout(next, 1200);
    }

    function next() {
        qIdx++;
        let data = (stage === 1) ? game1 : (stage === 2 ? game2 : game3);
        if(qIdx < data.length) renderQ();
        else if(stage < 3) startStage(stage + 1);
        else finish();
    }

    function updateScore() { document.getElementById('score-display').innerText = "ƒêI·ªÇM: " + score + " / 100"; }

    function showToast(isCorrect) {
        const toast = document.getElementById('toast');
        toast.innerText = isCorrect ? "CH√çNH X√ÅC! üåü" : "NH·∫¶M ƒê∆Ø·ªúNG R·ªíI! üöß";
        toast.style.background = isCorrect ? "var(--success)" : "var(--danger)";
        toast.classList.add('toast-show');
        setTimeout(() => { toast.classList.remove('toast-show'); }, 1000);
    }

    function finish() {
        isFinished = true;
        document.getElementById('play-area').innerHTML = '';
        document.getElementById('q-content').innerText = "Ch√∫c m·ª´ng h√†nh kh√°ch ƒë√£ v·ªÅ tr·∫°m cu·ªëi an to√†n!";
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = score + " ƒêI·ªÇM";
        if(score >= 50) document.getElementById('save-form').classList.remove('hidden');
    }

    function saveData() {
        const name = document.getElementById('p-name').value;
        const cls = document.getElementById('p-class').value;
        if(!name || !cls) return;
        db.ref('scores/tuan29/' + Date.now()).set({ fullName: name, className: cls, score: score, timestamp: Date.now() })
        .then(() => { alert("Ghi danh th√†nh c√¥ng!"); location.reload(); });
    }

    window.onload = () => { startStage(1); };
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truy T√¨m C·∫∑p S·ªë - Hi·ªáu v√† T·ªâ S·ªë</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #673AB7; --secondary-color: #9575CD; --success: #4CAF50; --bg: #F8F4FF; }
        body { font-family: 'Lexend', sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 750px; width: 100%; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 3px solid var(--primary-color); }
        
        .header-box { width: 100%; border-radius: 15px; height: 80px; margin-bottom: 20px; background: linear-gradient(135deg, #EDE7F6, #D1C4E9); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border: 1px solid #DDD; }
        .header-box h2 { color: var(--primary-color); margin: 0; font-size: 1.4rem; }
        .header-box p { color: #666; font-size: 0.8rem; margin: 2px 0 0 0; }

        .lvl-nav { display: flex; gap: 8px; margin-bottom: 20px; }
        .lvl-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; background: #eee; font-weight: bold; font-family: 'Lexend'; color: #999; font-size: 0.8rem; }
        .lvl-btn.active { background: var(--primary-color); color: white; border-bottom: 3px solid #4527A0; }
        
        .question-box { background: #FCFAFF; padding: 20px; border-radius: 15px; text-align: center; border: 1px solid #EDE7F6; margin-bottom: 20px; min-height: 120px; display: flex; flex-direction: column; justify-content: center; }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .opt-btn { padding: 12px; border: 2px solid #eee; border-radius: 12px; background: white; cursor: pointer; font-size: 0.95rem; font-family: 'Lexend'; transition: 0.2s; }
        .opt-btn:hover:not(:disabled) { border-color: var(--primary-color); background: #F3E5F5; }
        
        .robot-feedback { display: flex; align-items: center; gap: 10px; padding: 12px; background: #E8F5E9; border-radius: 12px; margin-top: 15px; border-left: 5px solid #4CAF50; font-size: 0.9rem; }
        .hidden { display: none; }
        .action-btn { padding: 12px 25px; background: var(--success); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-family: 'Lexend'; font-size: 1rem; }
        input { padding: 12px; border-radius: 10px; border: 2px solid #ddd; width: 85%; font-family: 'Lexend'; margin-bottom: 15px; font-size: 1rem; }
        
        footer { margin-top: 25px; text-align: center; font-size: 0.8rem; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <h2>üîç TRUY T√åM C·∫∂P S·ªê</h2>
        <p>To√°n 5 - B√†i 39: T√¨m hai s·ªë khi bi·∫øt Hi·ªáu v√† T·ªâ s·ªë</p>
    </div>

    <div class="lvl-nav">
        <button id="btn-0" class="lvl-btn active">Ch·∫∑ng 1: L√Ω thuy·∫øt</button>
        <button id="btn-1" class="lvl-btn">Ch·∫∑ng 2: T√≠nh to√°n</button>
        <button id="btn-2" class="lvl-btn">Ch·∫∑ng 3: ·ª®ng d·ª•ng</button>
    </div>

    <div id="play-area">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; color: var(--primary-color);">
            <span id="q-counter">C√¢u: 1/4</span>
            <span id="score-counter">ƒêi·ªÉm: 0</span>
        </div>
        <div class="question-box">
            <p id="q-text" style="font-size: 1.1rem; font-weight: 500;"></p>
            <div id="options" class="option-grid"></div>
        </div>
        <div id="feedback" class="robot-feedback hidden">
            <span>üí° Robot:</span> <span id="feedback-text"></span>
        </div>
    </div>

    <div id="next-lvl-screen" class="hidden" style="text-align: center; padding: 20px;">
        <h2>V∆∞·ª£t ch·∫∑ng th√†nh c√¥ng! üåü</h2>
        <p id="lvl-score-info" style="font-size: 1.2rem;"></p>
        <button class="action-btn" onclick="continueToNext()">Ti·∫øp t·ª•c Ch·∫∑ng ti·∫øp theo ‚ûî</button>
    </div>

    <div id="result-box" class="hidden" style="text-align: center; padding: 20px;">
        <h2>K·∫øt th√∫c h√†nh tr√¨nh! üèÜ</h2>
        <p id="total-score-info" style="font-size: 2rem; color: var(--primary-color); font-weight: bold; margin: 15px 0;"></p>
        <input type="text" id="player-name" placeholder="Nh·∫≠p t√™n c·ªßa em...">
        <input type="text" id="player-class" placeholder="Nh·∫≠p l·ªõp (V√≠ d·ª•: 5/1)...">
        <br>
        <button class="action-btn" onclick="saveResult()">Ghi danh B·∫£ng V√†ng</button>
    </div>
</div>

<footer style="text-align: center; padding: 20px; color: #888; font-size: 0.8rem;">
    &copy; 2025 EduRobot - Ph√°t tri·ªÉn b·ªüi GV. L√™ Th√†nh Long
</footer>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
        authDomain: "gamhoctap.firebaseapp.com",
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gamhoctap"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // D·ªÆ LI·ªÜU 8 C√ÇU M·ªñI CH·∫∂NG
    const allQuizData = [
        [ // Ch·∫∑ng 1: L√Ω thuy·∫øt (8 c√¢u)
            { q: "B∆∞·ªõc ƒë·∫ßu ti√™n khi gi·∫£i b√†i to√°n t√¨m hai s·ªë khi bi·∫øt hi·ªáu v√† t·ªâ s·ªë l√† g√¨?", a: ["T√¨m hi·ªáu s·ªë ph·∫ßn", "V·∫Ω s∆° ƒë·ªì ƒëo·∫°n th·∫≥ng", "T√¨m gi√° tr·ªã m·ªôt ph·∫ßn", "T√¨m s·ªë l·ªõn"], c: 1, h: "V·∫Ω s∆° ƒë·ªì gi√∫p ch√∫ng ta th·∫•y r√µ hi·ªáu s·ªë ph·∫ßn ·ª©ng v·ªõi gi√° tr·ªã n√†o." },
            { q: "N·∫øu t·ªâ s·ªë l√† 3/5, hi·ªáu s·ªë ph·∫ßn b·∫±ng nhau l√† bao nhi√™u?", a: ["2 ph·∫ßn", "8 ph·∫ßn", "15 ph·∫ßn", "3 ph·∫ßn"], c: 0, h: "Hi·ªáu s·ªë ph·∫ßn = S·ªë ph·∫ßn l·ªõn - S·ªë ph·∫ßn b√©: 5 - 3 = 2." },
            { q: "Mu·ªën t√¨m gi√° tr·ªã m·ªôt ph·∫ßn, ta l·∫•y Hi·ªáu chia cho...?", a: ["T·ªïng s·ªë ph·∫ßn", "S·ªë b√©", "Hi·ªáu s·ªë ph·∫ßn b·∫±ng nhau", "S·ªë ph·∫ßn s·ªë l·ªõn"], c: 2, h: "C√¥ng th·ª©c: Gi√° tr·ªã 1 ph·∫ßn = Hi·ªáu : Hi·ªáu s·ªë ph·∫ßn." },
            { q: "C√¥ng th·ª©c t√¨m S·ªë b√© l√†:", a: ["Gi√° tr·ªã 1 ph·∫ßn √ó s·ªë ph·∫ßn s·ªë l·ªõn", "Hi·ªáu √ó s·ªë ph·∫ßn s·ªë b√©", "Gi√° tr·ªã 1 ph·∫ßn √ó s·ªë ph·∫ßn s·ªë b√©", "Hi·ªáu : s·ªë ph·∫ßn s·ªë b√©"], c: 2, h: "S·ªë b√© chi·∫øm bao nhi√™u ph·∫ßn th√¨ ta nh√¢n gi√° tr·ªã 1 ph·∫ßn v·ªõi s·ªë ƒë√≥." },
            { q: "T·ªâ s·ªë l√† 2/7, hi·ªáu s·ªë ph·∫ßn b·∫±ng nhau l√†:", a: ["9 ph·∫ßn", "14 ph·∫ßn", "5 ph·∫ßn", "2 ph·∫ßn"], c: 2, h: "L·∫•y 7 - 2 = 5 ph·∫ßn." },
            { q: "ƒê·ªÉ t√¨m s·ªë l·ªõn sau khi ƒë√£ c√≥ gi√° tr·ªã 1 ph·∫ßn, ta l√†m g√¨?", a: ["L·∫•y gi√° tr·ªã 1 ph·∫ßn nh√¢n v·ªõi s·ªë ph·∫ßn c·ªßa s·ªë l·ªõn", "L·∫•y s·ªë b√© c·ªông v·ªõi Hi·ªáu", "C·∫£ A v√† B ƒë·ªÅu ƒë√∫ng", "L·∫•y s·ªë b√© tr·ª´ ƒëi Hi·ªáu"], c: 2, h: "S·ªë l·ªõn lu√¥n b·∫±ng s·ªë b√© c·ªông hi·ªáu ho·∫∑c t√≠nh theo ph·∫ßn." },
            { q: "Trong s∆° ƒë·ªì b√†i to√°n Hi·ªáu - T·ªâ, ƒëo·∫°n th·∫≥ng th·ª´a ra bi·ªÉu th·ªã ƒë·∫°i l∆∞·ª£ng n√†o?", a: ["S·ªë b√©", "S·ªë l·ªõn", "Hi·ªáu c·ªßa hai s·ªë", "T·ªïng c·ªßa hai s·ªë"], c: 2, h: "ƒê√≥ ch√≠nh l√† s·ª± ch√™nh l·ªách gi·ªØa hai s·ªë." },
            { q: "N·∫øu s·ªë l·ªõn g·∫•p 4 l·∫ßn s·ªë b√©, t·ªâ s·ªë gi·ªØa s·ªë b√© v√† s·ªë l·ªõn l√†?", a: ["1/4", "4/1", "4/5", "1/5"], c: 0, h: "S·ªë b√© l√† 1 ph·∫ßn, s·ªë l·ªõn l√† 4 ph·∫ßn." }
        ],
        [ // Ch·∫∑ng 2: T√≠nh to√°n (8 c√¢u)
            { q: "Hi·ªáu l√† 24, t·ªâ s·ªë l√† 1/3. S·ªë b√© l√† bao nhi√™u?", a: ["8", "12", "6", "24"], c: 1, h: "Hi·ªáu s·ªë ph·∫ßn: 2. M·ªôt ph·∫ßn: 24:2=12. S·ªë b√©: 12x1=12." },
            { q: "Hi·ªáu c·ªßa hai s·ªë l√† 150. S·ªë l·ªõn g·∫•p 3 l·∫ßn s·ªë b√©. S·ªë l·ªõn l√†:", a: ["225", "75", "150", "300"], c: 0, h: "Hi·ªáu s·ªë ph·∫ßn: 2. M·ªôt ph·∫ßn: 150:2=75. S·ªë l·ªõn: 75x3=225." },
            { q: "T·ªâ s·ªë l√† 5/2, hi·ªáu l√† 21. S·ªë b√© l√†:", a: ["14", "35", "7", "21"], c: 0, h: "Hi·ªáu s·ªë ph·∫ßn: 3. M·ªôt ph·∫ßn: 21:3=7. S·ªë b√©: 7x2=14." },
            { q: "Hi·ªáu l√† 12. T·ªâ s·ªë l√† 7/4. S·ªë l·ªõn l√†:", a: ["16", "28", "4", "36"], c: 1, h: "Hi·ªáu s·ªë ph·∫ßn: 3. M·ªôt ph·∫ßn: 12:3=4. S·ªë l·ªõn: 4x7=28." },
            { q: "Hi·ªáu l√† 45, s·ªë b√© b·∫±ng 1/6 s·ªë l·ªõn. S·ªë b√© l√†:", a: ["9", "54", "45", "15"], c: 0, h: "Hi·ªáu s·ªë ph·∫ßn: 5. M·ªôt ph·∫ßn: 45:5=9." },
            { q: "S·ªë l·ªõn h∆°n s·ªë b√© 36 ƒë∆°n v·ªã. T·ªâ s·ªë l√† 3/5. S·ªë l·ªõn l√†:", a: ["54", "90", "18", "12"], c: 1, h: "Hi·ªáu s·ªë ph·∫ßn: 2. M·ªôt ph·∫ßn: 36:2=18. S·ªë l·ªõn: 18x5=90." },
            { q: "T√¨m hai s·ªë c√≥ hi·ªáu l√† 10 v√† t·ªâ s·ªë l√† 2. Hai s·ªë ƒë√≥ l√†:", a: ["10 v√† 20", "20 v√† 30", "5 v√† 15", "8 v√† 18"], c: 0, h: "S·ªë l·ªõn g·∫•p ƒë√¥i s·ªë b√© v√† h∆°n 10 ƒë∆°n v·ªã." },
            { q: "Hi·ªáu l√† 60. S·ªë b√© b·∫±ng 2/5 s·ªë l·ªõn. S·ªë l·ªõn l√†:", a: ["100", "40", "20", "120"], c: 0, h: "Hi·ªáu ph·∫ßn: 3. M·ªôt ph·∫ßn: 20. S·ªë l·ªõn: 20x5=100." }
        ],
        [ // Ch·∫∑ng 3: ·ª®ng d·ª•ng (8 c√¢u)
            { q: "M·∫π h∆°n con 28 tu·ªïi. Tu·ªïi con b·∫±ng 1/5 tu·ªïi m·∫π. Tu·ªïi con l√†:", a: ["5 tu·ªïi", "6 tu·ªïi", "7 tu·ªïi", "8 tu·ªïi"], c: 2, h: "Hi·ªáu s·ªë ph·∫ßn: 4. M·ªôt ph·∫ßn: 28:4=7. Con l√† 7 tu·ªïi." },
            { q: "Chi·ªÅu d√†i h∆°n chi·ªÅu r·ªông 15m. T·ªâ s·ªë l√† 5/2. Chi·ªÅu d√†i l√†:", a: ["25m", "10m", "5m", "30m"], c: 0, h: "Hi·ªáu s·ªë ph·∫ßn: 3. M·ªôt ph·∫ßn: 5m. D√†i: 5x5=25m." },
            { q: "C√≥ hai t√∫i r√°c, t√∫i A n·∫∑ng h∆°n t√∫i B 6kg. T√∫i B b·∫±ng 2/3 t√∫i A. T√∫i A n·∫∑ng:", a: ["12kg", "18kg", "6kg", "24kg"], c: 1, h: "Hi·ªáu s·ªë ph·∫ßn: 1. T√∫i A: 6x3=18kg." },
            { q: "Hi·ªáu hai s·ªë l√† s·ªë b√© nh·∫•t c√≥ hai ch·ªØ s·ªë (10), t·ªâ s·ªë l√† 3/1. S·ªë l·ªõn l√†:", a: ["15", "10", "30", "5"], c: 0, h: "Hi·ªáu s·ªë ph·∫ßn: 2. M·ªôt ph·∫ßn: 5. S·ªë l·ªõn: 5x3=15." },
            { q: "S·ª£i d√¢y th·ª© nh·∫•t ng·∫Øn h∆°n s·ª£i th·ª© hai 12m. T·ªâ s·ªë l√† 3/7. T·ªïng ƒë·ªô d√†i 2 s·ª£i d√¢y l√†:", a: ["21m", "30m", "9m", "36m"], c: 1, h: "Hi·ªáu ph·∫ßn: 4. M·ªôt ph·∫ßn: 3m. S·ª£i 1: 9m, S·ª£i 2: 21m. T·ªïng: 30m." },
            { q: "Th√πng 1 √≠t h∆°n th√πng 2 l√† 20 l√≠t d·∫ßu. T·ªâ s·ªë l√† 3/5. Th√πng 1 c√≥:", a: ["30 l√≠t", "50 l√≠t", "20 l√≠t", "10 l√≠t"], c: 0, h: "Hi·ªáu ph·∫ßn: 2. M·ªôt ph·∫ßn: 10. Th√πng 1: 10x3=30." },
            { q: "M·ªôt m·∫£nh v∆∞·ªùn h√¨nh ch·ªØ nh·∫≠t c√≥ chi·ªÅu d√†i h∆°n chi·ªÅu r·ªông 20m. T·ªâ s·ªë l√† 3/2. Chu vi v∆∞·ªùn l√†:", a: ["100m", "200m", "50m", "240m"], c: 1, h: "D√†i 60, R·ªông 40. Chu vi: (60+40)x2=200m." },
            { q: "S·ªë g√† nhi·ªÅu h∆°n s·ªë v·ªãt l√† 12 con. T·ªâ s·ªë g√† v√† v·ªãt l√† 4/1. H·ªèi c√≥ bao nhi√™u g√†?", a: ["16 con", "4 con", "12 con", "8 con"], c: 0, h: "Hi·ªáu ph·∫ßn: 3. M·ªôt ph·∫ßn: 4. G√†: 4x4=16." }
        ]
    ];

    let curLvl = 0, curQ = 0, totalScore = 0;
    let currentPool = []; // Ch·ª©a 4 c√¢u ƒë∆∞·ª£c ch·ªçn ng·∫´u nhi√™n
    let startTime = Date.now();

    // H√ÄM TR√ÅO V√Ä CH·ªåN C√ÇU H·ªéI
    function prepareStage() {
        let pool = [...allQuizData[curLvl]];
        // Tr√°o ng·∫´u nhi√™n 8 c√¢u
        pool.sort(() => Math.random() - 0.5);
        // L·∫•y 4 c√¢u ƒë·∫ßu ti√™n
        currentPool = pool.slice(0, 4);
        curQ = 0;
    }

    function show() {
        let q = currentPool[curQ];
        document.getElementById('q-text').innerHTML = `<b>C√¢u ${curLvl * 4 + curQ + 1}:</b> ${q.q}`;
        document.getElementById('options').innerHTML = q.a.map((opt, i) => `<button class="opt-btn" onclick="check(${i})">${opt}</button>`).join('');
        document.getElementById('feedback').classList.add('hidden');
        document.getElementById('q-counter').innerText = `C√¢u: ${curQ + 1}/4`;
        document.getElementById('score-counter').innerText = `ƒêi·ªÉm: ${totalScore}`;
    }

    function check(idx) {
        let q = currentPool[curQ];
        let btns = document.querySelectorAll('.opt-btn');
        btns.forEach(b => b.disabled = true);
        if(idx === q.c) {
            totalScore++;
            btns[idx].style.background = "#C8E6C9";
            showFeedback("R·∫•t ch√≠nh x√°c! üåü");
        } else {
            btns[idx].style.background = "#FFCDD2";
            btns[q.c].style.background = "#C8E6C9";
            showFeedback(q.h);
        }
        setTimeout(() => {
            curQ++;
            if(curQ < 4) show();
            else finishStage();
        }, 2200);
    }

    function showFeedback(m) {
        document.getElementById('feedback').classList.remove('hidden');
        document.getElementById('feedback-text').innerText = m;
    }

    function finishStage() {
        document.getElementById('play-area').classList.add('hidden');
        if (curLvl < 2) {
            document.getElementById('next-lvl-screen').classList.remove('hidden');
            document.getElementById('lvl-score-info').innerText = `Ho√†n th√†nh Ch·∫∑ng ${curLvl+1}. ƒêi·ªÉm hi·ªán t·∫°i: ${totalScore}/12`;
        } else {
            document.getElementById('result-box').classList.remove('hidden');
            document.getElementById('total-score-info').innerText = `${totalScore} / 12 ƒêI·ªÇM`;
        }
    }

    function continueToNext() {
        curLvl++; 
        prepareStage();
        document.querySelectorAll('.lvl-btn').forEach((b, i) => b.classList.toggle('active', i === curLvl));
        document.getElementById('next-lvl-screen').classList.add('hidden');
        document.getElementById('play-area').classList.remove('hidden');
        show();
    }

   function saveResult() {
        const name = document.getElementById('player-name').value.trim();
        const className = document.getElementById('player-class').value.trim();
        if (!name || !className) { alert("Nh·∫≠p t√™n v√† l·ªõp nh√©!"); return; }

        const duration = Math.floor((Date.now() - startTime) / 1000);
        const userKey = (className + "_" + name).replace(/[\s\/.\#\$\[\]]/g, '_');

        // 1. L∆∞u v√†o Firebase c·ªßa ri√™ng trang Hi·ªáu - T·ªâ
        db.ref('scores/Hieu_Va_Ti_So/' + userKey).set({
            fullName: name,
            className: "'" + className,
            score: totalScore,
            duration: duration,
            date: new Date().toLocaleString('vi-VN'),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            alert("ƒê√£ ghi danh th√†nh c√¥ng! üèÜ");

            // 2. --- ƒêO·∫†N CODE K·∫æT N·ªêI H·ªÜ TH·ªêNG EDURobot (C√ÅCH B) ---
            if (window.parent !== window) {
                // B√°o cho trang play.html bi·∫øt ƒë√£ xong tu·∫ßn 22
                window.parent.postMessage({
                    type: 'GAME_COMPLETE',
                    score: totalScore,
                    week: 22 // Tu·∫ßn 22: B√†i to√°n Hi·ªáu - T·ªâ
                }, '*');
            } else {
                // N·∫øu ch·∫°y link tr·ª±c ti·∫øp
                location.href = "index.html";
            }
            // ---------------------------------------------------
        }).catch((err) => {
            console.error("L·ªói:", err);
            alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi h·ªá th·ªëng!");
        });
    }

    window.onload = () => {
        prepareStage();
        show();
    };
</script>
</body>
</html>
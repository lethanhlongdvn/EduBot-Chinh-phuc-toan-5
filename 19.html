<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫¢N ƒê·ªí KHO B√ÅO - Tu·∫ßn 19 - EduRobot.id.vn</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --p: #FF9800; --s: #2196F3; --bg: #0f172a; --card: #1e293b; --success: #2ecc71; --danger: #e74c3c; }
        body { font-family: 'Lexend', sans-serif; background: var(--bg); color: white; margin: 0; padding-bottom: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; user-select: none; }
        .container { max-width: 850px; width: 95%; padding: 10px; text-align: center; }
        
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; width: 100%; color: var(--p); font-size: 0.9rem; }
        .screen { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 15px; color: #1e272e; border: 4px solid #bdc3c7; box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
        
        /* V√íNG 1: GH√âP ƒê√îI - T·ªëi ∆∞u chi·ªÅu cao √¥ */
        .matching-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .match-card { background: var(--card); color: white; padding: 5px; border-radius: 6px; cursor: pointer; border: 2px solid transparent; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; min-height: 55px; transition: 0.2s; line-height: 1.2; }
        @media (min-width: 600px) { .match-card { font-size: 0.85rem; min-height: 65px; } }
        .match-card.selected { border-color: var(--p); background: #334155; }
        .match-card.matched { visibility: hidden; opacity: 0; pointer-events: none; }

        /* V√íNG 2: K√âO TH·∫¢ */
        .v2-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .v2-td-q { width: 60%; padding: 10px; text-align: left; background: rgba(255,255,255,0.05); border-radius: 8px 0 0 8px; border: 1px solid #334155; font-size: 0.85rem; }
        .v2-td-drop { width: 40%; padding: 8px; background: rgba(255,255,255,0.08); border-radius: 0 8px 8px 0; border: 1px solid #334155; border-left: none; }
        .drop-zone { background: #0f172a; border: 2px dashed #475569; border-radius: 6px; min-height: 40px; display: flex; align-items: center; justify-content: center; color: #64748b; font-size: 0.7rem; }
        .drop-zone.filled { background: var(--s); border-style: solid; color: white; font-weight: bold; font-size: 0.9rem; }
        .drag-items-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 15px; padding: 10px; border: 2px solid var(--p); border-radius: 12px; }
        .draggable { background: var(--p); color: white; padding: 8px 15px; border-radius: 6px; cursor: grab; font-weight: bold; font-size: 0.85rem; }

        /* V√íNG 3: TR·∫ÆC NGHI·ªÜM */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .opt-btn { background: #ecf0f1; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; border-bottom: 4px solid #bdc3c7; color: #2c3e50; font-family: 'Lexend'; font-size: 0.9rem; }
        
        .hidden { display: none !important; }
        .action-btn { background: var(--p); color: white; padding: 12px 30px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 15px; }
        #toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); padding: 12px 30px; border-radius: 50px; font-weight: bold; z-index: 10000; transition: 0.5s; font-size: 0.9rem; }
        .show-toast { top: 30px !important; }
        footer { padding: 15px; font-size: 0.7rem; color: #64748b; text-align: center; }
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="start-screen">
    <h1 style="color: var(--p); font-size: 2rem;">TU·∫¶N 19: B·∫¢N ƒê·ªí KHO B√ÅU</h1>
    <p id="welcome-msg" style="margin-bottom: 20px; font-weight: bold;"></p>
    <button class="action-btn" onclick="startGame()">B·∫ÆT ƒê·∫¶U TH√ÅM HI·ªÇM</button>
</div>

<div id="toast"></div>
<audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3" preload="auto"></audio>
<audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3" preload="auto"></audio>

<div class="container hidden" id="game-ui">
    <div class="status-bar">
        <span id="stage-name">V√íNG 1</span>
        <span id="score-display">ƒêI·ªÇM: 0/100</span>
    </div>

    <div class="screen">
        <div id="q-content" style="font-size: 1rem; font-weight: 600;">...</div>
    </div>

    <div id="play-area"></div>

    <div id="result-screen" class="hidden">
        <h2 id="title-finish">XU·∫§T S·∫ÆC HO√ÄN TH√ÄNH!</h2>
        <h1 id="final-score" style="font-size: 3.5rem; color: var(--p); margin: 5px 0;">0</h1>
        <p id="save-status" style="color: var(--success); font-weight: bold;">ƒêang l∆∞u k·∫øt qu·∫£...</p>
    </div>
</div>

<footer>¬© 2026 EduRobot.id.vn - L√™ Th√†nh Long</footer>

<script>
    const firebaseConfig = { databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const savedName = localStorage.getItem('studentName');
    const savedClass = localStorage.getItem('studentClass');
    let isPlaying = false, score = 0, startTime, stage = 1, lives = 3;

    window.addEventListener('beforeunload', (e) => { if (isPlaying) { e.preventDefault(); e.returnValue = ''; } });

    window.onload = () => {
        if (!savedName) {
            document.getElementById('welcome-msg').innerHTML = "<b style='color:red'>‚ö†Ô∏è Em c·∫ßn ƒëƒÉng k√Ω ·ªü b·∫£n ƒë·ªì tr∆∞·ªõc!</b>";
            document.querySelector('.action-btn').onclick = () => window.location.href = "index.html";
        } else {
            document.getElementById('welcome-msg').innerText = `Th√≠ sinh: ${savedName} - L·ªõp ${savedClass}`;
        }
    };

    const DATA = {
        V1: [
            {p: "T·ªâ s·ªë c·ªßa a v√† b", a: "a : b"}, {p: "B√∫t ƒë·ªè 4, Xanh 9", a: "4 : 9"},
            {p: "Nam 12, N·ªØ 13", a: "12 : 13"}, {p: "Xe t·∫£i 7, Con 3. T·ªâ s·ªë xe t·∫£i v√† t·ªïng", a: "7 : 10"},
            {p: "T·ªïng 60, T·ªâ s·ªë 7:8. S·ªë l·ªõn", a: "32"}, {p: "G√† tr·ªëng 7, M√°i 10. T·ªâ s·ªë m√°i v√† tr·ªëng", a: "10 : 7"},
            {p: "H·ªôp c√≥ 5 bi xanh, 8 bi ƒë·ªè. T·ªâ s·ªë xanh v√† ƒë·ªè", a: "5 : 8"}, {p: "M·∫π 35 tu·ªïi, Con 10 tu·ªïi. T·ªâ s·ªë tu·ªïi con/m·∫π", a: "10 : 35"},
            {p: "L·ªõp 30 b·∫°n, 18 n·ªØ. T·ªâ s·ªë n·ªØ v√† nam", a: "18 : 12"}, {p: "Qu√£ng ƒë∆∞·ªùng 50km, ƒëi 20km. T·ªâ s·ªë ch∆∞a ƒëi/ƒë√£ ƒëi", a: "30 : 20"}
        ],
        V2: [
            {q: "B·∫£n ƒë·ªì 1:10.000, 1cm b·∫±ng bao nhi√™u m?", a: "100 m"},
            {q: "B·∫£n ƒë·ªì 1:1.000, 6cm b·∫±ng bao nhi√™u m?", a: "60 m"},
            {q: "B·∫£n ƒë·ªì 1:1.000.000, 160km b·∫±ng bao nhi√™u cm?", a: "16 cm"},
            {q: "B·∫£n ƒë·ªì 1:10.000.000, 5cm b·∫±ng bao nhi√™u km?", a: "500 km"},
            {q: "B·∫£n ƒë·ªì 1:3.000, 1500m b·∫±ng bao nhi√™u cm?", a: "50 cm"}
        ],
        V3: [
            {q: "T·ªâ l·ªá b·∫£n ƒë·ªì 1 : 1 000 000. 1cm ·ª©ng v·ªõi bao nhi√™u km?", opts: ["10 km", "100 km", "1 km", "1000 km"], c: 0},
            {q: "T·ªâ l·ªá 1 : 500 nghƒ©a l√† v·∫≠t th·ª±c t·∫ø ƒë√£ ƒë∆∞·ª£c?", opts: ["Ph√≥ng to 500 l·∫ßn", "Thu nh·ªè 500 l·∫ßn", "Gi·ªØ nguy√™n", "G·∫•p 5 l·∫ßn"], c: 1},
            {q: "S·ªë 0,35 vi·∫øt d∆∞·ªõi d·∫°ng t·ªâ s·ªë ph·∫ßn trƒÉm l√†:", opts: ["0,35%", "3,5%", "35%", "350%"], c: 2},
            {q: "Gi√° tr·ªã c·ªßa 20% s·ªë 500 l√† bao nhi√™u?", opts: ["10", "100", "50", "20"], c: 1},
            {q: "L·ªõp 40 h·ªçc sinh, c√≥ 12 b·∫°n gi·ªèi Anh. T·ªâ s·ªë ph·∫ßn trƒÉm l√†:", opts: ["12%", "40%", "30%", "25%"], c: 2}
        ]
    };

    function startGame() {
        isPlaying = true; startTime = Date.now();
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        initStage1();
    }

    // --- V√íNG 1: GH√âP ƒê√îI ---
    let firstCard = null;
    function initStage1() {
        stage = 1; lives = 3;
        document.getElementById('stage-name').innerText = "V√íNG 1: GH√âP ƒê√îI (M·∫†NG: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è)";
        document.getElementById('q-content').innerText = "Gh√©p 10 c·∫∑p th·∫ª t∆∞∆°ng ·ª©ng. Sai 3 l·∫ßn s·∫Ω chuy·ªÉn v√≤ng.";
        const area = document.getElementById('play-area');
        let cards = [];
        DATA.V1.forEach((item, idx) => {
            cards.push({txt: item.p, pair: idx});
            cards.push({txt: item.a, pair: idx});
        });
        cards = cards.sort(() => Math.random() - 0.5);
        let html = '<div class="matching-grid">';
        cards.forEach((c, i) => { html += `<div class="match-card" id="card-${i}" onclick="handleMatch(${i}, ${c.pair})">${c.txt}</div>`; });
        area.innerHTML = html + '</div>';
    }

    function handleMatch(idx, pairId) {
        const cardEl = document.getElementById(`card-${idx}`);
        if(cardEl.classList.contains('matched') || cardEl.classList.contains('selected')) return;
        cardEl.classList.add('selected');
        if(!firstCard) { firstCard = {idx, pairId}; } 
        else {
            if(firstCard.pairId === pairId && firstCard.idx !== idx) {
                setTimeout(() => {
                    document.getElementById(`card-${firstCard.idx}`).classList.add('matched');
                    document.getElementById(`card-${idx}`).classList.add('matched');
                    score += 4; updateScore(); playSound(true); firstCard = null;
                    if(document.querySelectorAll('.match-card:not(.matched)').length === 0) initStage2();
                }, 300);
            } else {
                playSound(false);
                lives--;
                updateLivesDisplay();
                setTimeout(() => {
                    document.getElementById(`card-${firstCard.idx}`).classList.remove('selected');
                    document.getElementById(`card-${idx}`).classList.remove('selected');
                    firstCard = null;
                    if(lives <= 0) {
                        showToast("H·∫æT M·∫†NG! Chuy·ªÉn v√≤ng 2", "var(--danger)");
                        setTimeout(initStage2, 1000);
                    }
                }, 500);
            }
        }
    }

    function updateLivesDisplay() {
        let hearts = "‚ù§Ô∏è".repeat(lives) + "üñ§".repeat(3-lives);
        document.getElementById('stage-name').innerText = `V√íNG 1: GH√âP ƒê√îI (M·∫†NG: ${hearts})`;
    }

    // --- V√íNG 2: K√âO TH·∫¢ ---
    function initStage2() {
        stage = 2;
        document.getElementById('stage-name').innerText = "V√íNG 2: K√âO TH·∫¢ T·ªà L·ªÜ";
        document.getElementById('q-content').innerText = "K√©o ƒë√°p √°n th·∫£ v√†o √¥ t∆∞∆°ng ·ª©ng.";
        const area = document.getElementById('play-area');
        let questions = [...DATA.V2];
        let answers = shuffle([...DATA.V2.map(i => i.a)]);
        
        let html = `<table class="v2-table">`;
        questions.forEach((q, i) => {
            html += `<tr class="v2-row">
                <td class="v2-td-q">${q.q}</td>
                <td class="v2-td-drop">
                    <div class="drop-zone" ondrop="drop(event, ${i})" ondragover="allowDrop(event)" id="drop-${i}">Th·∫£ v√†o ƒë√¢y</div>
                </td>
            </tr>`;
        });
        html += `</table><div class="drag-items-container" id="drag-items">`;
        answers.forEach((ans, i) => {
            html += `<div class="draggable" draggable="true" ondragstart="drag(event)" id="drag-${i}">${ans}</div>`;
        });
        area.innerHTML = html + `</div><button class="action-btn" onclick="checkStage2()">TI·∫æP T·ª§C</button>`;
        window.stage2Correct = questions.map(i => i.a);
    }

    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
    function drop(ev, idx) {
        ev.preventDefault();
        const data = ev.dataTransfer.setData("text");
        const draggedEl = document.getElementById(data);
        const zone = document.getElementById(`drop-${idx}`);
        zone.innerHTML = draggedEl.innerText;
        zone.classList.add('filled');
        draggedEl.style.display = 'none';
    }

    function checkStage2() {
        let correctCount = 0;
        window.stage2Correct.forEach((ans, i) => {
            if(document.getElementById(`drop-${i}`).innerText.trim() === ans) correctCount++;
        });
        score += (correctCount * 6); updateScore();
        playSound(correctCount === 5);
        setTimeout(initStage3, 1000);
    }

    // --- V√íNG 3: TR·∫ÆC NGHI·ªÜM ---
    let v3Idx = 0;
    function initStage3() {
        stage = 3; v3Idx = 0;
        document.getElementById('stage-name').innerText = "V√íNG 3: V·ªÄ ƒê√çCH";
        renderV3();
    }
    function renderV3() {
        if(v3Idx >= DATA.V3.length) { finishGame(); return; }
        const item = DATA.V3[v3Idx];
        document.getElementById('q-content').innerHTML = `<b>C√¢u ${v3Idx+1}:</b> ${item.q}`;
        let html = `<div class="options-grid">`;
        item.opts.forEach((o, i) => { html += `<button class="opt-btn" onclick="checkV3(${i})">${o}</button>`; });
        document.getElementById('play-area').innerHTML = html + `</div>`;
    }
    function checkV3(idx) {
        if(idx === DATA.V3[v3Idx].c) { score += 6; playSound(true); } else { playSound(false); }
        updateScore(); v3Idx++; setTimeout(renderV3, 800);
    }

    function updateScore() { document.getElementById('score-display').innerText = `ƒêI·ªÇM: ${score}/100`; }
    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }
    function playSound(c) { const s = document.getElementById(c ? 'sound-correct' : 'sound-wrong'); s.currentTime = 0; s.play(); }
    function showToast(msg, color) {
        const t = document.getElementById('toast'); t.innerText = msg; t.style.backgroundColor = color;
        t.classList.add('show-toast'); setTimeout(() => t.classList.remove('show-toast'), 2000);
    }

    function finishGame() {
        isPlaying = false;
        document.getElementById('play-area').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = score;
        const duration = Math.floor((Date.now() - startTime) / 1000);
        const ref = db.ref('scores/Tuan_19');
        ref.once('value', (snap) => {
            let count = 1; const data = snap.val();
            if(data) {
                for(let id in data) {
                    if((data[id].fullName || "").toLowerCase() === savedName.toLowerCase() && data[id].className === savedClass) count++;
                }
            }
            ref.push({
                fullName: savedName, className: savedClass, score: score,
                duration: duration, attempt: count, date: new Date().toLocaleString('vi-VN'),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }, () => {
                document.getElementById('save-status').innerText = `‚úÖ ƒê√£ l∆∞u k·∫øt qu·∫£ l·∫ßn ${count}!`;
                setTimeout(() => window.location.href = "index.html", 3000);
            });
        });
    }
</script>
</body>
</html>
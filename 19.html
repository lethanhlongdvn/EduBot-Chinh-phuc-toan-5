<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BẢN ĐỒ KHO BÁO - Tuần 19 - EduRobot.id.vn</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --p: #FF9800; --s: #2196F3; --bg: #0f172a; --card: #1e293b; --success: #2ecc71; --danger: #e74c3c; }
        body { font-family: 'Lexend', sans-serif; background: var(--bg); color: white; margin: 0; padding-bottom: 50px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; user-select: none; }
        .container { max-width: 850px; width: 100%; padding: 20px; text-align: center; }
        
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; width: 100%; color: var(--p); }
        .screen { background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 25px; color: #1e272e; border: 5px solid #bdc3c7; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* VÒNG 1: GHÉP ĐÔI */
        .matching-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .match-card { background: var(--card); color: white; padding: 10px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; min-height: 70px; transition: 0.2s; overflow: hidden; }
        .match-card.selected { border-color: var(--p); background: #334155; }
        .match-card.matched { visibility: hidden; opacity: 0; pointer-events: none; }

        /* VÒNG 2: KÉO THẢ */
        .v2-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .v2-row td { vertical-align: middle; }
        .v2-td-q { width: 60%; padding: 15px; text-align: left; background: rgba(255,255,255,0.05); border-radius: 10px 0 0 10px; border: 1px solid #334155; font-size: 0.95rem; }
        .v2-td-drop { width: 40%; padding: 10px; background: rgba(255,255,255,0.08); border-radius: 0 10px 10px 0; border: 1px solid #334155; border-left: none; }
        .drop-zone { background: #0f172a; border: 2px dashed #475569; border-radius: 8px; min-height: 50px; display: flex; align-items: center; justify-content: center; color: #64748b; font-size: 0.8rem; transition: 0.3s; }
        .drop-zone.filled { background: var(--s); border-style: solid; color: white; border-color: white; font-weight: bold; font-size: 1rem; }
        .drag-items-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; padding: 15px; border: 2px solid var(--p); border-radius: 15px; }
        .draggable { background: var(--p); color: white; padding: 10px 20px; border-radius: 8px; cursor: grab; font-weight: bold; box-shadow: 0 4px 0 #e68a00; }

        /* VÒNG 3: TRẮC NGHIỆM */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .opt-btn { background: #ecf0f1; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; border-bottom: 4px solid #bdc3c7; color: #2c3e50; font-family: 'Lexend'; font-size: 1rem; }
        
        .hidden { display: none !important; }
        .action-btn { background: var(--p); color: white; padding: 15px 40px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 20px; }
        #toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); padding: 15px 40px; border-radius: 50px; font-weight: bold; z-index: 10000; transition: 0.5s; }
        .show-toast { top: 50px !important; }
        footer { margin-top: auto; padding: 20px; font-size: 0.8rem; color: #64748b; }
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="start-screen">
    <h1 style="color: var(--p); font-size: 2.5rem;">TUẦN 19: BẢN ĐỒ KHO BÁU</h1>
    <p id="welcome-msg" style="margin-bottom: 30px; font-weight: bold;"></p>
    <button class="action-btn" onclick="startGame()">BẮT ĐẦU THÁM HIỂM</button>
</div>

<div id="toast"></div>
<audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3" preload="auto"></audio>
<audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3" preload="auto"></audio>

<div class="container hidden" id="game-ui">
    <div class="status-bar">
        <span id="stage-name">VÒNG 1</span>
        <span id="score-display">ĐIỂM: 0/100</span>
    </div>

    <div class="screen">
        <div id="q-content" style="font-size: 1.1rem; font-weight: 600;">...</div>
    </div>

    <div id="play-area"></div>

    <div id="result-screen" class="hidden">
        <h2 id="title-finish">XUẤT SẮC HOÀN THÀNH!</h2>
        <h1 id="final-score" style="font-size: 4rem; color: var(--p); margin: 10px 0;">0</h1>
        <p id="save-status" style="color: var(--success); font-weight: bold;">Hệ thống đang lưu kết quả...</p>
    </div>
</div>

<footer>© 2026 EduRobot.id.vn - Lê Thành Long</footer>

<script>
    const firebaseConfig = { databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const savedName = localStorage.getItem('studentName');
    const savedClass = localStorage.getItem('studentClass');
    let isPlaying = false, score = 0, startTime, stage = 1;

    // Ngăn chặn F5 khi đang làm bài
    window.addEventListener('beforeunload', (e) => { if (isPlaying) { e.preventDefault(); e.returnValue = ''; } });

    window.onload = () => {
        if (!savedName) {
            document.getElementById('welcome-msg').innerHTML = "<b style='color:red'>⚠️ Em cần đăng ký tên ở bản đồ trước!</b>";
            document.querySelector('.action-btn').onclick = () => window.location.href = "index.html";
        } else {
            document.getElementById('welcome-msg').innerText = `Thí sinh: ${savedName} - Lớp ${savedClass}`;
        }
    };

    const DATA = {
        V1: [
            {p: "Tỉ số của a và b", a: "a : b"}, {p: "Bút đỏ 4, Xanh 9", a: "4 : 9"},
            {p: "Nam 12, Nữ 13", a: "12 : 13"}, {p: "Xe tải 7, Con 3. Tỉ số xe tải và tổng", a: "7 : 10"},
            {p: "Tổng 60, Tỉ số 7:8. Số lớn", a: "32"}, {p: "Gà trống 7, Mái 10. Tỉ số mái và trống", a: "10 : 7"},
            {p: "Hộp có 5 bi xanh, 8 bi đỏ. Tỉ số xanh và đỏ", a: "5 : 8"}, {p: "Mẹ 35 tuổi, Con 10 tuổi. Tỉ số tuổi con/mẹ", a: "10 : 35"},
            {p: "Lớp 30 bạn, 18 nữ. Tỉ số nữ và nam", a: "18 : 12"}, {p: "Quãng đường 50km, đi 20km. Tỉ số chưa đi/đã đi", a: "30 : 20"}
        ],
        V2: [
            {q: "Bản đồ 1:10.000, 1cm bằng bao nhiêu m?", a: "100 m"},
            {q: "Bản đồ 1:1.000, 6cm bằng bao nhiêu m?", a: "60 m"},
            {q: "Bản đồ 1:1.000.000, 160km bằng bao nhiêu cm?", a: "16 cm"},
            {q: "Bản đồ 1:10.000.000, 5cm bằng bao nhiêu km?", a: "500 km"},
            {q: "Bản đồ 1:3.000, 1500m bằng bao nhiêu cm?", a: "50 cm"}
        ],
        V3: [
            {q: "Tỉ lệ bản đồ 1 : 1 000 000. 1cm ứng với bao nhiêu km thực tế?", opts: ["10 km", "100 km", "1 km", "1000 km"], c: 0},
            {q: "Tỉ lệ 1 : 500 nghĩa là vật thực tế đã được?", opts: ["Phóng to 500 lần", "Thu nhỏ 500 lần", "Giữ nguyên", "Gấp 5 lần"], c: 1},
            {q: "Số 0,35 viết dưới dạng tỉ số phần trăm là:", opts: ["0,35%", "3,5%", "35%", "350%"], c: 2},
            {q: "Giá trị của 20% số 500 là bao nhiêu?", opts: ["10", "100", "50", "20"], c: 1},
            {q: "Lớp 40 học sinh, có 12 bạn giỏi Anh. Tỉ số phần trăm là:", opts: ["12%", "40%", "30%", "25%"], c: 2}
        ]
    };

    function startGame() {
        isPlaying = true; startTime = Date.now();
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        initStage1();
    }

    // --- VÒNG 1: GHÉP ĐÔI ---
    let firstCard = null;
    function initStage1() {
        stage = 1;
        document.getElementById('stage-name').innerText = "VÒNG 1: GHÉP ĐÔI TỈ SỐ";
        document.getElementById('q-content').innerText = "Hãy ghép các cặp thẻ Tỉ số tương ứng (10 cặp). Mỗi cặp +4đ.";
        const area = document.getElementById('play-area');
        let cards = [];
        DATA.V1.forEach((item, idx) => {
            cards.push({txt: item.p, pair: idx});
            cards.push({txt: item.a, pair: idx});
        });
        cards = cards.sort(() => Math.random() - 0.5);
        let html = '<div class="matching-grid">';
        cards.forEach((c, i) => { html += `<div class="match-card" id="card-${i}" onclick="handleMatch(${i}, ${c.pair})">${c.txt}</div>`; });
        area.innerHTML = html + '</div>';
    }

    function handleMatch(idx, pairId) {
        const cardEl = document.getElementById(`card-${idx}`);
        if(cardEl.classList.contains('matched') || cardEl.classList.contains('selected')) return;
        cardEl.classList.add('selected');
        if(!firstCard) { firstCard = {idx, pairId}; } 
        else {
            if(firstCard.pairId === pairId && firstCard.idx !== idx) {
                setTimeout(() => {
                    document.getElementById(`card-${firstCard.idx}`).classList.add('matched');
                    document.getElementById(`card-${idx}`).classList.add('matched');
                    score += 4; updateScore(); playSound(true); firstCard = null;
                    if(document.querySelectorAll('.match-card:not(.matched)').length === 0) initStage2();
                }, 300);
            } else {
                playSound(false);
                setTimeout(() => {
                    document.getElementById(`card-${firstCard.idx}`).classList.remove('selected');
                    document.getElementById(`card-${idx}`).classList.remove('selected');
                    firstCard = null;
                }, 500);
            }
        }
    }

    // --- VÒNG 2: KÉO THẢ (2 CỘT NGANG HÀNG) ---
    function initStage2() {
        stage = 2;
        document.getElementById('stage-name').innerText = "VÒNG 2: KÉO THẢ TỈ LỆ";
        document.getElementById('q-content').innerText = "Kéo đáp án bên dưới thả vào ô tương ứng. Mỗi câu +6đ.";
        const area = document.getElementById('play-area');
        let questions = [...DATA.V2];
        let answers = shuffle([...DATA.V2.map(i => i.a)]);
        
        let html = `<table class="v2-table">`;
        questions.forEach((q, i) => {
            html += `<tr class="v2-row">
                <td class="v2-td-q"><b>Bài ${i+1}:</b> ${q.q}</td>
                <td class="v2-td-drop">
                    <div class="drop-zone" ondrop="drop(event, ${i})" ondragover="allowDrop(event)" id="drop-${i}">Kéo thả vào đây</div>
                </td>
            </tr>`;
        });
        html += `</table><div class="drag-items-container" id="drag-items">`;
        answers.forEach((ans, i) => {
            html += `<div class="draggable" draggable="true" ondragstart="drag(event)" id="drag-${i}">${ans}</div>`;
        });
        area.innerHTML = html + `</div><button class="action-btn" onclick="checkStage2()">KIỂM TRA VÒNG 2</button>`;
        window.stage2Correct = questions.map(i => i.a);
    }

    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
    function drop(ev, idx) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");
        const draggedEl = document.getElementById(data);
        const zone = document.getElementById(`drop-${idx}`);
        zone.innerHTML = draggedEl.innerText;
        zone.classList.add('filled');
        draggedEl.style.display = 'none';
    }

    function checkStage2() {
        let correctCount = 0;
        window.stage2Correct.forEach((ans, i) => {
            if(document.getElementById(`drop-${i}`).innerText.trim() === ans) correctCount++;
        });
        score += (correctCount * 6); updateScore();
        playSound(correctCount === 5);
        showToast(`Bạn đúng ${correctCount}/5 câu Vòng 2!`, correctCount === 5 ? "var(--success)" : "var(--danger)");
        setTimeout(initStage3, 2000);
    }

    // --- VÒNG 3: TRẮC NGHIỆM ---
    let v3Idx = 0;
    function initStage3() {
        stage = 3; v3Idx = 0;
        document.getElementById('stage-name').innerText = "VÒNG 3: VỀ ĐÍCH";
        renderV3();
    }
    function renderV3() {
        if(v3Idx >= DATA.V3.length) { finishGame(); return; }
        const item = DATA.V3[v3Idx];
        document.getElementById('q-content').innerHTML = `<b>Câu ${v3Idx+1}:</b> ${item.q}`;
        let html = `<div class="options-grid">`;
        item.opts.forEach((o, i) => { html += `<button class="opt-btn" onclick="checkV3(${i})">${o}</button>`; });
        document.getElementById('play-area').innerHTML = html + `</div>`;
    }
    function checkV3(idx) {
        if(idx === DATA.V3[v3Idx].c) { score += 6; playSound(true); } else { playSound(false); }
        updateScore(); v3Idx++; setTimeout(renderV3, 800);
    }

    function updateScore() { document.getElementById('score-display').innerText = `ĐIỂM: ${score}/100`; }
    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }
    function playSound(c) { const s = document.getElementById(c ? 'sound-correct' : 'sound-wrong'); s.currentTime = 0; s.play(); }
    function showToast(msg, color) {
        const t = document.getElementById('toast'); t.innerText = msg; t.style.backgroundColor = color;
        t.classList.add('show-toast'); setTimeout(() => t.classList.remove('show-toast'), 2000);
    }

    function finishGame() {
        isPlaying = false;
        document.getElementById('play-area').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = score;
        const duration = Math.floor((Date.now() - startTime) / 1000);
        const ref = db.ref('scores/Tuan_19');
        ref.once('value', (snap) => {
            let count = 1; const data = snap.val();
            if(data) {
                for(let id in data) {
                    const oldName = (data[id].fullName || data[id].name || "").toLowerCase();
                    if(oldName === savedName.toLowerCase() && data[id].className === savedClass) count++;
                }
            }
            ref.push({
                fullName: savedName, className: savedClass, score: score,
                duration: duration, attempt: count, date: new Date().toLocaleString('vi-VN'),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }, () => {
                document.getElementById('save-status').innerText = `✅ Đã lưu kết quả lần ${count}! Đang quay lại...`;
                setTimeout(() => window.location.href = "index.html", 3000);
            });
        });
    }
</script>
</body>
</html>
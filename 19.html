<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£n ƒë·ªì kho b√°u - Tu·∫ßn 19</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #FF9800; --secondary: #2196F3; --success: #4CAF50; --danger: #f44336; --bg: #FFFBF0; }
        body { font-family: 'Lexend', Arial, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 750px; width: 100%; background: white; padding: 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 10px solid var(--primary); }
        .header-box { width: 100%; border-radius: 15px; height: 80px; margin-bottom: 20px; background: linear-gradient(135deg, #FFF3E0, #FFE0B2); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; border: 1px solid #EEE; }
        .header-box h2 { color: var(--primary); margin: 0; font-size: 1.4rem; }
        .header-box p { color: #888; font-size: 0.85rem; margin: 2px 0 0 0; }
        .progress-container { height: 10px; background: #EEE; border-radius: 6px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: 0.5s; }
        .level-map { display: flex; gap: 10px; margin-bottom: 20px; }
        .lvl-btn { flex: 1; padding: 10px 5px; border: none; border-radius: 12px; background: #F5F5F5; font-family: 'Lexend'; font-size: 0.8rem; color: #888; pointer-events: none; }
        .lvl-btn.active { background: var(--primary); color: white; font-weight: bold; border-bottom: 3px solid #E68A00; }
        .question-area { min-height: 140px; text-align: center; }
        .q-text { font-size: 1.1rem; color: #333; margin-bottom: 15px; line-height: 1.5; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .opt { padding: 12px; border: 2px solid #F0F0F0; border-radius: 12px; background: white; cursor: pointer; transition: 0.2s; font-size: 0.95rem; font-family: 'Lexend'; }
        .opt:hover:not(:disabled) { border-color: var(--secondary); background: #E3F2FD; }
        .robot-box { display: flex; align-items: center; background: #E1F5FE; padding: 12px; border-radius: 12px; margin-top: 15px; gap: 10px; border-left: 5px solid var(--secondary); font-size: 0.9rem; }
        .hidden { display: none; }
        .action-btn { padding: 12px 25px; background: var(--success); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-family: 'Lexend'; font-size: 1rem; margin-top: 10px; }
        .input-field { padding: 12px; border-radius: 10px; border: 2px solid #ddd; width: 85%; font-family: 'Lexend'; margin-bottom: 10px; font-size: 1rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <h2>üó∫Ô∏è B·∫¢N ƒê·ªí KHO B√ÅU (TU·∫¶N 19)</h2>
        <p>T·ªâ s·ªë, t·ªâ s·ªë ph·∫ßn trƒÉm v√† ·ª©ng d·ª•ng t·ªâ l·ªá b·∫£n ƒë·ªì</p>
    </div>

    <div class="level-map">
        <button id="btn-0" class="lvl-btn active">üèîÔ∏è CH·∫∂NG 1<br>Kh√°m ph√°</button>
        <button id="btn-1" class="lvl-btn">üå≤ CH·∫∂NG 2<br>Luy·ªán t·∫≠p</button>
        <button id="btn-2" class="lvl-btn">üèÜ CH·∫∂NG 3<br>V·ªÅ ƒë√≠ch</button>
    </div>

    <div class="progress-container"><div id="progress" class="progress-bar"></div></div>

    <div id="game-content">
        <div style="display: flex; justify-content: space-between; font-weight: bold; color: #555; margin-bottom: 10px; font-size: 0.9rem;">
            <span id="lvl-title">Kh·ªüi h√†nh!</span>
            <span id="score-display">T·ªïng ƒëi·ªÉm: 0/100</span>
        </div>
        <div class="question-area">
            <p class="q-text" id="q-text">ƒêang t·∫£i...</p>
            <div class="options" id="options"></div>
        </div>
        <div id="robot-hint" class="robot-box hidden">
            <span>ü§ñ:</span> <span id="hint-text"></span>
        </div>
    </div>

    <div id="status-screen" class="hidden" style="text-align: center; padding: 20px;">
        <h2 id="status-title"></h2>
        <p id="status-info" style="font-size: 1.2rem;"></p>
        <button id="status-btn" class="action-btn" onclick="handleStatusAction()"></button>
    </div>

    <div id="result-screen" class="hidden" style="text-align: center; padding: 30px 0;">
        <h2>H√†nh tr√¨nh ho√†n t·∫•t! üèÜ</h2>
        <p id="result-msg" style="font-size: 2.5rem; color: var(--primary); font-weight: bold; margin: 15px 0;"></p>
        <p id="final-advice"></p>
        <div id="save-form" class="hidden">
            <input type="text" id="player-name" class="input-field" placeholder="Nh·∫≠p H·ªç v√† T√™n...">
            <input type="text" id="player-class" class="input-field" placeholder="Nh·∫≠p L·ªõp...">
            <br>
            <button class="action-btn" onclick="saveScoreOnline()">Ghi danh B·∫£ng V√†ng</button>
        </div>
        <button id="retry-btn" class="action-btn hidden" onclick="location.reload()" style="background: var(--secondary);">Ch∆°i l·∫°i t·ª´ ƒë·∫ßu</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
        authDomain: "gamhoctap.firebaseapp.com",
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gamhoctap"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const allQuestionsData = [
        [ // PH·∫¶N 1: KH√ÅM PH√Å (ƒê√£ l·ªçc b·ªè k√Ω hi·ªáu r√°c)
            { q: "Tr√™n b·∫£n ƒë·ªì c√≥ 7 v·ªã tr√≠ hang ƒë√° v√† 10 v·ªã tr√≠ r·ª´ng c√¢y. T·ªâ s·ªë c·ªßa s·ªë hang ƒë√° v√† s·ªë r·ª´ng c√¢y l√†:", a: ["10 : 7", "7 : 10", "7 : 17", "10 : 17"], c: 1, h: "L·∫•y s·ªë hang ƒë√° chia cho s·ªë r·ª´ng c√¢y." },
            { q: "T·ªâ s·ªë c·ªßa s·ªë a v√† s·ªë b (b kh√°c 0) l√† a : b hay a/b. T·ªâ s·ªë n√†y cho bi·∫øt ƒëi·ªÅu g√¨?", a: ["S·ªë a b·∫±ng a/b s·ªë b", "S·ªë b b·∫±ng a/b s·ªë a", "S·ªë a nhi·ªÅu h∆°n b l√† a/b", "S·ªë a k√©m b l√† a/b"], c: 0, h: "ƒê·ªãnh nghƒ©a t·ªâ s·ªë c∆° b·∫£n." },
            { q: "Trong m·ªôt cu·ªôc kh·∫£o s√°t 100 b·∫°n th√¨ c√≥ 43 b·∫°n th√≠ch ƒëi t√¨m kho b√°u. T·ªâ s·ªë ph·∫ßn trƒÉm s·ªë b·∫°n th√≠ch t√¨m kho b√°u l√†:", a: ["4,3%", "0,43%", "43%", "430%"], c: 2, h: "S·ªë l∆∞·ª£ng tr√™n 100 ch√≠nh l√† t·ªâ s·ªë ph·∫ßn trƒÉm." },
            { q: "K√Ω hi·ªáu % trong t·ªâ s·ªë ph·∫ßn trƒÉm ƒë∆∞·ª£c ƒë·ªçc l√†:", a: ["Ph·∫ßn m∆∞·ªùi", "Ph·∫ßn trƒÉm", "Ph·∫ßn ngh√¨n", "ƒê∆°n v·ªã"], c: 1, h: "C√°ch ƒë·ªçc k√Ω hi·ªáu %." },
            { q: "T·ªâ s·ªë 1 : 10 000 ghi ·ªü ph√≠a d∆∞·ªõi m·ªôt b·∫£n ƒë·ªì ƒë∆∞·ª£c g·ªçi l√†:", a: ["T·ªâ s·ªë ƒë·ªô d√†i", "T·ªâ l·ªá b·∫£n ƒë·ªì", "T·ªâ s·ªë ph·∫ßn trƒÉm", "T·ªâ s·ªë x√≠ch"], c: 1, h: "ƒê√¢y l√† kh√°i ni·ªám v·ªÅ t·ªâ l·ªá b·∫£n ƒë·ªì." },
            { q: "T·ªâ l·ªá b·∫£n ƒë·ªì th∆∞·ªùng ƒë∆∞·ª£c vi·∫øt d∆∞·ªõi d·∫°ng m·ªôt ph√¢n s·ªë c√≥ t·ª≠ s·ªë l√†:", a: ["1", "10", "100", "1 000"], c: 0, h: "T·ªâ l·ªá b·∫£n ƒë·ªì ∆∞u ti√™n t·ª≠ s·ªë l√† 1." },
            { q: "T·ªâ l·ªá b·∫£n ƒë·ªì 1 : 500 cho bi·∫øt h√¨nh ·∫£nh tr√™n b·∫£n ƒë·ªì ƒë√£ ƒë∆∞·ª£c:", a: ["Ph√≥ng to 500 l·∫ßn", "Gi·ªØ nguy√™n", "Thu nh·ªè 500 l·∫ßn", "Thu nh·ªè 1 l·∫ßn"], c: 2, h: "S·ªë 500 ·ªü m·∫´u s·ªë ch·ªâ m·ª©c ƒë·ªô thu nh·ªè." },
            { q: "ƒê·ªÉ t√≠nh ƒë·ªô d√†i th·∫≠t khi bi·∫øt ƒë·ªô d√†i b·∫£n ƒë·ªì v√† t·ªâ l·ªá, ta th·ª±c hi·ªán:", a: ["Chia cho m·∫´u s·ªë t·ªâ l·ªá", "Nh√¢n v·ªõi m·∫´u s·ªë t·ªâ l·ªá", "C·ªông v·ªõi m·∫´u s·ªë t·ªâ l·ªá", "L·∫•y m·∫´u s·ªë chia ƒë·ªô d√†i b·∫£n ƒë·ªì"], c: 1, h: "Ph√©p t√≠nh t√¨m ƒë·ªô d√†i th·ª±c t·∫ø." }
        ],
        [ // PH·∫¶N 2: LUY·ªÜN T·∫¨P
            { q: "T·ªâ s·ªë c·ªßa m = 13 v√† n = 17 ƒë∆∞·ª£c vi·∫øt d∆∞·ªõi d·∫°ng ph√¢n s·ªë l√†:", a: ["17/13", "13 : 17", "13/17", "13/30"], c: 2, h: "Vi·∫øt s·ªë ƒë·ª©ng tr∆∞·ªõc l√†m t·ª≠ s·ªë." },
            { q: "Chuy·ªÉn ph√¢n s·ªë 9/25 th√†nh t·ªâ s·ªë ph·∫ßn trƒÉm:", a: ["9%", "36%", "25%", "45%"], c: 1, h: "Nh√¢n c·∫£ t·ª≠ v√† m·∫´u v·ªõi 4 ƒë·ªÉ ƒë∆∞·ª£c m·∫´u 100." },
            { q: "M·ªôt h√≤n ƒë·∫£o c√≥ 100 c√¢y d·ª´a, trong ƒë√≥ c√≥ 92 c√¢y ƒë√£ c√≥ qu·∫£. T·ªâ s·ªë ph·∫ßn trƒÉm s·ªë c√¢y d·ª´a CH∆ØA c√≥ qu·∫£ l√†:", a: ["8%", "92%", "100%", "18%"], c: 0, h: "L·∫•y 100% tr·ª´ ƒëi s·ªë c√¢y ƒë√£ c√≥ qu·∫£." },
            { q: "Tr√™n b·∫£n ƒë·ªì t·ªâ l·ªá 1 : 1 000, kho·∫£ng c√°ch t·ª´ c·ªïng hang ƒë·∫øn r∆∞∆°ng v√†ng ƒëo ƒë∆∞·ª£c 6 cm. ƒê·ªô d√†i th·∫≠t l√†:", a: ["6 m", "60 m", "600 m", "6 000 m"], c: 1, h: "6 x 1000 = 6000cm = 60m." },
            { q: "Qu√£ng ƒë∆∞·ªùng th·ª±c t·∫ø d√†i 160 km. Tr√™n b·∫£n ƒë·ªì t·ªâ l·ªá 1 : 1 000 000, qu√£ng ƒë∆∞·ªùng n√†y d√†i:", a: ["160 cm", "16 cm", "1,6 cm", "16 mm"], c: 1, h: "ƒê·ªïi 160km ra cm r·ªìi chia cho 1.000.000." },
            { q: "K·∫øt qu·∫£ c·ªßa ph√©p t√≠nh: 57% + 43,5% l√†:", a: ["100%", "10,05%", "100,5%", "90,5%"], c: 2, h: "Th·ª±c hi·ªán ph√©p c·ªông s·ªë th·∫≠p ph√¢n." },
            { q: "M·ªôt th·ª£ sƒÉn ƒëi ƒë∆∞·ª£c 35% con ƒë∆∞·ªùng. T·ªâ s·ªë ph·∫ßn trƒÉm con ƒë∆∞·ªùng th·ª£ sƒÉn c√≤n ph·∫£i ƒëi l√†:", a: ["35%", "135%", "65%", "75%"], c: 2, h: "L·∫•y 100% tr·ª´ ƒëi s·ªë ƒë√£ ƒëi." },
            { q: "Tr√™n b·∫£n ƒë·ªì t·ªâ l·ªá 1 : 2 000, kho·∫£ng c√°ch gi·ªØa hai h√≤n ƒë·∫£o l√† 5 cm. ƒê·ªô d√†i th·∫≠t l√†:", a: ["10 m", "100 m", "1 000 m", "10 000 m"], c: 1, h: "5 x 2000 = 10000cm = 100m." }
        ],
        [ // PH·∫¶N 3: N√ÇNG CAO
            { q: "M·∫£nh v∆∞·ªùn HCN tr√™n b·∫£n ƒë·ªì t·ªâ l·ªá 1:3000 c√≥ d√†i 3cm, r·ªông 2cm. Di·ªán t√≠ch th·∫≠t l√†:", a: ["6 m¬≤", "180 m¬≤", "5 400 m¬≤", "540 m¬≤"], c: 2, h: "T√≠nh d√†i th·∫≠t, r·ªông th·∫≠t r·ªìi m·ªõi t√≠nh di·ªán t√≠ch." },
            { q: "B·∫£n ƒë·ªì (1) t·ªâ l·ªá 1:1000 c√≥ 10cm. C√πng qu√£ng ƒë∆∞·ªùng ƒë√≥, b·∫£n ƒë·ªì (2) t·ªâ l·ªá 1:2000 d√†i:", a: ["20 cm", "5 cm", "10 cm", "2 cm"], c: 1, h: "T·ªâ l·ªá c√†ng l·ªõn th√¨ h√¨nh v·∫Ω c√†ng nh·ªè." },
            { q: "Khu b·∫£o t·ªìn h√¨nh vu√¥ng c√≥ chu vi tr√™n b·∫£n ƒë·ªì 1:5000 l√† 16cm. Di·ªán t√≠ch th·∫≠t l√†:", a: ["40 000 m¬≤", "4 ha", "16 ha", "400 m¬≤"], c: 1, h: "C·∫°nh th·∫≠t l√† 200m. 200x200 = 40000m2 = 4ha." },
            { q: "Ch·∫∑ng 1 chi·∫øm 30%. Ch·∫∑ng 2 d√†i h∆°n ch·∫∑ng 1 l√† 40m v√† chi·∫øm 70%. T·ªïng qu√£ng ƒë∆∞·ªùng:", a: ["100 m", "140 m", "200 m", "400 m"], c: 0, h: "Ch·∫∑ng 2 h∆°n Ch·∫∑ng 1 l√† 40% t∆∞∆°ng ·ª©ng 40m." }
        ]
    ];

    let curLvl = 0, curQ = 0, totalScore = 0, correctInStage = 0;
    let currentLvlQuestions = [];
    const Q_COUNT = [4, 4, 2]; // M·ªói ch·∫∑ng l·∫•y s·ªë l∆∞·ª£ng c√¢u h·ªèi nh·∫•t ƒë·ªãnh

    function prepareQuestionsForLevel() {
        let pool = [...allQuestionsData[curLvl]];
        pool.sort(() => Math.random() - 0.5);
        currentLvlQuestions = pool.slice(0, Q_COUNT[curLvl]);
        curQ = 0; correctInStage = 0;
    }

    function showQuestion() {
        let q = currentLvlQuestions[curQ];
        let totalAnswered = (curLvl === 0) ? curQ : (curLvl === 1 ? 4 + curQ : 8 + curQ);
        document.getElementById('q-text').innerHTML = `<b>C√¢u ${totalAnswered + 1}:</b> ${q.q}`;
        document.getElementById('progress').style.width = (totalAnswered / 10 * 100) + "%";
        let html = q.a.map((opt, i) => `<button class="opt" onclick="checkAnswer(${i})">${opt}</button>`).join('');
        document.getElementById('options').innerHTML = html;
        document.getElementById('robot-hint').classList.add('hidden');
        document.getElementById('lvl-title').innerText = "Ch·∫∑ng " + (curLvl + 1);
    }

    function checkAnswer(i) {
        let q = currentLvlQuestions[curQ];
        let btns = document.querySelectorAll('.opt');
        btns.forEach(b => b.disabled = true);
        if(i === q.c) {
            totalScore += 10; correctInStage++;
            btns[i].style.background = "#C8E6C9";
            showRobot("Ch√≠nh x√°c! Ti·∫øp t·ª•c nh√©. ‚ú®");
        } else {
            btns[i].style.background = "#FFCDD2";
            btns[q.c].style.background = "#C8E6C9";
            showRobot("G·ª£i √Ω: " + q.h);
        }
        setTimeout(() => {
            curQ++;
            if(curQ < Q_COUNT[curLvl]) { showQuestion(); updateScoreDisplay(); }
            else { finishStage(); }
        }, 1800);
    }

    function updateScoreDisplay() { document.getElementById('score-display').innerText = `T·ªïng ƒëi·ªÉm: ${totalScore}/100`; }
    function showRobot(m) { document.getElementById('robot-hint').classList.remove('hidden'); document.getElementById('hint-text').innerText = m; }

    function finishStage() {
        document.getElementById('game-content').classList.add('hidden');
        let passThreshold = Q_COUNT[curLvl] / 2; // ƒêi·ªÅu ki·ªán 50%
        if (correctInStage >= passThreshold) {
            if (curLvl < 2) {
                showStatusScreen("V∆∞·ª£t ch·∫∑ng th√†nh c√¥ng! üéâ", `ƒê√∫ng ${correctInStage}/${Q_COUNT[curLvl]} c√¢u. B·∫°n ƒë∆∞·ª£c ƒëi ti·∫øp.`, "Sang ch·∫∑ng ti·∫øp theo ‚ûî", "next");
            } else { showFinalResult(); }
        } else {
            showStatusScreen("Ch∆∞a ƒë·ªß ƒëi·ªÉm qua v√≤ng! üòü", `B·∫°n ƒë√∫ng ${correctInStage}/${Q_COUNT[curLvl]} c√¢u. C·∫ßn ƒë√∫ng 50% ƒë·ªÉ qua ch·∫∑ng.`, "Th·ª≠ l·∫°i ch·∫∑ng n√†y ‚Ü∫", "retry");
        }
    }

    function showStatusScreen(title, info, btnText, type) {
        let screen = document.getElementById('status-screen');
        screen.classList.remove('hidden');
        document.getElementById('status-title').innerText = title;
        document.getElementById('status-info').innerText = info;
        let btn = document.getElementById('status-btn');
        btn.innerText = btnText; btn.setAttribute('data-type', type);
        btn.style.background = (type === 'retry') ? "var(--danger)" : "var(--success)";
    }

    function handleStatusAction() {
        let type = document.getElementById('status-btn').getAttribute('data-type');
        document.getElementById('status-screen').classList.add('hidden');
        if (type === 'next') { curLvl++; } else { totalScore -= (correctInStage * 10); }
        prepareQuestionsForLevel();
        document.querySelectorAll('.lvl-btn').forEach((b, i) => b.classList.toggle('active', i === curLvl));
        document.getElementById('game-content').classList.remove('hidden');
        showQuestion(); updateScoreDisplay();
    }

    function showFinalResult() {
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('result-msg').innerText = `${totalScore} ƒêI·ªÇM`;
        if(totalScore >= 50) {
            document.getElementById('final-advice').innerText = "Ch√∫c m·ª´ng! B·∫°n ƒë√£ chinh ph·ª•c ƒë∆∞·ª£c kho b√°u.";
            document.getElementById('save-form').classList.remove('hidden');
        } else {
            document.getElementById('final-advice').innerText = "C·ªë g·∫Øng ƒë·∫°t 50 ƒëi·ªÉm ƒë·ªÉ ƒë∆∞·ª£c ghi danh nh√©.";
            document.getElementById('retry-btn').classList.remove('hidden');
        }
    }

    function saveScoreOnline() {
        const name = document.getElementById('player-name').value.trim();
        const className = document.getElementById('player-class').value.trim();
        if (!name || !className) { alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n v√† l·ªõp."); return; }
        const userKey = (className + "_" + name).replace(/[\s\/.\#\$\[\]]/g, '_');
        db.ref('scores/Tuan_19_Ban_Do_Kho_Bau/' + userKey).set({
            fullName: name, className: "'" + className, score: totalScore,
            date: new Date().toLocaleString('vi-VN'), timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            alert("Ghi danh th√†nh c√¥ng!");
            location.href = "index.html";
        });
    }

    window.onload = () => { prepareQuestionsForLevel(); showQuestion(); };
</script>
</body>
</html>
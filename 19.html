<script>
    // 1. Cấu hình Firebase
    const firebaseConfig = { 
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app" 
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. Kho dữ liệu câu hỏi (Ngân hàng đề)
    const DATA = {
        V1: [
            {q: "Tỉ số của 7 hang đá và 10 rừng cây là:", opts: ["10:7", "7:10", "7:17", "10:17"], c: 1},
            {q: "Tỉ số a:b (b khác 0) cho biết điều gì?", opts: ["a bằng a/b lần b", "b bằng a/b lần a", "a hơn b a/b đơn vị", "a kém b a/b đơn vị"], c: 0},
            {q: "Có 43 bạn thích kho báu trong 100 bạn. Tỉ số phần trăm là:", opts: ["4,3%", "0,43%", "43%", "430%"], c: 2},
            {q: "Ký hiệu % đọc là:", opts: ["Phần mười", "Phần trăm", "Phần nghìn", "Đơn vị"], c: 1},
            {q: "Tỉ số 1:10 000 dưới bản đồ gọi là:", opts: ["Tỉ số độ dài", "Tỉ lệ bản đồ", "Tỉ số phần trăm", "Tỉ số xích"], c: 1},
            {q: "Tỉ lệ bản đồ thường có tử số là:", opts: ["1", "10", "100", "1000"], c: 0},
            {q: "Tỉ lệ 1:500 cho biết hình ảnh đã được:", opts: ["Phóng 500 lần", "Giữ nguyên", "Thu nhỏ 500 lần", "Thu nhỏ 1 lần"], c: 2},
            {q: "Tính độ dài thật ta lấy độ dài bản đồ:", opts: ["Chia mẫu số", "Nhân mẫu số", "Cộng mẫu số", "Trừ mẫu số"], c: 1}
        ],
        V2: [
            {q: "Tỉ số của m=13 và n=17 là:", opts: ["17/13", "13:17", "13/17", "13/30"], c: 2},
            {q: "9/25 viết dưới dạng tỉ số phần trăm là:", opts: ["9%", "36%", "25%", "45%"], c: 1},
            {q: "100 cây dừa, 92 cây có quả. Tỉ số phần trăm cây CHƯA quả là:", opts: ["8%", "92%", "100%", "18%"], c: 0},
            {q: "Tỉ lệ 1:1000, bản đồ 6cm. Độ dài thật là:", opts: ["6m", "60m", "600m", "6000m"], c: 1},
            {q: "Thực tế 160km, tỉ lệ 1:1.000.000. Bản đồ dài:", opts: ["160cm", "16cm", "1,6cm", "16mm"], c: 1},
            {q: "57% + 43,5% = ?", opts: ["100%", "10,05%", "100,5%", "90,5%"], c: 2},
            {q: "Đi được 35%, tỉ số phần trăm CÒN PHẢI ĐI là:", opts: ["35%", "135%", "65%", "75%"], c: 2},
            {q: "Tỉ lệ 1:2000, bản đồ 5cm. Độ dài thật là:", opts: ["10m", "100m", "1000m", "10km"], c: 1}
        ],
        V3: [
            {q: "Tỉ lệ 1:3000, chiều dài 3cm, chiều rộng 2cm. Tính diện tích thật ngoài đời thực (đơn vị m2)?", ans: "5400"},
            {q: "Bản đồ thứ nhất (1:1000) dài 10cm. Bản đồ thứ hai (1:2000) dài bao nhiêu cm?", ans: "5"},
            {q: "Hình vuông có chu vi trên bản đồ (1:5000) là 16cm. Tính diện tích thật (đơn vị ha)?", ans: "4"},
            {q: "Chặng 1 chiếm 30%, chặng 2 chiếm 70% và hơn chặng 1 là 40m. Tổng quãng đường (m)?", ans: "100"}
        ]
    };

    let score = 0, lives = 3, stage = 1, qIdx = 0, pool = [], startTime;

    // Hàm xáo trộn mảng để lấy ngẫu nhiên
    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        startTime = Date.now();
        initStage(1);
    }

    function initStage(s) {
        stage = s; qIdx = 0;
        const b = document.getElementById('vong-banner');
        
        // Lấy ngẫu nhiên số lượng câu hỏi theo yêu cầu
        if(s === 1) { 
            b.innerText = "VÒNG 1: KHÁM PHÁ"; 
            pool = shuffle([...DATA.V1]).slice(0, 4); // Lấy 4 từ 8
        } else if(s === 2) { 
            b.innerText = "VÒNG 2: LUYỆN TẬP"; 
            pool = shuffle([...DATA.V2]).slice(0, 4); // Lấy 4 từ 8
        } else { 
            b.innerText = "VÒNG 3: VỀ ĐÍCH"; 
            pool = shuffle([...DATA.V3]).slice(0, 2); // Lấy 2 từ 4
        }
        showQ();
    }

    function showQ() {
        let item = pool[qIdx];
        document.getElementById('cau-so').innerText = `CÂU ${qIdx+1}/${pool.length}`;
        document.getElementById('noi-dung-cau-hoi').innerText = item.q;
        const c = document.getElementById('khu-vuc-dap-an');
        c.innerHTML = '';
        
        if(stage < 3) {
            c.className = "options-container";
            item.opts.forEach((o, i) => {
                let btn = document.createElement('button');
                btn.className = "btn-opt"; btn.innerText = o;
                btn.onclick = () => check(i === item.c);
                c.appendChild(btn);
            });
        } else {
            c.className = "input-area";
            c.innerHTML = `
                <input type="number" id="ans-input" class="input-ans" placeholder="Nhập số...">
                <button class="btn-submit" onclick="checkTL()">GỬI ĐÁP ÁN</button>
            `;
            setTimeout(() => document.getElementById('ans-input').focus(), 100);
        }
    }

    function checkTL() {
        const val = document.getElementById('ans-input').value.trim();
        if(val) check(val === pool[qIdx].ans);
    }

    function check(isCorrect) {
        if(isCorrect) {
            score += 10;
            document.getElementById('diem-nhan').innerText = score;
            showToast("ĐÚNG RỒI! +10đ", "#27ae60");
            document.getElementById('sound-correct').play();
        } else {
            lives--;
            document.getElementById('mang-song').innerText = "SỐ LẦN SAI CÒN LẠI: " + "❤️".repeat(lives);
            showToast("SAI RỒI! ❌", "#e74c3c");
            document.getElementById('sound-wrong').play();
            if(lives <= 0) return finishGame("BẠN HẾT LƯỢT RỒI!");
        }
        
        qIdx++;
        if(qIdx < pool.length) {
            setTimeout(showQ, 800);
        } else {
            if(stage < 3) setTimeout(() => initStage(stage + 1), 1000);
            else setTimeout(() => finishGame("XUẤT SẮC HOÀN THÀNH!"), 1000);
        }
    }

    function showToast(msg, color) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.background = color;
        t.classList.add('show-toast');
        setTimeout(() => t.classList.remove('show-toast'), 1500);
    }

    function finishGame(title) {
        document.getElementById('ui-choi').classList.add('hidden');
        document.getElementById('ui-ket-thuc').classList.remove('hidden');
        document.getElementById('title-finish').innerText = title;
        document.getElementById('diem-cuoi').innerText = score + " / 100";
        
        const savedName = localStorage.getItem('studentName');
        if(savedName) document.getElementById('ten-hs').value = savedName;
        document.getElementById('form-dang-ky').classList.remove('hidden');
    }

    function saveResult() {
        const name = document.getElementById('ten-hs').value.trim();
        const lop = document.getElementById('lop-hs').value.trim();
        if(!name || !lop) return alert("Em nhập đầy đủ thông tin nhé!");

        const duration = Math.floor((Date.now() - startTime) / 1000);
        const ref = db.ref('scores/Tuan_19');

        ref.once('value', (snap) => {
            let attemptCount = 1;
            if(snap.exists()){
                const data = snap.val();
                attemptCount = Object.values(data).filter(i => (i.fullName || i.name) === name).length + 1;
            }

            ref.push({
                fullName: name,
                className: lop,
                score: score,
                duration: duration,
                attempt: attemptCount,
                date: new Date().toLocaleString('vi-VN')
            }, () => {
                alert(`Lưu thành công lần thi thứ ${attemptCount}!`);
                window.location.href = "index.html";
            });
        });
    }
</script>
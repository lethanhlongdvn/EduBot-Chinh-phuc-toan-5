<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√°m Hi·ªÉm Vi·ªát Nam - EduRobot</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --p: #FF9800; --s: #2196F3; --bg: #0f172a; }
        body { font-family: 'Lexend', sans-serif; background: var(--bg); color: white; margin: 0; overflow-x: hidden; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; text-align: center; }
        
        /* M√†n h√¨nh b·∫Øt ƒë·∫ßu */
        #start-screen { padding: 100px 20px; }
        .btn-start { background: var(--p); color: white; border: none; padding: 20px 50px; border-radius: 50px; font-size: 1.5rem; cursor: pointer; font-weight: bold; box-shadow: 0 0 20px rgba(255,152,0,0.5); }
        
        /* Giao di·ªán ch∆°i */
        .game-ui { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 30px; margin-top: 20px; border: 1px solid rgba(255,255,255,0.1); }
        #vong-banner { color: var(--p); font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 0.9rem; }
        .question-box { font-size: 1.4rem; margin-bottom: 30px; min-height: 80px; }
        
        /* ƒê√°p √°n */
        .options-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-opt { background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: white; padding: 15px; border-radius: 12px; cursor: pointer; font-family: 'Lexend'; transition: 0.3s; font-size: 1rem; }
        .btn-opt:hover { background: var(--s); border-color: white; }
        
        /* V√≤ng 3 - T·ª± lu·∫≠n */
        .input-area { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .input-ans { padding: 15px; border-radius: 10px; border: none; width: 200px; font-size: 1.2rem; text-align: center; }
        .btn-submit { background: var(--p); color: white; border: none; padding: 10px 30px; border-radius: 10px; cursor: pointer; font-weight: bold; }

        /* K·∫øt th√∫c */
        #ui-ket-thuc { padding: 50px 20px; }
        .final-score { font-size: 4rem; color: var(--p); margin: 20px 0; }
        .form-box { background: white; color: #333; padding: 30px; border-radius: 20px; max-width: 400px; margin: 0 auto; }
        .form-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Lexend'; }
        
        .hidden { display: none; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; border-radius: 50px; font-weight: bold; z-index: 1000; display: none; }
        .show-toast { display: block !important; animation: fadeInOut 1.5s; }
        @keyframes fadeInOut { 0% { opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="container">
    <div id="start-screen">
        <h1 style="color: var(--p); font-size: 2.5rem;">ü§ñ TH√ÅM HI·ªÇM VI·ªÜT NAM</h1>
        <p>Th·ª≠ th√°ch ki·∫øn th·ª©c v·ªÅ T·ªâ s·ªë - T·ªâ l·ªá b·∫£n ƒë·ªì - T·ªâ s·ªë ph·∫ßn trƒÉm</p>
        <button class="btn-start" onclick="startGame()">B·∫ÆT ƒê·∫¶U THI</button>
    </div>

    <div id="ui-choi" class="game-ui hidden">
        <div id="vong-banner">V√íNG 1: KH√ÅM PH√Å</div>
        <div class="status-bar">
            <span id="cau-so">C√ÇU 1/4</span>
            <span id="diem-so">ƒêI·ªÇM: <b id="diem-nhan" style="color:var(--p)">0</b></span>
            <span id="mang-song">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
        </div>
        
        <div class="question-box" id="noi-dung-cau-hoi">ƒêang t·∫£i c√¢u h·ªèi...</div>
        
        <div id="khu-vuc-dap-an">
            </div>
    </div>

    <div id="ui-ket-thuc" class="hidden">
        <h1 id="title-finish">HO√ÄN TH√ÄNH!</h1>
        <div class="final-score" id="diem-cuoi">0 / 100</div>
        
        <div class="form-box" id="form-dang-ky">
            <h3 style="margin-top:0">L∆∞u k·∫øt qu·∫£ v√†o B·∫£ng V√†ng</h3>
            <input type="text" id="ten-hs" placeholder="Nh·∫≠p h·ªç v√† t√™n...">
            <input type="text" id="lop-hs" placeholder="Nh·∫≠p l·ªõp (VD: 5/4)...">
            <button class="btn-start" style="font-size: 1.1rem; padding: 12px; width:100%" onclick="saveResult()">L∆ØU ƒêI·ªÇM</button>
        </div>
    </div>
</div>

<audio id="sound-correct" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3"></audio>
<audio id="sound-wrong" src="https://www.soundjay.com/misc/sounds/fail-trombone-01.mp3"></audio>

<script>
    // 1. C·∫§U H√åNH FIREBASE
    const firebaseConfig = { 
        databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app" 
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. NG√ÇN H√ÄNG C√ÇU H·ªéI
    const DATA = {
        V1: [
            {q: "T·ªâ s·ªë c·ªßa 7 hang ƒë√° v√† 10 r·ª´ng c√¢y l√†:", opts: ["10:7", "7:10", "7:17", "10:17"], c: 1},
            {q: "T·ªâ s·ªë a:b (b kh√°c 0) cho bi·∫øt ƒëi·ªÅu g√¨?", opts: ["a b·∫±ng a/b l·∫ßn b", "b b·∫±ng a/b l·∫ßn a", "a h∆°n b a/b ƒë∆°n v·ªã", "a k√©m b a/b ƒë∆°n v·ªã"], c: 0},
            {q: "C√≥ 43 b·∫°n th√≠ch kho b√°u trong 100 b·∫°n. T·ªâ s·ªë ph·∫ßn trƒÉm l√†:", opts: ["4,3%", "0,43%", "43%", "430%"], c: 2},
            {q: "K√Ω hi·ªáu % ƒë·ªçc l√†:", opts: ["Ph·∫ßn m∆∞·ªùi", "Ph·∫ßn trƒÉm", "Ph·∫ßn ngh√¨n", "ƒê∆°n v·ªã"], c: 1},
            {q: "T·ªâ s·ªë 1:10 000 d∆∞·ªõi b·∫£n ƒë·ªì g·ªçi l√†:", opts: ["T·ªâ s·ªë ƒë·ªô d√†i", "T·ªâ l·ªá b·∫£n ƒë·ªì", "T·ªâ s·ªë ph·∫ßn trƒÉm", "T·ªâ s·ªë x√≠ch"], c: 1},
            {q: "T·ªâ l·ªá b·∫£n ƒë·ªì th∆∞·ªùng c√≥ t·ª≠ s·ªë l√†:", opts: ["1", "10", "100", "1000"], c: 0},
            {q: "T·ªâ l·ªá 1:500 cho bi·∫øt h√¨nh ·∫£nh ƒë√£ ƒë∆∞·ª£c:", opts: ["Ph√≥ng 500 l·∫ßn", "Gi·ªØ nguy√™n", "Thu nh·ªè 500 l·∫ßn", "Thu nh·ªè 1 l·∫ßn"], c: 2},
            {q: "T√≠nh ƒë·ªô d√†i th·∫≠t ta l·∫•y ƒë·ªô d√†i b·∫£n ƒë·ªì:", opts: ["Chia m·∫´u s·ªë", "Nh√¢n m·∫´u s·ªë", "C·ªông m·∫´u s·ªë", "Tr·ª´ m·∫´u s·ªë"], c: 1}
        ],
        V2: [
            {q: "T·ªâ s·ªë c·ªßa m=13 v√† n=17 l√†:", opts: ["17/13", "13:17", "13/17", "13/30"], c: 2},
            {q: "9/25 vi·∫øt d∆∞·ªõi d·∫°ng t·ªâ s·ªë ph·∫ßn trƒÉm l√†:", opts: ["9%", "36%", "25%", "45%"], c: 1},
            {q: "100 c√¢y d·ª´a, 92 c√¢y c√≥ qu·∫£. T·ªâ s·ªë ph·∫ßn trƒÉm c√¢y CH∆ØA qu·∫£ l√†:", opts: ["8%", "92%", "100%", "18%"], c: 0},
            {q: "T·ªâ l·ªá 1:1000, b·∫£n ƒë·ªì 6cm. ƒê·ªô d√†i th·∫≠t l√†:", opts: ["6m", "60m", "600m", "6000m"], c: 1},
            {q: "Th·ª±c t·∫ø 160km, t·ªâ l·ªá 1:1.000.000. B·∫£n ƒë·ªì d√†i:", opts: ["160cm", "16cm", "1,6cm", "16mm"], c: 1},
            {q: "57% + 43,5% = ?", opts: ["100%", "10,05%", "100,5%", "90,5%"], c: 2},
            {q: "ƒêi ƒë∆∞·ª£c 35%, t·ªâ s·ªë ph·∫ßn trƒÉm C√íN PH·∫¢I ƒêI l√†:", opts: ["35%", "135%", "65%", "75%"], c: 2},
            {q: "T·ªâ l·ªá 1:2000, b·∫£n ƒë·ªì 5cm. ƒê·ªô d√†i th·∫≠t l√†:", opts: ["10m", "100m", "1000m", "10km"], c: 1}
        ],
        V3: [
            {q: "T·ªâ l·ªá 1:3000, chi·ªÅu d√†i 3cm, chi·ªÅu r·ªông 2cm. T√≠nh di·ªán t√≠ch th·∫≠t (m2)?", ans: "5400"},
            {q: "B·∫£n ƒë·ªì 1 (1:1000) d√†i 10cm. B·∫£n ƒë·ªì 2 (1:2000) d√†i bao nhi√™u cm?", ans: "5"},
            {q: "H√¨nh vu√¥ng c√≥ chu vi tr√™n b·∫£n ƒë·ªì (1:5000) l√† 16cm. T√≠nh di·ªán t√≠ch th·∫≠t (ha)?", ans: "4"},
            {q: "Ch·∫∑ng 1 chi·∫øm 30%, ch·∫∑ng 2 chi·∫øm 70% v√† h∆°n ch·∫∑ng 1 l√† 40m. T·ªïng qu√£ng ƒë∆∞·ªùng (m)?", ans: "100"}
        ]
    };

    let score = 0, lives = 3, stage = 1, qIdx = 0, pool = [], startTime;

    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('ui-choi').classList.remove('hidden');
        startTime = Date.now();
        initStage(1);
    }

    function initStage(s) {
        stage = s; qIdx = 0;
        const banner = document.getElementById('vong-banner');
        if(s === 1) { banner.innerText = "V√íNG 1: KH√ÅM PH√Å"; pool = shuffle([...DATA.V1]).slice(0, 4); }
        else if(s === 2) { banner.innerText = "V√íNG 2: LUY·ªÜN T·∫¨P"; pool = shuffle([...DATA.V2]).slice(0, 4); }
        else { banner.innerText = "V√íNG 3: V·ªÄ ƒê√çCH"; pool = shuffle([...DATA.V3]).slice(0, 2); }
        showQ();
    }

    function showQ() {
        let item = pool[qIdx];
        document.getElementById('cau-so').innerText = `C√ÇU ${qIdx+1}/${pool.length}`;
        document.getElementById('noi-dung-cau-hoi').innerText = item.q;
        const area = document.getElementById('khu-vuc-dap-an');
        area.innerHTML = '';
        
        if(stage < 3) {
            area.className = "options-container";
            item.opts.forEach((o, i) => {
                let btn = document.createElement('button');
                btn.className = "btn-opt"; btn.innerText = o;
                btn.onclick = () => check(i === item.c);
                area.appendChild(btn);
            });
        } else {
            area.className = "input-area";
            area.innerHTML = `<input type="number" id="ans-input" class="input-ans" placeholder="?">
                             <button class="btn-submit" onclick="checkTL()">G·ª¨I</button>`;
            setTimeout(() => document.getElementById('ans-input').focus(), 100);
        }
    }

    function checkTL() {
        const val = document.getElementById('ans-input').value.trim();
        if(val) check(val === pool[qIdx].ans);
    }

    function check(isCorrect) {
        if(isCorrect) {
            score += 10;
            document.getElementById('diem-nhan').innerText = score;
            showToast("CH√çNH X√ÅC! üåü", "#27ae60");
            document.getElementById('sound-correct').play().catch(()=>{});
        } else {
            lives--;
            document.getElementById('mang-song').innerText = "‚ù§Ô∏è".repeat(lives);
            showToast("SAI R·ªíI! ‚ùå", "#e74c3c");
            document.getElementById('sound-wrong').play().catch(()=>{});
            if(lives <= 0) return finishGame("C·ªê G·∫ÆNG L·∫¶N SAU NH√â!");
        }
        
        qIdx++;
        if(qIdx < pool.length) {
            setTimeout(showQ, 1000);
        } else {
            if(stage < 3) setTimeout(() => initStage(stage + 1), 1200);
            else setTimeout(() => finishGame("XU·∫§T S·∫ÆC HO√ÄN TH√ÄNH!"), 1200);
        }
    }

    function showToast(msg, color) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.background = color;
        t.classList.add('show-toast');
        setTimeout(() => t.classList.remove('show-toast'), 1500);
    }

    function finishGame(title) {
        document.getElementById('ui-choi').classList.add('hidden');
        document.getElementById('ui-ket-thuc').classList.remove('hidden');
        document.getElementById('title-finish').innerText = title;
        document.getElementById('diem-cuoi').innerText = score + " / 100";
        
        const savedName = localStorage.getItem('studentName');
        if(savedName) document.getElementById('ten-hs').value = savedName;
    }

    function saveResult() {
        const name = document.getElementById('ten-hs').value.trim();
        const lop = document.getElementById('lop-hs').value.trim();
        if(!name || !lop) return alert("Nh·∫≠p ƒë·ªß t√™n v√† l·ªõp nh√©!");

        localStorage.setItem('studentName', name);
        const duration = Math.floor((Date.now() - startTime) / 1000);
        const ref = db.ref('scores/Tuan_19');

        ref.once('value', (snap) => {
            let attemptCount = 1;
            if(snap.exists()){
                const data = snap.val();
                attemptCount = Object.values(data).filter(i => (i.fullName || i.name) === name).length + 1;
            }

            ref.push({
                fullName: name,
                className: lop,
                score: score,
                duration: duration,
                attempt: attemptCount,
                date: new Date().toLocaleString('vi-VN')
            }, () => {
                alert(`L∆∞u th√†nh c√¥ng l·∫ßn thi th·ª© ${attemptCount}!`);
                window.location.href = "index.html";
            });
        });
    }
</script>
</body>
</html>